
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mantle: Encrypted JSON for the Marathon API - Technoblogic(.io)</title>
  <meta name="author" content="Jeff Malnick">

  
  <meta name="description" content="Mantle is a go utility that wraps the POST process to Mesosphere&rsquo;s Marathon API. Before, users had to store JSON with cleartext environment &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://technoblogic.io/blog/2015/09/05/mantle-encrypted-json-for-the-marathon-api/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Technoblogic(.io)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Technoblogic(.io)</a></h1>
  
    <h2>Shameful Self Promotion</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="technoblogic.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">All Posts</a></li>
  <li><a href="/blog/resume">Resume</a></li>
  <li><a href="/blog/talks">Talks/Public Venues</a></li>
  <li><a href="https://github.com/malnick">Github</a></li>
  <li><a href="https://www.flickr.com/photos/129457394@N03/">Flickr</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Mantle: Encrypted JSON for the Marathon API</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-05T13:00:32-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:00 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img style="float: center;" src="https://dl.dropboxusercontent.com/u/77193293/mantle.png"></p>

<p><a href="https://github.com/malnick/mantle.git">Mantle</a> is a go utility that wraps the POST process to Mesosphere&rsquo;s Marathon API. Before, users had to store JSON with cleartext environment variables for their Docker container configuration. With Mantle, users can encrypt the values for the &ldquo;env&rdquo; parameters passed to Marathon using asynchronous public/private key pairs. Mantle is designed to allow operations or deployment teams to build user-level key pairs, and give those public keys to the users' with the most knowledge of the application&rsquo;s configuration. Those users, can then encode the JSON with Mantle via their public keys and let the deployment team review the JSON and have the final private key to decrypt and deploy to Marathon(s) via Mantle.</p>

<!-- more -->


<h3>Example Use Case</h3>

<p>Create private/public keys and eyaml data from cleartext in JSON for Marathon:</p>

<ol>
<li><p><code>mantle -generate</code>: Generates keys for $user defined in config.yaml. User can be overridden with -u. Keys are stored i  n $key_directory specified in config.yaml.</p></li>
<li><p><code>vi marathon_data.json</code>:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "container": {
</span><span class='line'>    "type": "DOCKER",
</span><span class='line'>    "docker": {
</span><span class='line'>      "image": "some_repo/some_container_image",
</span><span class='line'>      "network": "BRIDGE",
</span><span class='line'>      "portMappings": [
</span><span class='line'>        { "containerPort": 5050, "hostPort": 0, "protocol": "tcp" }
</span><span class='line'>      ]
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "id": "my-service",
</span><span class='line'>  "env": {
</span><span class='line'>    "MY_LICENSE_KEY": "ENC[my_license_key:12345]",
</span><span class='line'>    "MONGO_PASSWORD": "ENC[qa_mongo_pw:$ecretp@$$word]",
</span><span class='line'>    "JEFFS_SECRET": "ENC[production_secret:13adfafd%^$^$&DFS]",
</span><span class='line'>    "SAFE_DATA": "This is safe"
</span><span class='line'>  },
</span><span class='line'>  "instances": 1,
</span><span class='line'>  "cpus": 0.5,
</span><span class='line'>  "mem": 1024,
</span><span class='line'>  "upgradeStrategy": {
</span><span class='line'>    "minimumHealthCapacity": 0.8,
</span><span class='line'>    "maximumOverCapacity": 0.4
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Add as many <code>ENC[eyaml_key:cleartext_value]</code> as you need.</p>

<ol>
<li><code>mantle -encode marathon_data.json</code>: Encodes the cleartext values in each ENC[] statement with the user&rsquo;s public key.</li>
</ol>


<p>Adds those key/values to the eyaml file, and saves the eyaml file to <code>$eyaml_directory/$user.yaml</code> as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>my_license_key: !!binary |
</span><span class='line'>  iFpLHn3wsr6/ZpoolepdT7uhp6hRq/2Tr+LyJXOpJAxkulMsb1pxE8GjKlR9iTTIV9IYnU
</span><span class='line'>  JeIibAaDqfq0SZF8i8xjN6Tx6Ytx3d8BBu2pCT3nDuqpGEDqnZUZDkjp6eRScAtbsPzB8m
</span><span class='line'>  taVfEO9j7zEpU/pWTr9x/awsK8gGp/E=
</span><span class='line'>prod_caleb_secret: !!binary |
</span><span class='line'>  IGpl8fRKGol+XHnCIsha0fTVIsTiq1sdbZ/l0PplAzBdPN+vmjn5Cg7fBeHKoT+7+RCyId
</span><span class='line'>  Yu+7O/gUK1R5zGHJgXA9BV9I3Fh+/dCb3W+c3NFFQNfivHxoad8ggZIX1xk/EyJQAJHTRD
</span><span class='line'>  WypeeyIswps1o5cv1DXj2rJbjBJ33hA=
</span><span class='line'>production_secret: !!binary |
</span><span class='line'>  Sc2D2DlrXf+rsZ6Yovr2/0AE5ZhwfRgKuHax3c3zxDIRvpCcfjqGvbXQUOpE/NwUAu/hNt
</span><span class='line'>  km1vHJ3CgQIwr1Y8SD3WVQ1O2KO87bhcQHmB4HTFsLCtW6m0KsqI5okCSUnsR+yAhKYfqt
</span><span class='line'>  2MBjh38IN3JQz3PbA2psfhrzAg8rt7M=
</span><span class='line'>qa_mongo_pw: !!binary |
</span><span class='line'>  sOOZCr1RsNQT56UZJVxqi39oSC6r5qazGsRncnHP4rdRIAELwW1qME+bBMqhlUh4enqYkM
</span><span class='line'>  vIk6ebR5Oxt+luxAJR5yCfP4Ol7OZjCHIwOCnW5l50ekOuBnJWxhUEQMZe+4DMsK9G+ml0
</span><span class='line'>  /W1mX71ogSK7Kxcn32Ttb2vK9jDfY/k=
</span><span class='line'>user: some_user</span></code></pre></td></tr></table></div></figure>


<p> new &ldquo;safe&rdquo; JSON is saved to <code>$safe_dir/marathon_data.json</code> as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>        "container": {
</span><span class='line'>                "docker": {
</span><span class='line'>                        "image": "some_repo/some_container_image",
</span><span class='line'>                        "network": "BRIDGE",
</span><span class='line'>                        "portMappings": [
</span><span class='line'>                                {
</span><span class='line'>                                        "containerPort": 5050,
</span><span class='line'>                                        "hostPort": 0,
</span><span class='line'>                                        "protocol": "tcp"
</span><span class='line'>                                }
</span><span class='line'>                        ]
</span><span class='line'>                },
</span><span class='line'>                "type": "DOCKER"
</span><span class='line'>        },
</span><span class='line'>        "cpus": 0.5,
</span><span class='line'>        "env": {
</span><span class='line'>                "JEFFS_SECRET": "DEC[production_secret]",
</span><span class='line'>                "MONGO_PASSWORD": "DEC[qa_mongo_pw]",
</span><span class='line'>                "MY_LICENSE_KEY": "DEC[my_license_key]",
</span><span class='line'>                "SAFE_DATA": "This is safe"
</span><span class='line'>        },
</span><span class='line'>        "id": "my-service",
</span><span class='line'>        "instances": 1,
</span><span class='line'>        "mem": 1024,
</span><span class='line'>        "upgradeStrategy": {
</span><span class='line'>                "maximumOverCapacity": 0.4,
</span><span class='line'>                "minimumHealthCapacity": 0.8
</span><span class='line'>        }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>mantle -deploy ~/.mantle/safe/marathon_data.json</code>: Deploys the &ldquo;safe&rdquo; JSON data, first decrypting the DEC[] statement  s, then POSTing that decrypted JSON to each specified Marathon in your config.yaml.</li>
</ol>


<p>The final POST from our example, with decrypted data:
The final POST from our example, with decrypted data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>        "container": {
</span><span class='line'>                "docker": {
</span><span class='line'>                        "image": "some_repo/some_container_image",
</span><span class='line'>                        "network": "BRIDGE",
</span><span class='line'>                        "portMappings": [
</span><span class='line'>                                {
</span><span class='line'>                                        "containerPort": 5050,
</span><span class='line'>                                        "hostPort": 0,
</span><span class='line'>                                        "protocol": "tcp"
</span><span class='line'>                                }
</span><span class='line'>                        ]
</span><span class='line'>                },
</span><span class='line'>                "type": "DOCKER"
</span><span class='line'>        },
</span><span class='line'>        "cpus": 0.5,
</span><span class='line'>        "env": {
</span><span class='line'>                "JEFFS_SECRET": "13adfafd%^$^$\u0026DFS",
</span><span class='line'>                "MONGO_PASSWORD": "$ecretp@$$word",
</span><span class='line'>                "MY_LICENSE_KEY": "12345",
</span><span class='line'>                "SAFE_DATA": "This is safe"
</span><span class='line'>        },
</span><span class='line'>        "id": "my-service",
</span><span class='line'>        "instances": 1,
</span><span class='line'>        "mem": 1024,
</span><span class='line'>        "upgradeStrategy": {
</span><span class='line'>                "maximumOverCapacity": 0.4,
</span><span class='line'>                "minimumHealthCapacity": 0.8
</span><span class='line'>        }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Generate key-pairs for Developers</h3>

<p>Mantle was developed with the DevOps process in mind. However, it&rsquo;s unlikely that you&rsquo;ll want to give everyone the deployment keys. Mantle allows you to create a key-pair for any user, and give that user only the public key so they can encrypt the JSON. This leaves the ability to deploy in the hands of the deployment or operations team since they have the users' associated private key and can decrypt the JSON.</p>

<ol>
<li><code>mantle -generate -u sally</code>: Mantle will generate pub/private keypair and deposit them in <code>key_dir</code> specified in config.yaml.</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO[0000] Generating PKCS keys...
</span><span class='line'>INFO[0000] Private Key: /Users/malnick/.mantle/keys/privatekey_sally.pem
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>MIICXAIBAAKBgQDZ8lDifZdR+xcBZG99t541Vt3WFMOiER/qclIWtjQjtkCt8/ij
</span><span class='line'>dsp/Yn7DHJ3oYB58CbXvXWb9ONMB8Tr1vhCQZVXtJTN2sloUlD7SYne/GrxAJZjT
</span><span class='line'>8vTYoa3ZvvTpWXXYwGiPY8TmnCNqqC0ApqI4o67ZcWIx5FPWgqWu+SHBcQIDAQAB
</span><span class='line'>AoGAB6Rhha+VsMA3LEtTRXs8xu4G1UzhFzu2fMgJbNZyuZXYasEVRNYTf6f6fejw
</span><span class='line'>+Ib2Sq8kfAIwbEyjyXul75v8hKMYBFB8GBxvXuhJuLM1/EWwXtEvHW6p0Km0MZME
</span><span class='line'>eob3kzg4DLe9RxpnCZOYEMhRz9VBbYCcs5G3RcSoXY/2woECQQDvHIhoaln5o7HG
</span><span class='line'>8TZFgZRJ6z/n4H6jfgx08+xKl8llMIwQMGEyftiHmB1ULBxlAM3yYOOxtzHmwj6I
</span><span class='line'>LDkVskSZAkEA6VcXl4g11tk3ZL0fr30+PFvAH6Y3s88aNYr/JNFBb7Edeijs71Mb
</span><span class='line'>Qt8T/2DgpgxYTctQM7mvSh52V9BUNWQSmQJAQBBd/9PWzYrtO8cu6kqAh5mPIrpE
</span><span class='line'>U9uWzNL50TZ/0CvEqyW7NQNFUncQDJhQ90LS6wjImLnjldcfV+65ULXVqQJAFKaI
</span><span class='line'>h/ieCy2eIWQ7caR75YuZLTPgqiEiCKsMeY2rZN8f5LfKgEOynfBwLKG+P/PHvNrJ
</span><span class='line'>dkpwoPahMpRVX4RDwQJBANh7Pp60KVpWrpcCGOPxCCaPAfgY7Hht4BYexBO2HBr1
</span><span class='line'>bjsDYTotBmMx8HExMNf9vQXJkM135kuZ+fevLOcwiV8=
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span><span class='line'>
</span><span class='line'>INFO[0000] Public Key: /Users/malnick/.mantle/keys/publickey_sally.pem
</span><span class='line'>-----BEGIN RSA PUBLIC KEY-----
</span><span class='line'>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZ8lDifZdR+xcBZG99t541Vt3W
</span><span class='line'>FMOiER/qclIWtjQjtkCt8/ijdsp/Yn7DHJ3oYB58CbXvXWb9ONMB8Tr1vhCQZVXt
</span><span class='line'>JTN2sloUlD7SYne/GrxAJZjT8vTYoa3ZvvTpWXXYwGiPY8TmnCNqqC0ApqI4o67Z
</span><span class='line'>cWIx5FPWgqWu+SHBcQIDAQAB
</span><span class='line'>-----END RSA PUBLIC KEY-----</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Hand out the public key (<code>~/.mantle/keys/publickey_sally.pem</code>) to Sally, and keep the private key locally. Ensure Sally places the key in her <code>key_directory</code> specified in config.yaml.</p></li>
<li><p>Have Sally write her JSON with <code>ENC[$eyaml_key:$cleartext_value]</code> statements.</p></li>
</ol>


<p><code>vi sallys/local/machine/sallys_container.json</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "container": {
</span><span class='line'>    "type": "DOCKER",
</span><span class='line'>    "docker": {
</span><span class='line'>      "image": "sallys_org/sallys_container",
</span><span class='line'>      "network": "BRIDGE",
</span><span class='line'>      "portMappings": [
</span><span class='line'>        { "containerPort": 5050, "hostPort": 0, "protocol": "tcp" }
</span><span class='line'>      ]
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "id": "my-service",
</span><span class='line'>  "env": {
</span><span class='line'>    "SALLYS_SECRET": "ENC[sallys_qa_secret:superawesomesauce]",
</span><span class='line'>    "MONGO_PASSWORD":"ENC[qa_mongo_password:mongoiswebscale]",
</span><span class='line'>    "NEWRELIC_API_KEY":"ENC[newrelic_api_key:7638263546473822299283737]"
</span><span class='line'>  },
</span><span class='line'>  "instances": 1,
</span><span class='line'>  "cpus": 0.5,
</span><span class='line'>  "mem": 1024,
</span><span class='line'>  "upgradeStrategy": {
</span><span class='line'>    "minimumHealthCapacity": 0.8,
</span><span class='line'>    "maximumOverCapacity": 0.4
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p><code>git clone git@github.com:sallys_org/eyaml sallys/local/machine/sallys_local_eyaml_checkout</code>: Have Sally pull down the company eyaml directory, and then have her update the <code>eyaml_dir</code> in Mantle&rsquo;s config.yaml.</p></li>
<li><p><code>git clone git@github.com:sallys_org/safe_json sallys/local/machine/sallys_local_safe_checkout</code>: Have Sally pull down the company safe json directory, and then have her update the <code>safe_dir</code> in Mantle&rsquo;s config.yaml.</p></li>
<li><p><code>mantle -encode sallys/local/machine/sallys_container.json</code>: Sally can then encode the JSON. Mantle will save the JSON and user-level eyaml in the git repo&rsquo;s she just checked out:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO[0000] Encoding sallys_container.json
</span><span class='line'>WARN[0000] /Users/malnick/.mantle/eyaml/sally.yaml does not exist, creating.
</span><span class='line'>INFO[0000] eyaml saved: /Users/malnick/.mantle/eyaml/sally.yaml
</span><span class='line'>INFO[0000] Safe JSON:
</span><span class='line'>{
</span><span class='line'>        "container": {
</span><span class='line'>                "docker": {
</span><span class='line'>                        "image": "sallys_org/sallys_container",
</span><span class='line'>                        "network": "BRIDGE",
</span><span class='line'>                        "portMappings": [
</span><span class='line'>                                {
</span><span class='line'>                                        "containerPort": 5050,
</span><span class='line'>                                        "hostPort": 0,
</span><span class='line'>                                        "protocol": "tcp"
</span><span class='line'>                                }
</span><span class='line'>                        ]
</span><span class='line'>                },
</span><span class='line'>                "type": "DOCKER"
</span><span class='line'>        },
</span><span class='line'>        "cpus": 0.5,
</span><span class='line'>        "env": {
</span><span class='line'>                "MONGO_PASSWORD": "DEC[qa_mongo_password]",
</span><span class='line'>                "NEWRELIC_API_KEY": "DEC[newrelic_api_key]",
</span><span class='line'>                "SALLYS_SECRET": "DEC[sallys_qa_secret]"
</span><span class='line'>        },
</span><span class='line'>        "id": "my-service",
</span><span class='line'>        "instances": 1,
</span><span class='line'>        "mem": 1024,
</span><span class='line'>        "upgradeStrategy": {
</span><span class='line'>                "maximumOverCapacity": 0.4,
</span><span class='line'>                "minimumHealthCapacity": 0.8
</span><span class='line'>        }
</span><span class='line'>}
</span><span class='line'>INFO[0000] Saving safe JSON for decode: /Users/malnick/.mantle/safe/sallys_container.json</span></code></pre></td></tr></table></div></figure>


<p>Notice the WARN statement. Since Mantle did not find a <code>eyaml_dir/$user.yaml</code> it created a new one for her.</p>

<p>The eyaml looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>newrelic_api_key: !!binary |
</span><span class='line'>  N4JpKRvQoRBusI7Yp7BN1L/wTdexGH3NFidxvTM0P3IeGM8OnU9TfGI19j+qDQt/XVOQln
</span><span class='line'>  q2h6U/2BlHanQksytxjmuIAX5pVh1IqPFHxp0vkuU8lNffL7Z8VzPEurX4aPEyckQe5Y+E
</span><span class='line'>  OnglwxdWreQnmMuo2Vyu9bhAF+HVWwc=
</span><span class='line'>qa_mongo_password: !!binary |
</span><span class='line'>  UZ1M9L2c/N0AeDlILcP44ACd+niZeaw/BDt1oh78aNf818iTDXAl1c3deUohR12fwEMyCZ
</span><span class='line'>  FHFhErN8u4do97iGeN8QCRdECULj/KOalPG+N70jTxzW9WIpReuPFlCqCrrT+nu/9v2CjO
</span><span class='line'>  1IX5zbxN8UThL9ba2LW25QS1jPEPkMc=
</span><span class='line'>sallys_qa_secret: !!binary |
</span><span class='line'>  UkbR2x+FftMr0O4K13iG/msEDpI8bi7+Mz2NIFxiRmXdwziQtUMYVrvJkpq3hgavGC2DBl
</span><span class='line'>  C0gfmdAa6LfX4zS1lXFHIZD0tpY4dDdqWPFuwRPqVKLLNwiDX46olAEu104iOp6wsRPiJV
</span><span class='line'>  pa92d0uUC4X67BmPF/6LueIVXUTEBYY=
</span><span class='line'>user: sally
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Sally then pushes both eyaml and safe repo&rsquo;s back to git.</p></li>
<li><p>Now the safe JSON and eyaml repo&rsquo;s can be pulled by the operations team. At this point, a review of the Safe JSON can be made to ensure everything looks right. Finally, we can deploy the safe JSON via Mantle to Marathon with the key for Sally:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user@localhost: mantle -deploy ~/.mantle/safe/sallys_container.json -u sally
</span><span class='line'>
</span><span class='line'>INFO[0000] Deploying ~/.mantle/safe/sallys_container.json
</span><span class='line'>INFO[0000] Decrypted qa_mongo_password to mongoiswebscale
</span><span class='line'>INFO[0000] Decrypted newrelic_api_key to 7638263546473822299283737
</span><span class='line'>INFO[0000] Decrypted sallys_qa_secret to superawesomesauce
</span><span class='line'>INFO[0000] Decoded JSON:
</span><span class='line'>{
</span><span class='line'>        "container": {
</span><span class='line'>                "docker": {
</span><span class='line'>                        "image": "sallys_org/sallys_container",
</span><span class='line'>                        "network": "BRIDGE",
</span><span class='line'>                        "portMappings": [
</span><span class='line'>                                {
</span><span class='line'>                                        "containerPort": 5050,
</span><span class='line'>                                        "hostPort": 0,
</span><span class='line'>                                        "protocol": "tcp"
</span><span class='line'>                                }
</span><span class='line'>                        ]
</span><span class='line'>                },
</span><span class='line'>                "type": "DOCKER"
</span><span class='line'>        },
</span><span class='line'>        "cpus": 0.5,
</span><span class='line'>        "env": {
</span><span class='line'>                "MONGO_PASSWORD": "mongoiswebscale",
</span><span class='line'>                "NEWRELIC_API_KEY": "7638263546473822299283737",
</span><span class='line'>                "SALLYS_SECRET": "superawesomesauce"
</span><span class='line'>        },
</span><span class='line'>        "id": "my-service",
</span><span class='line'>        "instances": 1,
</span><span class='line'>        "mem": 1024,
</span><span class='line'>        "upgradeStrategy": {
</span><span class='line'>                "maximumOverCapacity": 0.4,
</span><span class='line'>                "minimumHealthCapacity": 0.8
</span><span class='line'>        }
</span><span class='line'>}
</span><span class='line'>INFO[0000] POSTing to http://my.marathon1.com
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>[Check out the git repo here)[<a href="https://github.com/malnick/mantle.git">https://github.com/malnick/mantle.git</a>]</h4>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jeff Malnick</span></span>

      




<time class='entry-date' datetime='2015-09-05T13:00:32-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:00 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://technoblogic.io/blog/2015/09/05/mantle-encrypted-json-for-the-marathon-api/" data-via="jmalnick" data-counturl="http://technoblogic.io/blog/2015/09/05/mantle-encrypted-json-for-the-marathon-api/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/28/elasticsearch-logstash-cli-utility/" title="Previous Post: Logasaurus: A CLI Utility for Elasticsearch / Logstash">&laquo; Logasaurus: A CLI Utility for Elasticsearch / Logstash</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/01/17/automated-installs-over-ssh-lessons-learned/" title="Next Post: How to deploy highly scalable systems over SSH">How to deploy highly scalable systems over SSH &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/19/day2-logging/">DC/OS Day 2 Operations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/containerization-in-devops-talk/">Containerization in DevOps Talk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/10/monitoring-dc-slash-os-with-nagios/">Monitoring DC/OS With Nagios</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/25/dc-scale-application-health-monitoring/">DC/OS System Health Monitoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/24/the-data-center-operating-system-installer-part-1/">Building an Installer for the Data Center Operating System</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/malnick">@malnick</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'malnick',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

Included file 'asides/twitter.html' not found in _includes directory
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jeff Malnick -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
    var stickyNavTop = $('nav').offset().top;  
      
    var stickyNav = function(){  
      var scrollTop = $(window).scrollTop(); 
      var navHasClassSticky = $('nav').hasClass('sticky');

      if (scrollTop > stickyNavTop && navHasClassSticky) {   
        return true;
      } else if (scrollTop > stickyNavTop) {
        $('nav').hide();
        $('nav').addClass('sticky');
        $('nav').fadeIn('2000');
      } else {  
        $('nav').removeClass('sticky');   
      }  
    };  
      
    stickyNav();  
      
    $(window).scroll(function() {  
      stickyNav();  
    });  
  });  
</script>


</body>
</html>
