
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Streamlining Puppet Dev Part Duce: Branch the Enviro - Technoblogic</title>
  <meta name="author" content="Jeff Malnick">

  
  <meta name="description" content="Most companies don&rsquo;t have a single monolithic application, today most applications evolve out of lots of atomic services: thus, service &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://technoblogic.io/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Technoblogic" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Technoblogic</a></h1>
  
    <h2>A Technology Blog.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="technoblogic.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">All Posts</a></li>
  <li><a href="/blog/resume">Resume</a></li>
  <li><a href="/blog/talks">Talks/Public Venues</a></li>
  <li><a href="https://github.com/malnick">Github</a></li>
  <li><a href="https://www.flickr.com/photos/129457394@N03/">Flickr</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Streamlining Puppet Dev Part Duce: Branch the Enviro</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-07T14:31:39-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:31 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Most companies don&rsquo;t have a single monolithic application, today most applications evolve out of lots of atomic services: thus, service oriented architecture.</p>

<p>What this means for your development environment is that you end up having many different applications, which is many cases are atomic services and in other cases are a conglomeration of services. Either way, you end up with a need for many dev environments.</p>

<p>At Connect Solutions we have several environments that require infrastructure development. The main ones are our custom load balancer (we call it MTLB), our Connect Cluster, CQ, and our Connect Experience applications.</p>

<p>In order to streamline our dev process with Puppet we created a repo called &lsquo;puppet-dev-enviro&rsquo; that deploys VM&rsquo;s with Vagrant and manages what modules you want to test via Rake &amp; r10k.</p>

<p>For any given envio we like to mirror what it looks like in prod as best we can. Therefore, any enviro always uses the version of puppet we run in prod on a separate Puppet Master, then the nodes that make of the rest of the enviro.</p>

<p>A simple example, theMTLB enviro deploys a Puppet Master and an MTLB load balancer node.</p>

<h2>Enviro Management</h2>

<p>Since we have so many enviros we branch the &lsquo;puppet-dev-enviro&rsquo; repo for each one. So if you&rsquo;re testing MTLB code the workflow looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">enviro</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="n">mtlb</span>
</span><span class='line'><span class="no">MONO</span><span class="o">=</span><span class="kp">true</span> <span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those first two commands are pretty straight forward. However, the deploy command probably needs some explanation. I wrote this task to streamline our development pipeline. It&rsquo;s main functionality is to read from a subdirectory called puppet and a file called the Puppetfile.</p>

<p>You might be familiar with the Puppetfile concept if you&rsquo;ve used Puppet Librarian or r10k. In this task, I actually invoke r10k locally on the Puppetfile to pull down all the modules listed in it to puppet/modules. In the case of Connect Solutions, we&rsquo;re currently in the process of moving our legacy puppet module structure from a monolithic one to their own atomic repos. This isn&rsquo;t complete yet, so the MONO=true env variable envokes a subcommand in deploy to rip out all the sub-modules of this monolithic repo and place them in puppet/modules.</p>

<p>&lsquo;Deploy&rsquo; also supports hiera data management by checking for our <code>puppet-configuration</code> repo in the puppet/modules directory. If it&rsquo;s listed in the Puppetfile this repo will be present here. If so, it moves all the data from puppet-configuration into puppet/data.</p>

<p>Both <code>puppet/modueles</code> and <code>puppet/data</code> are shared with the puppet master VM deploed with Vagrant. As a Vagrant post-provisioning step I blow away the <code>/etc/puppetlabs/puppet/modules</code>, <code>/etc/puppetlabs/puppet/data</code> directories and sym link the shared modules and data directories out of <code>/tmp</code>.</p>

<h4>The Deploy Task</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="c1"># Check directory structure:</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/modules...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/modules not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/data...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/data not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Detected puppet data repo, copying contents to </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up --provider virtualbox&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This structure allows us to play around with the module code on the fly from the host VM, with our own dotfiles and local editing or preferred pipelines. For example, I am a heavy Vim user, however, a lot of my colleagues are Sublime text users. You can choose what method best suites you and not be beholden to who provisioned the VM .box file beforehand.</p>

<p>For large code-base changes, i.e., developing an entireley new topic branch, this pipeline allows seamless integration with git and enables better version control management. An example workflow would be:</p>

<ol>
<li>Open two screen or tmux sessions</li>
<li>In one session cd into <code>/path/to/monolithic/puppet-modules/test-mod/manifests</code></li>
<li>In the other session cd into <code>/path/to/puppet-dev-enviro</code></li>
<li>In <code>puppet-dev-enviro</code>:

<ol>
<li>git checkout my-enviro</li>
<li>update <code>puppet/Puppetfile</code> and <code>`puppet/manifests/site.pp</code></li>
</ol>
</li>
</ol>


<p>puppet/Puppetfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s1">&#39;puppet-modules&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="ss">:connectsolutions</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">modules</span><span class="s1">&#39;, :ref =&gt; &#39;</span><span class="n">my</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">branch</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&#39;</span><span class="n">puppet</span><span class="o">-</span><span class="n">configuration</span><span class="s1">&#39;, :git =&gt; git@github.com:connectsolutions/puppet-configuration&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>puppet/manifests/site.pp:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span> <span class="err">&#39;</span><span class="n">my</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">dev</span><span class="sb">` {</span>
</span><span class='line'><span class="sb"> include my::class</span>
</span><span class='line'><span class="sb">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>DEPLOY: In <code>puppet-dev-enviro</code> run <code>MONO=true rake deploy</code></p>

<p>This will now pull down and configure the environment for the VM&rsquo;s. When finished, all the puppet data and modules will be live on the master VM.</p>

<h3>Enviro-Specific Vagrantfile</h3>

<p>One step I&rsquo;ve skipped here however is making a git-branch for my-enviro. That&rsquo;s a completely different step but mainly involves updateing the Vagrantfile with the neccessary VM information. I won&rsquo;t cover that here since that is specific to every enviro the same way Puppet code is speciic to each module. I will however share what stays the same between most Vagrantfiles in each enviro and that is the Master VM configuration block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntuamd64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloud-images.ubuntu.com/vagrant/precise/current/precise-server-cloudimg-amd64-vagrant-disk1.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.3.0&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span>  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.28.126.141&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.dev&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/data&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/data&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/filestore&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/filestore&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/puppet&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/data &amp;&amp; ln -s /tmp/data/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/filestore/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm /etc/puppetlabs/puppet/hiera.yaml &amp;&amp; ln -s /tmp/puppet/hiera.yaml /etc/puppetlabs/puppet/hiera.yaml&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/puppet/fileserver.conf /etc/puppetlabs/puppet/fileserver.conf&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code Test -> Develop Pipeline</h3>

<p>Once the VM&rsquo;s are up and running you can ssh into the VM under test and run <code>puppet agent -t</code>. If everything went as planned the agent will get a catlog from the master and start configuring itself. If you&rsquo;re like me, it didn&rsquo;t work on the first try. Now we need to update our code-base.</p>

<p>In the screen or tmux session that is CD'ed to your <code>puppet-modules</code> directory go into the manifests dir of the code in question. Edit that code or make whatever changes are needed for further testing.</p>

<p>Keep in mind we are working on our <code>my-topic-branch</code> branch of the <code>puppet-modules</code> repo. So when we&rsquo;re done making the local changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add my-class.pp
</span><span class='line'>git commit -m <span class="s2">&quot;I made changes&quot;</span>
</span><span class='line'>git push origin my-topic-branch
</span></code></pre></td></tr></table></div></figure>


<p>Then in the other screen window that&rsquo;s in the <code>puppet-dev-enviro</code> directory run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MONO</span><span class="o">=</span><span class="nb">true </span>rake pull
</span></code></pre></td></tr></table></div></figure>


<p>This runs only r10k and the workflow neccessary to pull down the new Puppet code. It is a heavy operation if you have a LOT of code in that Puppetfile. We haven&rsquo;t ran into an issue with that yet however for our individual test enviros. The :pull task looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;This will blow away everything in puppet/modules. Are you sure you want to continue? [y/n]&quot;</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>      <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>      <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">puts</span> <span class="s2">&quot;Exiting...&quot;</span>
</span><span class='line'>      <span class="nb">exit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you have new code in your master VM, run <code>puppet agent -t</code> again on your agent.</p>

<h3>Wait a minute!</h3>

<p>Some will say, &ldquo;This is more work than before. Now I have this extra git step!&rdquo;. Yup, that&rsquo;s right, you&rsquo;re forced to commit your changes to your own topic branch before you test on your local machine. Yes, this isn&rsquo;t good for doing work on the airplane. Granted, this test enviro as it currently stands isn&rsquo;t designed for the latter, it&rsquo;s designed towards <strong><em>seamless collaboration</em></strong>.</p>

<p>What do I mean by that? I mean, I don&rsquo;t want to have the conversation with a colleage at 4PM on a Thursday night that goes like this: &ldquo;Hey, I need to collaborate on your code. Can you push it to a topic branch in git for me?&rdquo; &ldquo;Sure, I&rsquo;ll do that as soon as I get home tonight after picking up the kids and making dinner.&rdquo; &ldquo;Great!&rdquo; &hellip; The following day: &ldquo;So hey, I REALLY wanted to test out that code we need in prod by this afternoon last night, but I never saw a push for your branch.&rdquo; &ldquo;Yeah, sorry, I got caught up in stuff. You know, life!&rdquo;.</p>

<p>That &lsquo;extra&rsquo; git step ensures all the development steps are being tracked, and anyone at anytime can spin up this environmnet with the exact same Puppetfile and site.pp configuration and get similar testing results.</p>

<p>Some day, I&rsquo;ll put together a local-only development environment but for now this is not the purpose of what we&rsquo;ve created here.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jeff Malnick</span></span>

      




<time class='entry-date' datetime='2014-10-07T14:31:39-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:31 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://technoblogic.io/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/" data-via="jmalnick" data-counturl="http://technoblogic.io/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/31/arbitrary-commandline-functions-for-mco/" title="Previous Post: Arbitrary Commandline Functions for MCO">&laquo; Arbitrary Commandline Functions for MCO</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/10/29/the-proxy-module/" title="Next Post: The Proxy Module">The Proxy Module &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/12/post-devops-clusterops/">ClusterOps Is Post-DevOps</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/20/dc-slash-os-debugging-day-2-operations-part-3/">DC/OS Debugging (Day 2 Operations, Part 3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/20/dc-slash-os-metrics-gathering-day-2-operations-part-2/">DC/OS Metrics Gathering (Day 2 Operations, Part 2)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/19/dc-slash-os-day-2-operations/">DC/OS Logging API (Day 2 Operations Part 1)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/containerization-in-devops-talk/">Containerization in DevOps Talk</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/malnick">@malnick</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'malnick',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

Included file 'asides/twitter.html' not found in _includes directory
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jeff Malnick -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
    var stickyNavTop = $('nav').offset().top;  
      
    var stickyNav = function(){  
      var scrollTop = $(window).scrollTop(); 
      var navHasClassSticky = $('nav').hasClass('sticky');

      if (scrollTop > stickyNavTop && navHasClassSticky) {   
        return true;
      } else if (scrollTop > stickyNavTop) {
        $('nav').hide();
        $('nav').addClass('sticky');
        $('nav').fadeIn('2000');
      } else {  
        $('nav').removeClass('sticky');   
      }  
    };  
      
    stickyNav();  
      
    $(window).scroll(function() {  
      stickyNav();  
    });  
  });  
</script>


</body>
</html>
