
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploying .box Files From VirtualBox for Vagrant - Technoblogic(.io)</title>
  <meta name="author" content="Jeff Malnick">

  
  <meta name="description" content="There are several tools available that streamline the production of the .box format for Vagrant from any open virtualization format (OVF). Packer &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://technoblogic.io/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Technoblogic(.io)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Technoblogic(.io)</a></h1>
  
    <h2>Shameful Self Promotion</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="technoblogic.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">All Posts</a></li>
  <li><a href="/blog/resume">Resume</a></li>
  <li><a href="/blog/talks">Talks/Public Venues</a></li>
  <li><a href="https://github.com/malnick">Github</a></li>
  <li><a href="https://www.flickr.com/photos/129457394@N03/">Flickr</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploying .box Files From VirtualBox for Vagrant</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-08-03T17:22:54-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>5:22 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>There are several tools available that streamline the production of the .box format for Vagrant from any open virtualization format (OVF).</p>

<ol>
<li><a href="www.packer.io">Packer</a>
Enables you to boot a given image from an easy to build template. You can provision the machine using many types of configuration management tools such as Puppet and Chef, and run post-installer scritps for anything else.</li>
</ol>


<p>The Templates are easy to use and you can push out a .box file from Packer directly.</p>

<ol>
<li><a href="https://github.com/jedi4ever/veewee">Veewee</a>
Easily converts an ISO to VM formats. Kinda like Packer but not, so Packer made <a href="http://www.packer.io/docs/templates/veewee-to-packer.html">this</a> tool to solve that problem.</li>
</ol>


<h2>My own tool</h2>

<p>Jeff, why would you ever build your own tool when so many others exist? Because I hate troubleshooting other peoples tools. If you&rsquo;ve ever used Packer for anything serious, you could empathize/understand why I want to build my own tool.</p>

<p>What do I want to do?</p>

<ol>
<li>Easily turn any VirtualBox registered VM on my host machine into a .box file and add it to Vagrant.</li>
<li>Deploy it in 1 command.</li>
</ol>


<h2>Architecture</h2>

<p>A Rakefile that calls to sub .task files in a subdir to create then build out the machine.</p>

<p>The top level Rakefile will allocate class variables such as directory strucutre, arrays and hashes used by the lower .task files. It will allocate ENV variables, in particular <code>VM_USER</code> and <code>VM_PASSWORD</code> to be used by the lower .tasks. It will also ensure all environment dependencies such as gems and programs are installed properly.</p>

<h2>Rakefile</h2>

<p>We&rsquo;ll start with the top level Rakefile and work our way down:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>begin
</span><span class='line'>  require 'rake'
</span><span class='line'>  require 'expect'
</span><span class='line'>  require 'net/ssh'
</span><span class='line'>rescue LoadError =&gt; e 
</span><span class='line'>  puts "Error during load, running bundler"
</span><span class='line'>  system('bundler')
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># Load the subtasks
</span><span class='line'>Dir['tasks/*.rake'].each { |file| load(file) }
</span><span class='line'>
</span><span class='line'># Set top level dir for sub level rake tasks
</span><span class='line'>@cwd = File.dirname(__FILE__)
</span><span class='line'>
</span><span class='line'># Ensure we have some deps
</span><span class='line'>gems = %w(net-ssh)
</span><span class='line'>gems.each {|g| 
</span><span class='line'>  unless system("gem list --local -q --no-versions --no-details #{g} | egrep '^#{g}$' &gt; /dev/null 2&gt;&1") 
</span><span class='line'>      puts "#{g} gem not found, installing..."
</span><span class='line'>      unless system("gem install #{g}")
</span><span class='line'>          abort "Failed to install gem: #{g}"
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>}
</span><span class='line'>exec = %w(vboxmanage)
</span><span class='line'>exec.each {|p|
</span><span class='line'>  unless system("which #{p}")
</span><span class='line'>      abort "Failed to find the executable '#{p}', please make sure it's installed."
</span><span class='line'>  end
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>namespace :vm do
</span><span class='line'>  Rake::Task['create'].execute
</span><span class='line'>  Rake::Task['build'].execute
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>The comments are self explanitory. We do some basic enviro checks, declare some class variables and load up the subtask files.</p>

<p>Since this is <em>my</em> tool I can do whatever I want. This is going to be a super streamlined process, I only need it to work with VirtualBox so I don&rsquo;t need to get too crazy. I can basically rely on the <code>vboxmanage</code> command line tool to interact with the VM.</p>

<p><strong><em>DISCLAIMER:</em></strong> I originally was going to leverage the <a href="http://net-ssh.github.io">Net::SSH</a> ruby library to run all my post-processing on the VM. I needed some way to SCP scripts to the VM and execute them. Originally I used <code>vboxmanage</code> to get the IP address of the VM, then <code>Net::SSH</code> to SCP and execute commands. I had some methods all worked out for this, but then I ralized this needed to work on the VirtualBox NAT'ed network.</p>

<p>Ouch.</p>

<p>It would not reliably get a proper IP address and I also needed to do some fancy reverse SSH tunneling to SCP and execute with <code>Net::SSH</code>. I struggled with this for an hour or two and realized my desire to use all Ruby libs to do this interaction was going to be more trouble than it was worth. I instead decided to use the <code>vboxmanage</code> subset of tools that will actually copy data to the VM and execute the data. I re-wrote my copy and execute methods but still kept the <a href="https://github.com/malnick/create-vagrant-box/blob/master/extras/netssh_test.rb">Net::SSH code for later reference</a> since it&rsquo;s super handy.</p>

<h2>Create</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>#!/bin/ruby
</span><span class='line'>require 'rake'
</span><span class='line'>require 'expect'
</span><span class='line'>require 'net/ssh'
</span><span class='line'>
</span><span class='line'>desc 'Build a Vagrant box from a vBox VM'
</span><span class='line'>task :create do 
</span><span class='line'>  # Vars 
</span><span class='line'>  @vmhash     = {}
</span><span class='line'>  @vmname     = ENV['VM_NAME'] 
</span><span class='line'>  @vmuser     = ENV['VM_USER']
</span><span class='line'>  @vmpwd      = ENV['VM_PWD']
</span><span class='line'>  guestiso    = '4.3.8'
</span><span class='line'>
</span><span class='line'>  # Get the guest edition ISO
</span><span class='line'>  vboxexists = File.exists?("#{@cwd}/VBoxGuestAdditions_#{guestiso}.iso")
</span><span class='line'>  if ! vboxexists
</span><span class='line'>      puts "Would you like to install the defualt version of guest editions? [#{guestiso}] [y/n]"
</span><span class='line'>      installdefault = STDIN.gets
</span><span class='line'>      if installdefault =~ /^y/       
</span><span class='line'>          puts "Ok, downloading vBox guest editions version #{guestiso}"
</span><span class='line'>          unless system("wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_#{guestiso}.iso")
</span><span class='line'>              puts "Something broke downloading the guest editions iso."
</span><span class='line'>              puts 'This may break the building of the box later, continue? [y/n]'
</span><span class='line'>              cont = STDIN.gets
</span><span class='line'>              if cont =~/^n/
</span><span class='line'>                  abort 'Aborting.'
</span><span class='line'>              end
</span><span class='line'>          end
</span><span class='line'>      else
</span><span class='line'>          puts "Which version would you like to use? [x.x.x]"
</span><span class='line'>          installversion = STDIN.gets
</span><span class='line'>          puts "Ok, downloading vBox guest edition version #{installversion}"
</span><span class='line'>          unless system("wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_#{installversion}.iso")
</span><span class='line'>                  puts "Something broke downloading http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_#{installversion}.iso"
</span><span class='line'>              puts 'This may break the buidling of the box later, continue? [y/n]'
</span><span class='line'>              cont = STDIN.gets
</span><span class='line'>              if cont =~ /^n/
</span><span class='line'>                  abort "Aborting."
</span><span class='line'>              end
</span><span class='line'>          end
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>      # Create a hash of vBox VMs
</span><span class='line'>      num = 0
</span><span class='line'>      vms = IO.popen('vboxmanage list vms')
</span><span class='line'>      vms.readlines.each do |name| 
</span><span class='line'>          @vmhash.store(num,name.split(" ").first.chomp('"').reverse.chomp('"').reverse)
</span><span class='line'>          num=num+1
</span><span class='line'>      end
</span><span class='line'>
</span><span class='line'>      # how many vm's do we have available?
</span><span class='line'>      @vmhash.each_with_index {|k,i|
</span><span class='line'>          if i == @vmhash.length - 1 
</span><span class='line'>              @vmmax = i 
</span><span class='line'>          end
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      # Method to find if VM_NAME matches our hash listing
</span><span class='line'>      def findvm()
</span><span class='line'>          @vmhash.each do | k, v |  
</span><span class='line'>              test = v.chomp('"').reverse.chomp('"').reverse
</span><span class='line'>              return v if @vmname =~ /test/ 
</span><span class='line'>          end
</span><span class='line'>          nil
</span><span class='line'>      end     
</span><span class='line'>
</span><span class='line'>      # If a VM_NAME was given, don't list them but check to make sure it's a good name
</span><span class='line'>      if ! @vmname
</span><span class='line'>          puts "Which vBox VM would you like to vagrantize? [1-#{@vmmax}]"
</span><span class='line'>          @vmhash.each {|k,v| puts "#{k}: #{v}\n"}
</span><span class='line'>          vmcreate = STDIN.gets.chomp.to_i
</span><span class='line'>          vmax = @vmmax
</span><span class='line'>          until vmcreate.between?(0, vmax.to_i)
</span><span class='line'>              puts "Range check"
</span><span class='line'>              puts "Please select an integer between 1 and #{@vmmax}" 
</span><span class='line'>              vmcreate = STDIN.gets.chomp.to_i
</span><span class='line'>          end
</span><span class='line'>
</span><span class='line'>          @vmname = @vmhash[vmcreate]
</span><span class='line'>          Rake::Task['build'].execute
</span><span class='line'>      else
</span><span class='line'>          if findvm
</span><span class='line'>              @vmname = findvm
</span><span class='line'>              puts "#{@vmname} found with actual name: #{vmname}"
</span><span class='line'>              Rake::Task['build'].execute
</span><span class='line'>          else
</span><span class='line'>              puts "#{@vmname} not found, available vm's for building are:"
</span><span class='line'>              @vmhash.each {|k,v| puts "#{k}: #{v}\n"}
</span><span class='line'>              puts "Which VM would you like to use? [1-#{@vmmax}]"
</span><span class='line'>              vmcreate = STDIN.gets.chomp.to_i
</span><span class='line'>              vmax = @vmmax
</span><span class='line'>              until vmcreate.between?(0, vmax.to_i)
</span><span class='line'>                  puts "Please select an integer between 1 and #{@vmmax}" 
</span><span class='line'>                  vmcreate = STDIN.gets.chomp.to_i
</span><span class='line'>              end
</span><span class='line'>              @vmname = @vmhash[vmcreate]
</span><span class='line'>              Rake::Task['build'].execute
</span><span class='line'>
</span><span class='line'>          end
</span><span class='line'>      end
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Check for vBox guest editions locally: I needed to make sure I had guest editions locally, if I didn&rsquo;t I would prompt to download the most recent release or give myself the option to install a different version.</p></li>
<li><p>Get a list of all the registered VirtualBox VM&rsquo;s on the host: Get the list, create a hash that I can easily choose from with a numbered key.</p></li>
<li><p>Override the previous step if the <code>VM_NAME</code> ENV was given at runtime, ensure this matches with an actual VM registered in the list anyways.</p></li>
<li><p>Run <code>``Rake::Task['build'].excute</code></p></li>
</ol>


<h2>Build</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>desc 'Build the vBox VM with Vagrant parameters'
</span><span class='line'>task :build do
</span><span class='line'>  def vmrunning? ()
</span><span class='line'>      if system('vboxmanage list runningvms')
</span><span class='line'>          runningvms = []
</span><span class='line'>          vmproc = IO.popen('vboxmanage list runningvms &gt; /dev/null')
</span><span class='line'>          vmproc.readlines.each {|v| runningvms.push(v)}
</span><span class='line'>          runningvms.each {|v| 
</span><span class='line'>              if v =~ /"#{@vmname}"/
</span><span class='line'>                  puts "#{v} is running."
</span><span class='line'>                  true
</span><span class='line'>              else
</span><span class='line'>                  puts "#{v} is not running."
</span><span class='line'>                  nil 
</span><span class='line'>              end
</span><span class='line'>          }
</span><span class='line'>      else
</span><span class='line'>          puts "No VMs are found running via [vboxmanage list runningvms]"
</span><span class='line'>          exit 1          
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def vminfo()
</span><span class='line'>      @vmdata = IO.popen("VBoxManage guestproperty enumerate #{@vmname}").readlines
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def vmcp(locpath)
</span><span class='line'>      unless system("vboxmanage guestcontrol #{@vmname} copyto #{locpath} /root/ --username #{@vmuser} --password #{@vmpwd} --domain 0755 --verbose")
</span><span class='line'>          abort "Failed to copy #{locpath}"
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def vmexec(cmd)
</span><span class='line'>      unless system("vboxmanage guestcontrol #{@vmname} exec --image #{cmd} --username #{@vmuser} --password #{@vmpwd} --verbose --wait-stdout")
</span><span class='line'>          abort "Failed to run #{cmd} on guest machine"
</span><span class='line'>      end
</span><span class='line'>      puts "Successfully executed #{cmd}"
</span><span class='line'>  end
</span><span class='line'>  
</span><span class='line'>  def vmexec_with_args(cmd, args)
</span><span class='line'>      unless system("vboxmanage guestcontrol #{@vmname} exec --image #{cmd} --username #{@vmuser} --password #{@vmpwd} --verbose --wait-stdout -- #{args}")
</span><span class='line'>          abort "Failed to run #{cmd} on guest machine"
</span><span class='line'>      end
</span><span class='line'>      puts "Successfully executed #{cmd}"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  puts "-----"
</span><span class='line'>  puts "Vagrantizing #{@vmname}"
</span><span class='line'>  
</span><span class='line'>  # Start the VM
</span><span class='line'>  start = IO.popen("vboxmanage startvm #{@vmname}")
</span><span class='line'>  @proc_id = start.pid
</span><span class='line'>  puts "Process ID for VM: #{@proc_id}"
</span><span class='line'>
</span><span class='line'>  puts "Waiting to bring up machine..."
</span><span class='line'>  sleep(10)
</span><span class='line'>
</span><span class='line'>  # The main loop
</span><span class='line'>  while vmrunning?
</span><span class='line'>      # Get VM IP Address
</span><span class='line'>      vminfo.each {|line|
</span><span class='line'>          if line =~ /IP/
</span><span class='line'>              arry = line.split(",")
</span><span class='line'>              @vmip = arry[1].split(" ").last.strip.chomp
</span><span class='line'>          end
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      puts "Waiting for VM to become ready..."
</span><span class='line'>      sleep(10)
</span><span class='line'>
</span><span class='line'>      # Copy scripts dir to a locally accessible place
</span><span class='line'>      scripts = Dir["#{@cwd}/scripts/*.sh"] 
</span><span class='line'>      puts "Script dir: #{scripts}"
</span><span class='line'>      scripts.each {|s|
</span><span class='line'>          puts "Copying #{s} to VM..."
</span><span class='line'>          vmcp(s)
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      geiso = Dir["#{@cwd}/*.iso"]
</span><span class='line'>
</span><span class='line'>      # Copy guest editions over
</span><span class='line'>      geiso.each {|iso| 
</span><span class='line'>          puts "Copying #{iso} to VM..."
</span><span class='line'>          unless system("vboxmanage guestcontrol #{@vmname} copyto #{iso} /root/ --username #{@vmuser} --password #{@vmpwd} --domain 0755 --verbose")
</span><span class='line'>              abort "Failed to copy #{iso}"
</span><span class='line'>          end
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      vmexec_with_args("/bin/chmod", "0755 /root/vagrant.sh") 
</span><span class='line'>      vmexec_with_args("/bin/chmod", "0755 /root/vboxguest.sh")   
</span><span class='line'>      vmexec_with_args("/bin/chmod", "0755 /root/compact.sh") 
</span><span class='line'>      vmexec('/root/vagrant.sh')
</span><span class='line'>      vmexec('/root/vboxguest.sh')
</span><span class='line'>      vmexec('/root/compact.sh')
</span><span class='line'>
</span><span class='line'>      # 
</span><span class='line'>      unless system("vboxmanage controlvm #{@vmname} poweroff")
</span><span class='line'>          abort 'Failed to shutdown vm'
</span><span class='line'>      end
</span><span class='line'>
</span><span class='line'>      puts "Waiting for VM to shutdown."
</span><span class='line'>      sleep(5)
</span><span class='line'>
</span><span class='line'>      puts "Packing vm..."
</span><span class='line'>      unless system("vagrant package --base #{@vmname}")
</span><span class='line'>                abort "Failed to package the vm."
</span><span class='line'>      end
</span><span class='line'>
</span><span class='line'>      puts "All done."
</span><span class='line'>      puts "-----"
</span><span class='line'>      puts "VM package available at:"
</span><span class='line'>      puts "#{@cwd}/package.box"
</span><span class='line'>      exit 0
</span><span class='line'>      #Process.kill(@proc_id) and exit 0
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  # Package the box up
</span><span class='line'>  # vagrant package --output centos-6.5-x86_64.box --base centos-6.5-x86_64 &lt;-- example.
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>So, that first method is what I&rsquo;m going to wrap this entire program in - as long as the VM is running, lets copy some scripts to it, ensure they can be executed, then execute them.</p>

<h3>vmrunning?()</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def vmrunning? ()
</span><span class='line'>  if system('vboxmanage list runningvms')
</span><span class='line'>      runningvms = []
</span><span class='line'>      vmproc = IO.popen('vboxmanage list runningvms &gt; /dev/null')
</span><span class='line'>      vmproc.readlines.each {|v| runningvms.push(v)}
</span><span class='line'>      runningvms.each {|v|
</span><span class='line'>          if v =~ /"#{@vmname}"/
</span><span class='line'>              puts "#{v} is running."
</span><span class='line'>              true
</span><span class='line'>          else
</span><span class='line'>              puts "#{v} is not running."
</span><span class='line'>
</span><span class='line'>          end
</span><span class='line'>      }
</span><span class='line'>  else
</span><span class='line'>      puts "No VMs are found running via [vboxmanage list runningvms]"
</span><span class='line'>      exit 1          
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Pop open a vboxmanage process to list out the running VM&rsquo;s, ensure our VM exists there.</p>

<h3>vminfo()</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def vminfo()
</span><span class='line'>  @vmdata = IO.popen("VBoxManage guestproperty enumerate #{@vmname}").readlines
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Super simple, use vbox manage to get a listing of VM data using <code>guestproperty enumerate</code>. I used the <code>.readlines</code> method so I could iterate it into an array easily.</p>

<h3>vmcp(locpath)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def vmcp(locpath)
</span><span class='line'>  unless system("vboxmanage guestcontrol #{@vmname} copyto #{locpath} /root/ --username #{@vmuser} --password #{@vmpwd} --domain 0755 --verbose")
</span><span class='line'>      abort "Failed to copy #{locpath}"
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Use the guestcontrol command for vboxmanage to copy stuff from my host to the guest. Copies it to <code>/root</code> by default.</p>

<h3>vmexec(cmd)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def vmexec(cmd)
</span><span class='line'>  unless system("vboxmanage guestcontrol #{@vmname} exec --image #{cmd} --username #{@vmuser} --password #{@vmpwd} --verbose --wait-stdout")
</span><span class='line'>      abort "Failed to run #{cmd} on guest machine"
</span><span class='line'>  end
</span><span class='line'>  puts "Successfully executed #{cmd}"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Execute commands without arguments on the guest VM. Handy for running my scripts after I copy them over or changing file permissions.</p>

<h3>vmexec_with_args(cmd, args)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def vmexec_with_args(cmd, args)
</span><span class='line'>  unless system("vboxmanage guestcontrol #{@vmname} exec --image #{cmd} --username #{@vmuser} --password #{@vmpwd} --verbose --wait-stdout -- #{args}")
</span><span class='line'>      abort "Failed to run #{cmd} on guest machine"
</span><span class='line'>  end
</span><span class='line'>  puts "Successfully executed #{cmd}"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Do the exec with arguments if needed.</p>

<h2>Execute some scripts on the VM, exit, package the .box</h2>

<p>The rest of the script is pretty straight forward. I drop into my <code>unless vmrunning?()</code> loop, copy over my scripts, run some <code>chmod</code> commands and execute them.</p>

<p>The scripts setup the Vagrant user and environmnent then install vBox Guest Editions and shutdown the VM once the scripts complete.</p>

<p>Then it&rsquo;s simply a matter of using the <code>vagrant package --base</code> command on the box <strong><em>with the correct box timecode attached to it</em></strong>. (that last bit is completely undocumented).</p>

<h2>Complete Project</h2>

<p><a href="https://github.com/malnick/create-vagrant-box/">Available Here</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jeff Malnick</span></span>

      




<time class='entry-date' datetime='2014-08-03T17:22:54-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>5:22 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://technoblogic.io/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/" data-via="jmalnick" data-counturl="http://technoblogic.io/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/21/agile-dev-environment-for-puppet-code/" title="Previous Post: Agile Dev Environment for Puppet Code">&laquo; Agile Dev Environment for Puppet Code</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/31/arbitrary-commandline-functions-for-mco/" title="Next Post: Arbitrary Commandline Functions for MCO">Arbitrary Commandline Functions for MCO &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/19/day2-logging/">DC/OS Day 2 Operations: Part 1 - Logging API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/containerization-in-devops-talk/">Containerization in DevOps Talk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/25/dc-scale-application-health-monitoring/">DC/OS System Health Monitoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/24/the-data-center-operating-system-installer-part-1/">Building an Installer for the Data Center Operating System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/17/automated-installs-over-ssh-lessons-learned/">How to Deploy Highly Scalable Systems Over SSH</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/malnick">@malnick</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'malnick',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

Included file 'asides/twitter.html' not found in _includes directory
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jeff Malnick -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
    var stickyNavTop = $('nav').offset().top;  
      
    var stickyNav = function(){  
      var scrollTop = $(window).scrollTop(); 
      var navHasClassSticky = $('nav').hasClass('sticky');

      if (scrollTop > stickyNavTop && navHasClassSticky) {   
        return true;
      } else if (scrollTop > stickyNavTop) {
        $('nav').hide();
        $('nav').addClass('sticky');
        $('nav').fadeIn('2000');
      } else {  
        $('nav').removeClass('sticky');   
      }  
    };  
      
    stickyNav();  
      
    $(window).scroll(function() {  
      stickyNav();  
    });  
  });  
</script>


</body>
</html>
