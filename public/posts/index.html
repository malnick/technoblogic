
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>All Posts - Technoblogic</title>
  <meta name="author" content="Jeff Malnick">

  
  <meta name="description" content="All Posts Mantle: Encrypted JSON for the Marathon API Mantle is a go utility that wraps the POST process to Mesosphere&rsquo;s Marathon API. Before &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="httpL://www.jeffmalnick.com/posts/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Technoblogic" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Technoblogic</a></h1>
  
    <h2>Musings on DevOps</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="httpL://www.jeffmalnick.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">All Posts</a></li>
  <li><a href="/blog/resume">Resume</a></li>
  <li><a href="/blog/about">About Jeff</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="all-posts">
  <div class="container">
    <div class="row">
      <div class="list-title col-md-offset-3 col-md-6">
        <h4>All Posts</h4>
      </div>
    </div>
  </div>

  <div class="article-list">
    <div class="container">
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/09/05/mantle-encrypted-json-for-the-marathon-api/">Mantle: Encrypted JSON for the Marathon API</a></h2>
  
  <p>
    <p><img style="float: center;" src="https://dl.dropboxusercontent.com/u/77193293/mantle.png"></p>




<p><a href="https://github.com/malnick/mantle.git">Mantle</a> is a go utility that wraps the POST process to Mesosphere&rsquo;s Marathon API. Before, users had to store JSON with cleartext environment variables for their Docker container configuration. With Mantle, users can encrypt the values for the &ldquo;env&rdquo; parameters passed to Marathon using asynchronous public/private key pairs. Mantle is designed to allow operations or deployment teams to build user-level key pairs, and give those public keys to the users&#8217; with the most knowledge of the application&rsquo;s configuration. Those users, can then encode the JSON with Mantle via their public keys and let the deployment team review the JSON and have the final private key to decrypt and deploy to Marathon(s) via Mantle.</p>




<h3>Example Use Case</h3>




<p>Create private/public keys and eyaml data from cleartext in JSON for Marathon:</p>




<ol>
<li><p><code>mantle -generate</code>: Generates keys for $user defined in config.yaml. User can be overridden with -u. Keys are stored i  n $key_directory specified in config.yaml.</p></li>
<li><p><code>vi marathon_data.json</code>:</p></li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;container&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;docker&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;some_repo/some_container_image&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;network&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;portMappings&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span> <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">5050</span><span class="p">,</span> <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;my-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;MY_LICENSE_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;ENC[my_license_key:12345]&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MONGO_PASSWORD&quot;</span><span class="p">:</span> <span class="s2">&quot;ENC[qa_mongo_pw:$ecretp@$$word]&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;JEFFS_SECRET&quot;</span><span class="p">:</span> <span class="s2">&quot;ENC[production_secret:13adfafd%^$^$&amp;DFS]&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;SAFE_DATA&quot;</span><span class="p">:</span> <span class="s2">&quot;This is safe&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;cpus&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;mem&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;upgradeStrategy&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;minimumHealthCapacity&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;maximumOverCapacity&quot;</span><span class="p">:</span> <span class="mf">0.4</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Add as many <code>ENC[eyaml_key:cleartext_value]</code> as you need.</p>




<ol>
<li><code>mantle -encode marathon_data.json</code>: Encodes the cleartext values in each ENC[] statement with the user&rsquo;s public key.</li>
</ol>




<p>Adds those key/values to the eyaml file, and saves the eyaml file to <code>$eyaml_directory/$user.yaml</code> as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">my_license_key</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">iFpLHn3wsr6/ZpoolepdT7uhp6hRq/2Tr+LyJXOpJAxkulMsb1pxE8GjKlR9iTTIV9IYnU</span>
</span><span class='line'>  <span class="no">JeIibAaDqfq0SZF8i8xjN6Tx6Ytx3d8BBu2pCT3nDuqpGEDqnZUZDkjp6eRScAtbsPzB8m</span>
</span><span class='line'>  <span class="no">taVfEO9j7zEpU/pWTr9x/awsK8gGp/E=</span>
</span><span class='line'><span class="l-Scalar-Plain">prod_caleb_secret</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">IGpl8fRKGol+XHnCIsha0fTVIsTiq1sdbZ/l0PplAzBdPN+vmjn5Cg7fBeHKoT+7+RCyId</span>
</span><span class='line'>  <span class="no">Yu+7O/gUK1R5zGHJgXA9BV9I3Fh+/dCb3W+c3NFFQNfivHxoad8ggZIX1xk/EyJQAJHTRD</span>
</span><span class='line'>  <span class="no">WypeeyIswps1o5cv1DXj2rJbjBJ33hA=</span>
</span><span class='line'><span class="l-Scalar-Plain">production_secret</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">Sc2D2DlrXf+rsZ6Yovr2/0AE5ZhwfRgKuHax3c3zxDIRvpCcfjqGvbXQUOpE/NwUAu/hNt</span>
</span><span class='line'>  <span class="no">km1vHJ3CgQIwr1Y8SD3WVQ1O2KO87bhcQHmB4HTFsLCtW6m0KsqI5okCSUnsR+yAhKYfqt</span>
</span><span class='line'>  <span class="no">2MBjh38IN3JQz3PbA2psfhrzAg8rt7M=</span>
</span><span class='line'><span class="l-Scalar-Plain">qa_mongo_pw</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">sOOZCr1RsNQT56UZJVxqi39oSC6r5qazGsRncnHP4rdRIAELwW1qME+bBMqhlUh4enqYkM</span>
</span><span class='line'>  <span class="no">vIk6ebR5Oxt+luxAJR5yCfP4Ol7OZjCHIwOCnW5l50ekOuBnJWxhUEQMZe+4DMsK9G+ml0</span>
</span><span class='line'>  <span class="no">/W1mX71ogSK7Kxcn32Ttb2vK9jDfY/k=</span>
</span><span class='line'><span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">some_user</span>
</span></code></pre></td></tr></table></div></figure>




<p> new &ldquo;safe&rdquo; JSON is saved to <code>$safe_dir/marathon_data.json</code> as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">{</span>
</span><span class='line'>        <span class="s">&quot;container&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;docker&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                        <span class="s">&quot;image&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;some_repo/some_container_image&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;network&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;BRIDGE&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;portMappings&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>                                <span class="p-Indicator">{</span>
</span><span class='line'>                                        <span class="s">&quot;containerPort&quot;</span><span class="p-Indicator">:</span> <span class="nv">5050</span><span class="p-Indicator">,</span>
</span><span class='line'>                                        <span class="s">&quot;hostPort&quot;</span><span class="p-Indicator">:</span> <span class="nv">0</span><span class="p-Indicator">,</span>
</span><span class='line'>                                        <span class="s">&quot;protocol&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;tcp&quot;</span>
</span><span class='line'>                                <span class="p-Indicator">}</span>
</span><span class='line'>                        <span class="p-Indicator">]</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DOCKER&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="s">&quot;cpus&quot;</span><span class="p-Indicator">:</span> <span class="nv">0.5</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;env&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;JEFFS_SECRET&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DEC[production_secret]&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;MONGO_PASSWORD&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DEC[qa_mongo_pw]&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;MY_LICENSE_KEY&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DEC[my_license_key]&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;SAFE_DATA&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">safe&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;my-service&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;instances&quot;</span><span class="p-Indicator">:</span> <span class="nv">1</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;mem&quot;</span><span class="p-Indicator">:</span> <span class="nv">1024</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;upgradeStrategy&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;maximumOverCapacity&quot;</span><span class="p-Indicator">:</span> <span class="nv">0.4</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;minimumHealthCapacity&quot;</span><span class="p-Indicator">:</span> <span class="nv">0.8</span>
</span><span class='line'>        <span class="p-Indicator">}</span>
</span><span class='line'><span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li><code>mantle -deploy ~/.mantle/safe/marathon_data.json</code>: Deploys the &ldquo;safe&rdquo; JSON data, first decrypting the DEC[] statement  s, then POSTing that decrypted JSON to each specified Marathon in your config.yaml.</li>
</ol>




<p>The final POST from our example, with decrypted data:
The final POST from our example, with decrypted data:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;container&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;docker&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;some_repo/some_container_image&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;network&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;portMappings&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                        <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">5050</span><span class="p">,</span>
</span><span class='line'>                                        <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                                        <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                        <span class="p">]</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKER&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;cpus&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;JEFFS_SECRET&quot;</span><span class="p">:</span> <span class="s2">&quot;13adfafd%^$^$\u0026DFS&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;MONGO_PASSWORD&quot;</span><span class="p">:</span> <span class="s2">&quot;$ecretp@$$word&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;MY_LICENSE_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;SAFE_DATA&quot;</span><span class="p">:</span> <span class="s2">&quot;This is safe&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;my-service&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;mem&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;upgradeStrategy&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;maximumOverCapacity&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;minimumHealthCapacity&quot;</span><span class="p">:</span> <span class="mf">0.8</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Generate key-pairs for Developers</h3>




<p>Mantle was developed with the DevOps process in mind. However, it&rsquo;s unlikely that you&rsquo;ll want to give everyone the deployment keys. Mantle allows you to create a key-pair for any user, and give that user only the public key so they can encrypt the JSON. This leaves the ability to deploy in the hands of the deployment or operations team since they have the users&#8217; associated private key and can decrypt the JSON.</p>




<ol>
<li><code>mantle -generate -u sally</code>: Mantle will generate pub/private keypair and deposit them in <code>key_dir</code> specified in config.yaml.</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Generating PKCS keys...
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Private Key: /Users/malnick/.mantle/keys/privatekey_sally.pem
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>MIICXAIBAAKBgQDZ8lDifZdR+xcBZG99t541Vt3WFMOiER/qclIWtjQjtkCt8/ij
</span><span class='line'>dsp/Yn7DHJ3oYB58CbXvXWb9ONMB8Tr1vhCQZVXtJTN2sloUlD7SYne/GrxAJZjT
</span><span class='line'>8vTYoa3ZvvTpWXXYwGiPY8TmnCNqqC0ApqI4o67ZcWIx5FPWgqWu+SHBcQIDAQAB
</span><span class='line'>AoGAB6Rhha+VsMA3LEtTRXs8xu4G1UzhFzu2fMgJbNZyuZXYasEVRNYTf6f6fejw
</span><span class='line'>+Ib2Sq8kfAIwbEyjyXul75v8hKMYBFB8GBxvXuhJuLM1/EWwXtEvHW6p0Km0MZME
</span><span class='line'>eob3kzg4DLe9RxpnCZOYEMhRz9VBbYCcs5G3RcSoXY/2woECQQDvHIhoaln5o7HG
</span><span class='line'>8TZFgZRJ6z/n4H6jfgx08+xKl8llMIwQMGEyftiHmB1ULBxlAM3yYOOxtzHmwj6I
</span><span class='line'>LDkVskSZAkEA6VcXl4g11tk3ZL0fr30+PFvAH6Y3s88aNYr/JNFBb7Edeijs71Mb
</span><span class='line'>Qt8T/2DgpgxYTctQM7mvSh52V9BUNWQSmQJAQBBd/9PWzYrtO8cu6kqAh5mPIrpE
</span><span class='line'>U9uWzNL50TZ/0CvEqyW7NQNFUncQDJhQ90LS6wjImLnjldcfV+65ULXVqQJAFKaI
</span><span class='line'>h/ieCy2eIWQ7caR75YuZLTPgqiEiCKsMeY2rZN8f5LfKgEOynfBwLKG+P/PHvNrJ
</span><span class='line'>dkpwoPahMpRVX4RDwQJBANh7Pp60KVpWrpcCGOPxCCaPAfgY7Hht4BYexBO2HBr1
</span><span class='line'>bjsDYTotBmMx8HExMNf9vQXJkM135kuZ+fevLOcwiV8<span class="o">=</span>
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span><span class='line'>
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Public Key: /Users/malnick/.mantle/keys/publickey_sally.pem
</span><span class='line'>-----BEGIN RSA PUBLIC KEY-----
</span><span class='line'>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZ8lDifZdR+xcBZG99t541Vt3W
</span><span class='line'>FMOiER/qclIWtjQjtkCt8/ijdsp/Yn7DHJ3oYB58CbXvXWb9ONMB8Tr1vhCQZVXt
</span><span class='line'>JTN2sloUlD7SYne/GrxAJZjT8vTYoa3ZvvTpWXXYwGiPY8TmnCNqqC0ApqI4o67Z
</span><span class='line'>cWIx5FPWgqWu+SHBcQIDAQAB
</span><span class='line'>-----END RSA PUBLIC KEY-----
</span></code></pre></td></tr></table></div></figure>




<ol>
<li><p>Hand out the public key (<code>~/.mantle/keys/publickey_sally.pem</code>) to Sally, and keep the private key locally. Ensure Sally places the key in her <code>key_directory</code> specified in config.yaml.</p></li>
<li><p>Have Sally write her JSON with <code>ENC[$eyaml_key:$cleartext_value]</code> statements.</p></li>
</ol>




<p><code>vi sallys/local/machine/sallys_container.json</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;container&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;docker&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;sallys_org/sallys_container&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;network&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;portMappings&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span> <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">5050</span><span class="p">,</span> <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;my-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;SALLYS_SECRET&quot;</span><span class="p">:</span> <span class="s2">&quot;ENC[sallys_qa_secret:superawesomesauce]&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MONGO_PASSWORD&quot;</span><span class="p">:</span><span class="s2">&quot;ENC[qa_mongo_password:mongoiswebscale]&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;NEWRELIC_API_KEY&quot;</span><span class="p">:</span><span class="s2">&quot;ENC[newrelic_api_key:7638263546473822299283737]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;cpus&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;mem&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;upgradeStrategy&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;minimumHealthCapacity&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;maximumOverCapacity&quot;</span><span class="p">:</span> <span class="mf">0.4</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li><p><code>git clone git@github.com:sallys_org/eyaml sallys/local/machine/sallys_local_eyaml_checkout</code>: Have Sally pull down the company eyaml directory, and then have her update the <code>eyaml_dir</code> in Mantle&rsquo;s config.yaml.</p></li>
<li><p><code>git clone git@github.com:sallys_org/safe_json sallys/local/machine/sallys_local_safe_checkout</code>: Have Sally pull down the company safe json directory, and then have her update the <code>safe_dir</code> in Mantle&rsquo;s config.yaml.</p></li>
<li><p><code>mantle -encode sallys/local/machine/sallys_container.json</code>: Sally can then encode the JSON. Mantle will save the JSON and user-level eyaml in the git repo&rsquo;s she just checked out:</p></li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Encoding sallys_container.json
</span><span class='line'>WARN<span class="o">[</span>0000<span class="o">]</span> /Users/malnick/.mantle/eyaml/sally.yaml does not exist, creating.
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> eyaml saved: /Users/malnick/.mantle/eyaml/sally.yaml
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Safe JSON:
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;container&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;docker&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;image&quot;</span>: <span class="s2">&quot;sallys_org/sallys_container&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;BRIDGE&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;portMappings&quot;</span>: <span class="o">[</span>
</span><span class='line'>                                <span class="o">{</span>
</span><span class='line'>                                        <span class="s2">&quot;containerPort&quot;</span>: 5050,
</span><span class='line'>                                        <span class="s2">&quot;hostPort&quot;</span>: 0,
</span><span class='line'>                                        <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>
</span><span class='line'>                                <span class="o">}</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;DOCKER&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;cpus&quot;</span>: 0.5,
</span><span class='line'>        <span class="s2">&quot;env&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;MONGO_PASSWORD&quot;</span>: <span class="s2">&quot;DEC[qa_mongo_password]&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;NEWRELIC_API_KEY&quot;</span>: <span class="s2">&quot;DEC[newrelic_api_key]&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;SALLYS_SECRET&quot;</span>: <span class="s2">&quot;DEC[sallys_qa_secret]&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;my-service&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;instances&quot;</span>: 1,
</span><span class='line'>        <span class="s2">&quot;mem&quot;</span>: 1024,
</span><span class='line'>        <span class="s2">&quot;upgradeStrategy&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;maximumOverCapacity&quot;</span>: 0.4,
</span><span class='line'>                <span class="s2">&quot;minimumHealthCapacity&quot;</span>: 0.8
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Saving safe JSON <span class="k">for</span> decode: /Users/malnick/.mantle/safe/sallys_container.json
</span></code></pre></td></tr></table></div></figure>




<p>Notice the WARN statement. Since Mantle did not find a <code>eyaml_dir/$user.yaml</code> it created a new one for her.</p>




<p>The eyaml looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">newrelic_api_key</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">N4JpKRvQoRBusI7Yp7BN1L/wTdexGH3NFidxvTM0P3IeGM8OnU9TfGI19j+qDQt/XVOQln</span>
</span><span class='line'>  <span class="no">q2h6U/2BlHanQksytxjmuIAX5pVh1IqPFHxp0vkuU8lNffL7Z8VzPEurX4aPEyckQe5Y+E</span>
</span><span class='line'>  <span class="no">OnglwxdWreQnmMuo2Vyu9bhAF+HVWwc=</span>
</span><span class='line'><span class="l-Scalar-Plain">qa_mongo_password</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">UZ1M9L2c/N0AeDlILcP44ACd+niZeaw/BDt1oh78aNf818iTDXAl1c3deUohR12fwEMyCZ</span>
</span><span class='line'>  <span class="no">FHFhErN8u4do97iGeN8QCRdECULj/KOalPG+N70jTxzW9WIpReuPFlCqCrrT+nu/9v2CjO</span>
</span><span class='line'>  <span class="no">1IX5zbxN8UThL9ba2LW25QS1jPEPkMc=</span>
</span><span class='line'><span class="l-Scalar-Plain">sallys_qa_secret</span><span class="p-Indicator">:</span> <span class="kt">!!binary</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">UkbR2x+FftMr0O4K13iG/msEDpI8bi7+Mz2NIFxiRmXdwziQtUMYVrvJkpq3hgavGC2DBl</span>
</span><span class='line'>  <span class="no">C0gfmdAa6LfX4zS1lXFHIZD0tpY4dDdqWPFuwRPqVKLLNwiDX46olAEu104iOp6wsRPiJV</span>
</span><span class='line'>  <span class="no">pa92d0uUC4X67BmPF/6LueIVXUTEBYY=</span>
</span><span class='line'><span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sally</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li><p>Sally then pushes both eyaml and safe repo&rsquo;s back to git.</p></li>
<li><p>Now the safe JSON and eyaml repo&rsquo;s can be pulled by the operations team. At this point, a review of the Safe JSON can be made to ensure everything looks right. Finally, we can deploy the safe JSON via Mantle to Marathon with the key for Sally:</p></li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user@localhost: mantle -deploy ~/.mantle/safe/sallys_container.json -u sally
</span><span class='line'>
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Deploying ~/.mantle/safe/sallys_container.json
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Decrypted qa_mongo_password to mongoiswebscale
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Decrypted newrelic_api_key to 7638263546473822299283737
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Decrypted sallys_qa_secret to superawesomesauce
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> Decoded JSON:
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;container&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;docker&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;image&quot;</span>: <span class="s2">&quot;sallys_org/sallys_container&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;BRIDGE&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;portMappings&quot;</span>: <span class="o">[</span>
</span><span class='line'>                                <span class="o">{</span>
</span><span class='line'>                                        <span class="s2">&quot;containerPort&quot;</span>: 5050,
</span><span class='line'>                                        <span class="s2">&quot;hostPort&quot;</span>: 0,
</span><span class='line'>                                        <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>
</span><span class='line'>                                <span class="o">}</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;DOCKER&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;cpus&quot;</span>: 0.5,
</span><span class='line'>        <span class="s2">&quot;env&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;MONGO_PASSWORD&quot;</span>: <span class="s2">&quot;mongoiswebscale&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;NEWRELIC_API_KEY&quot;</span>: <span class="s2">&quot;7638263546473822299283737&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;SALLYS_SECRET&quot;</span>: <span class="s2">&quot;superawesomesauce&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;my-service&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;instances&quot;</span>: 1,
</span><span class='line'>        <span class="s2">&quot;mem&quot;</span>: 1024,
</span><span class='line'>        <span class="s2">&quot;upgradeStrategy&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;maximumOverCapacity&quot;</span>: 0.4,
</span><span class='line'>                <span class="s2">&quot;minimumHealthCapacity&quot;</span>: 0.8
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> POSTing to http://my.marathon1.com
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>




<h4>[Check out the git repo here)[<a href="https://github.com/malnick/mantle.git">https://github.com/malnick/mantle.git</a>]</h4>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-09-05T13:00:32-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:00 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/08/28/elasticsearch-logstash-cli-utility/">Logasuarus: A CLI Utility for Elasticsearch / Logstash</a></h2>
  
  <p>
    <p><img style="float: center;" src="https://dl.dropboxusercontent.com/u/77193293/logasaurus.png"></p>




<p>Like most operations teams, at SRC:CLR we&rsquo;re offloading our logs to an aggregated log solution. We use the popular ELK (Elasticsearch, Logstash, Kibana). I love this solution but when it comes to simply copying and pasting log data from Kibana things get messy. When our developers need to get data quickly it would be easier to have a CLI utility that can do the same queries than having to open a browser and screen grab from Kibana.</p>




  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-08-28T12:19:11-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:19 pm</span></time>
    

<span class="categories">
  
    <a class='category' href='//devops/'>devops</a>
  
</span>


  </span>

  
    <a class="full-article-link pull-right" rel="full-article" href="/blog/2015/08/28/elasticsearch-logstash-cli-utility/">Read on &rarr;</a>
  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/08/13/version-management-in-soa/">Version Management in SOA</a></h2>
  
  <p>
    <p>Service oriented architectures offer significant increases in agile deployment pipelines. They allow what were traditionally, large, monolithic code bases to be broken down into smaller, more manageable pieces. Instead of diagnosing a single issue that affects the application as a whole, SOA allows developers to troubleshoot smaller, atomic pieces.</p>




<p>SOA, by design, goes hand-in-hand with the concept of immutable infrastructure: you can now deploy small pieces of your application, codifying the infrastructure it runs on along the way, allowing for easy to maintain, automated application layers.</p>




<p>Commonly, this design pattern manifests itself with lots of small services proxied by some kind of layer 7 load balancer (nginx or haproxy) on the backend of some type of platform. The layer 7 load balancer allows easy to navigate REST API access. It also means the nodes which run these services have less overall configuration since they only need to run a small piece of the larger application, a single service. The natual evolution of this tends to be some kind of remote or dynamic service execution system that is agnostic of individual server resources, such as Apache Mesos.</p>




<p>Of course, service discovery mechanisms in this type of immutable environment are key.</p>




<h2>The Problem</h2>




<p>Now we have many, scatter services. Each deployed onto ephemeral servers with ephemeral IP addresses. Assuming the continuous integration pipeline is &ldquo;merge-to-environment&rdquo;, it&rsquo;s easy for developers to increment and deploy builds to QA or Production.</p>




<p>But how do you track the service versions running on each node across several, ephemeral boxes? How do you know CI was successful and the version you wanted to deploy is in fact running across all instances of the servers which execute your specific service?</p>




<p>The classic way was to query your service&rsquo;s managment endpoint. The IP of the server running the service and the privately held management port.</p>




<p>For the deployment at SRC:CLR, we managed a table of ports associated with services. Each service gets allotted 10 ports in a range, for each service and management port. This meant no more than 10 of each process could exist on a box together. It also means managing a port table. See <a href="http://www.jeffmalnick.com/blog/2015/07/14/static-service-provisioning-sucks/">my rant about why this sucks</a>.</p>




<h2>The Solution</h2>




<p>Our solution to tracking versions agross all running boxes is <a href="https://github.com/malnick/go_vctl">VersionCtl</a>.</p>




<p>VersionCtl is a go app that runs inside a docker container. It queries our Haproxies via <a href="https://github.com/malnick/rest_haproxy">REST HaProxy</a>, a service which reads out the haproxy config, and abstracts the backend blocks to &ldquo;services&rdquo; with endpoints (the server lines in the backend block). It exposes this as a rest endpoint which VersionCtl ingests.</p>




<p>What this looks like in a deployed environment is this:</p>




<p><img src="" alt="img" /></p>




<p>If versions between nodes in a given backend service abstraction do not match, the service line in VersionCtl goes red. VersionCtl also queries our Puppet Master for the versions.yaml hiera configuration file. This file is managed by jenkins in that it&rsquo;s rewritten everytime a build occurs with the version from Maven which was just built. It does this via a REST endpoint on the Puppet Master.</p>




<p>If the version running on a box does not match that of hte version in versions.yaml, the line will go red as well. This gives us fast visability into the state of a deployment, in real time. If the service failed to deploy onto a box, we know. If the CI pipeline broke between jenkins and the box, we know.</p>




<p>VersionCtl also kicks back the response from the actual GET request, allowing us to quickly see how the service is responding to the first thing we&rsquo;d do in the event of a CI or deployment malfunction: curl the management endpoint.</p>




<h2>Homogenous Functionality</h2>




<p>Eventually we&rsquo;ll want to roll out our Apache Mesos deployment. This will leverage Mesosphere&rsquo;s Marathon utility for deployments to the cluster. We could rewrite VersionCtl at that point, but since it&rsquo;s leveraging REST Haproxy we can actually continue to use it, adjusting the haproxy endpoints that it quaries. In combination with <a href="https://github.com/malnick/marathon_template.git">Marathon Template</a>, we can easily dynamically update VersionCtl as the infrastructure expands and contracts. With these three services we can scale out our infrastructure while maintaining visability into the running versions, keeping track of our dynamically updated environments and the deployments in real time.</p>




<h2>Can I use this?</h2>




<p>Yes. VersionCtl is <a href="https://github.com/malnick/go_vctl">open sourced</a> along with <a href="https://github.com/malnick/rest_haproxy">REST HaProxy</a> and <a href="https://github.com/malnick/marathon_template.git">Marathon Template</a>. You&rsquo;ll have to modify the production version that we run since you probably don&rsquo;t have the same versions.yaml CI pipeline. You can do this by removing puppetversions() method and it&rsquo;s implementation in the compare() method. You&rsquo;ll also have to update the index.html GO template to remove the pv index.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-08-13T08:47:19-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:47 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/07/31/a-restful-haproxy-service-abstraction/">A Restful Haproxy Service Abstraction</a></h2>
  
  <p>
    <p>A major hurdle of microservices is visibility into the versions of your deployed infrastructure. At SRC:CLR we have 7 different micro services plus our platform that drive our product. These services are deployed as immutable infrastructure, their IP&rsquo;s and configuration is fluid and changing all the time. During a deployment, we might to a canary update of our services, but having to manually query the <code>/info</code> endpoint across &lsquo;n&rsquo; number of nodes, IP addresses, and dynamic management port assignments is error prone and difficult. In order to gain visibility into the currently running services, we wrote a tool that finds available services by querying our frontend and internal loadbalancers for running services, and then queries those running services to get their running versions and display them in a lightweight frontend.</p>




<p>In order to get the server lines and service names from Haproxy we <a href="https://github.com/malnick/rest_haproxy">wrote a tool called REST Haproxy</a> which allows us to query our haproxy for &ldquo;service&rdquo; abstractions.</p>




<p>Given a haproxy configuration at path <code>/etc/haproxy/haproxy.cfg</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="err">global</span>
</span><span class='line'>  <span class="err">daemon</span>
</span><span class='line'>  <span class="err">group</span>  <span class="err">haproxy</span>
</span><span class='line'>  <span class="err">log</span>  <span class="err">127.0.0.1</span> <span class="err">local0</span>
</span><span class='line'>  <span class="err">log</span>  <span class="err">127.0.0.1</span> <span class="err">local1</span> <span class="err">notice</span>
</span><span class='line'>  <span class="err">maxconn</span>  <span class="err">4096</span>
</span><span class='line'>
</span><span class='line'><span class="err">defaults</span>
</span><span class='line'>  <span class="err">log</span> <span class="err">global</span>
</span><span class='line'>  <span class="err">mode</span>  <span class="err">http</span>
</span><span class='line'>
</span><span class='line'><span class="err">frontend</span> <span class="err">http-in</span>
</span><span class='line'>  <span class="err">bind</span> <span class="err">*:80</span>
</span><span class='line'>  <span class="err">acl</span> <span class="err">service</span> <span class="err">path_beg</span> <span class="err">-t</span> <span class="err">/service</span>
</span><span class='line'>  <span class="err">acl</span> <span class="err">other_service</span> <span class="err">path_beg</span> <span class="err">-t</span> <span class="err">/other_service</span>
</span><span class='line'>  <span class="err">default</span> <span class="err">backend</span> <span class="err">my_service</span>
</span><span class='line'>  <span class="err">use_backend</span> <span class="err">service</span> <span class="err">if</span> <span class="err">my_service</span>
</span><span class='line'>  <span class="err">use_backend</span> <span class="err">other_service</span> <span class="err">if</span> <span class="err">other_service</span>
</span><span class='line'>
</span><span class='line'><span class="err">backend</span> <span class="err">service</span>
</span><span class='line'>  <span class="err">balance</span> <span class="err">leastconn</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-01</span> <span class="err">10.0.1.10:31501</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32501</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-02</span> <span class="err">10.0.1.10:21502</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32502</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-03</span> <span class="err">10.0.2.10:31500</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32501</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-04</span> <span class="err">10.0.2.11:31500</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32502</span>
</span><span class='line'>
</span><span class='line'><span class="err">backend</span> <span class="err">other_service</span>
</span><span class='line'>  <span class="err">balance</span> <span class="err">leastconn</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-01</span> <span class="err">10.0.5.10:31501</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-02</span> <span class="err">10.0.5.10:21502</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-03</span> <span class="err">10.0.5.10:31503</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-04</span> <span class="err">10.0.5.11:31500</span> <span class="err">check</span>
</span></code></pre></td></tr></table></div></figure>




<p>Will result in the following JSON endpoint available at: <code>localhost:3000/services</code></p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;other_service&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;10.0.5.10:31501&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.5.10:21502&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.5.10:31503&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.5.11:31500&quot;</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;service&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;10.0.1.10:31501 10.0.1.10:32501&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.1.10:21502 10.0.1.10:32502&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.2.10:31500 10.0.2.10:32501&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;10.0.2.11:31500 10.0.2.11:32502&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p></p>




<p>Initially, I thought about writing this in Ruby. It is my best language after all. But recently I&rsquo;ve been bothered by Ruby. Mainly, I get bitten by not having the correct Ruby version installed on a machine, or having to install a whole suite of Ruby / gems versions.</p>




<p>Shipping code in Ruby is inexpensive in that all you need to do is <code>gem build &amp;&amp; gem push</code> but the heavyweight nature of an interpreted language wasn&rsquo;t something I wanted running on my lightweigtht Haproxy boxes. These boxes should be <em>only</em> Haproxy, and nothing else.</p>




<p>I felt dirty enough having to install Java on them in order to ship logs with logstash, adding yet more libraries just didn&rsquo;t feel right&hellip;</p>




<h2>So I wrote it in GoLang&hellip;</h2>




<p>GoLang is rad. Enough said. Why? Because it compiles directly to assembly. The Go tool has enough functionality that it makes it easy enough to test and run code locally, and if you don&rsquo;t want to ship a binary executable you can always dockerize it (but don&rsquo;t use a heavyweight base image!).</p>




<p>For the REST Haproxy service I decided to host the executable on our downloads server, the source code was open source&#8217;ed after all. I then wrote a <a href="https://github.com/malnick/puppet-rest_haproxy">some configuration management code</a> to wget the binary, and install a basic init script so it was available as a service.</p>




<h2>Results</h2>




<p>The result is a 7.5MB binary that runs on any AMD64 architecture. I don&rsquo;t need to configure any extra interpreters on the machine running the application and I don&rsquo;t need to manage issues that arise from that type of deployment.</p>




<p>The service comes up instantly when started:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@qa-haproxy-internal-recanted:/opt/rest_haproxy# <span class="nb">time</span> /etc/init.d/rest_haproxy start
</span><span class='line'>     <span class="o">(</span>       <span class="o">(</span>                <span class="o">)</span>      <span class="o">(</span>
</span><span class='line'>     <span class="o">)</span><span class="se">\ </span><span class="o">)</span>    <span class="o">)</span><span class="se">\ </span><span class="o">)</span>  *   <span class="o">)</span>   <span class="o">(</span> /<span class="o">(</span>      <span class="o">)</span><span class="se">\ </span><span class="o">)</span>
</span><span class='line'>    <span class="o">(()</span>/<span class="o">((</span>  <span class="o">(()</span>/<span class="o">(</span><span class="sb">`</span> <span class="o">)</span>  /<span class="o">(</span>   <span class="o">)</span><span class="se">\(</span><span class="o">))</span>   <span class="o">)(()</span>/<span class="o">((</span>          <span class="o">)</span> <span class="o">(</span>
</span><span class='line'>     /<span class="o">(</span>_<span class="o">))</span><span class="se">\ </span> /<span class="o">(</span>_<span class="o">))(</span> <span class="o">)(</span>_<span class="o">))</span> <span class="o">((</span>_<span class="o">)</span><span class="se">\ </span><span class="o">(</span> /<span class="o">(</span> /<span class="o">(</span>_<span class="o">))(</span>   <span class="o">(</span>  <span class="o">(</span> /<span class="o">(</span> <span class="o">)</span><span class="se">\ </span><span class="o">)</span>
</span><span class='line'>    <span class="o">(</span>_<span class="o">))((</span>_<span class="o">)(</span>_<span class="o">))</span> <span class="o">(</span>_<span class="o">(</span>_<span class="o">())</span>   _<span class="o">((</span>_<span class="o">))(</span>_<span class="o">)</span><span class="p">|</span>_<span class="o">))(()</span><span class="se">\ </span> <span class="o">)</span><span class="se">\ </span><span class="o">)</span><span class="se">\(</span><span class="o">)</span><span class="p">|</span><span class="o">()</span>/<span class="o">(</span>
</span><span class='line'>    <span class="p">|</span> _ <span class="se">\ </span>__/ __<span class="o">||</span>_   _<span class="p">|</span>  <span class="p">|</span> <span class="o">||</span> <span class="o">((</span>_<span class="o">)</span>_<span class="p">|</span> _ <span class="se">\(</span><span class="o">(</span>_<span class="o">)((</span>_<span class="p">|</span><span class="o">(</span>_<span class="o">)</span><span class="se">\ </span><span class="o">)(</span>_<span class="o">))</span>
</span><span class='line'>    <span class="p">|</span>   / _<span class="p">|</span><span class="se">\_</span>_ <span class="se">\ </span> <span class="p">|</span> <span class="p">|</span>    <span class="p">|</span> __ / _<span class="sb">`</span> <span class="p">|</span>  _/ <span class="err">&#39;</span>_/ _ <span class="se">\ \ </span>/<span class="p">|</span> <span class="o">||</span> <span class="p">|</span>
</span><span class='line'>    <span class="p">|</span>_<span class="p">|</span>_<span class="se">\_</span>__<span class="p">|</span>___/  <span class="p">|</span>_<span class="p">|</span>    <span class="p">|</span>_<span class="o">||</span>_<span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="se">\_</span>__/_<span class="se">\_\ \_</span>, <span class="p">|</span>
</span><span class='line'>                                                      <span class="p">|</span>__/
</span><span class='line'>REST HaProxy Started
</span><span class='line'>PID: 15803
</span><span class='line'>
</span><span class='line'>real    0m0.003s
</span><span class='line'>user    0m0.002s
</span><span class='line'>sys     0m0.001s
</span></code></pre></td></tr></table></div></figure>




<p>&hellip; and is exceptionally stable. The entire thing installs in less than 30 lines of configuration managment code:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">for</span> i in <span class="sb">`</span>find . -name <span class="se">\*</span>.pp<span class="sb">`</span><span class="p">;</span><span class="k">do</span> cat <span class="nv">$i</span> <span class="p">|</span> sed <span class="s1">&#39;/^\s*#/d;/^\s*$/d&#39;</span> <span class="p">|</span> wc -l<span class="p">;</span><span class="k">done</span>
</span><span class='line'>      29
</span></code></pre></td></tr></table></div></figure>




<p>For these reasons I am sold on Golang, and decided to re-write the entire <a href="https://github.com/malnick/go_vctl">VersionCtl</a> app using it - that&rsquo;s fodder for my next post.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-07-31T06:05:55-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>6:05 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/07/21/weak-dh-ciphers/">Weak Diffe-Helman SSL Ciphers</a></h2>
  
  <p>
    <p>We recently scanned our <code>srcclr.com</code> domain via <a href="https://www.ssllabs.com/">Qualsys</a> SSL Labs scanning suite. When we deployed this site in March (a migration from sourceclear.com to srcclr.com) we had an A+ rating.</p>




<p>However, our CEO recently re-scanned the site, and to our dismay, we got a B rating.</p>




<p>What was the cuase? According to SSL Labs, we were supporting &ldquo;weak Diffie-Hellman (DH) key exchange parameters. Grade capped to B.&rdquo;</p>




<p>Usually this would be due to supporting export grade crypto suites, which can be used in a man in the middle attack to fake you into using a weak cipher during your session.</p>




<p>In order to double check the SSL labs output, I ran my own scan using nmap:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>nmap --script ssl-enum-ciphers -p <span class="m">443</span> srcclr.com
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2015-07-21 11:31 PDT
</span><span class='line'>Nmap scan report <span class="k">for</span> srcclr.com <span class="o">(</span>107.23.63.147<span class="o">)</span>
</span><span class='line'>Host is up <span class="o">(</span>0.094s latency<span class="o">)</span>.
</span><span class='line'>Other addresses <span class="k">for</span> srcclr.com <span class="o">(</span>not scanned<span class="o">)</span>: 52.7.116.135
</span><span class='line'>rDNS record <span class="k">for</span> 107.23.63.147: ec2-107-23-63-147.compute-1.amazonaws.com
</span><span class='line'>PORT    STATE SERVICE
</span><span class='line'>443/tcp open  https
</span><span class='line'><span class="p">|</span> ssl-enum-ciphers:
</span><span class='line'><span class="p">|</span>   SSLv3: No supported ciphers found
</span><span class='line'><span class="p">|</span>   TLSv1.0:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_DHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>   TLSv1.1:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_DHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>   TLSv1.2:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_DHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_GCM_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_GCM_SHA384 - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>_  least strength: strong
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 4.64 seconds
</span></code></pre></td></tr></table></div></figure>




<p>Low and behold, there were the weak DHE non EC type ciphers.</p>




<p>Our front ends for our corporate site are hosted on Elastic Load Balancers. I double checked their configuration, and it appears AWS updated the default cipher suite in May, about a month after we deployed the site. The new cipher policy removes the non EC Diffe-Helman ciphers from the list. I turned on the new policy (which should automatically default to newest, IMO) and re-ran a scan:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>nmap --script ssl-enum-ciphers -p <span class="m">443</span> srcclr.com
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2015-07-21 12:21 PDT
</span><span class='line'>Nmap scan report <span class="k">for</span> srcclr.com <span class="o">(</span>107.23.63.147<span class="o">)</span>
</span><span class='line'>Host is up <span class="o">(</span>0.091s latency<span class="o">)</span>.
</span><span class='line'>Other addresses <span class="k">for</span> srcclr.com <span class="o">(</span>not scanned<span class="o">)</span>: 52.7.116.135
</span><span class='line'>rDNS record <span class="k">for</span> 107.23.63.147: ec2-107-23-63-147.compute-1.amazonaws.com
</span><span class='line'>PORT    STATE SERVICE
</span><span class='line'>443/tcp open  https
</span><span class='line'><span class="p">|</span> ssl-enum-ciphers:
</span><span class='line'><span class="p">|</span>   SSLv3: No supported ciphers found
</span><span class='line'><span class="p">|</span>   TLSv1.0:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>   TLSv1.1:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>   TLSv1.2:
</span><span class='line'><span class="p">|</span>     ciphers:
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 - strong
</span><span class='line'><span class="p">|</span>       TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_128_GCM_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_CBC_SHA256 - strong
</span><span class='line'><span class="p">|</span>       TLS_RSA_WITH_AES_256_GCM_SHA384 - strong
</span><span class='line'><span class="p">|</span>     compressors:
</span><span class='line'><span class="p">|</span>       NULL
</span><span class='line'><span class="p">|</span>_  least strength: strong
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 4.38 seconds
</span></code></pre></td></tr></table></div></figure>




<p>That appeared to have done the trick. I double checked by <a href="https://www.ssllabs.com/ssltest/analyze.html?d=srcclr.com&amp;s=52.7.116.135&amp;latest">re-scanning our site on SSL labs</a>, and it came up as an A+.</p>




<p>Moral of the story: scan your site regularly so you can stay on top of all the breaking SSL vulnerabilities. We should have been doing this every month, and will try to stick to that schedule from here on out.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-07-21T11:32:12-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>11:32 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/07/14/static-service-provisioning-sucks/">Static Service Provisioning Sucks</a></h2>
  
  <p>
    <p>Many tools exist to help automate and orchestrate provisioning servers. Each tool serves a purpose, or is tailored for a specific task. One realization I had not to long ago was that configuration management tools, as a framework, suck at provisioning micro services. I say that at the risk of bringing on the deluge of comments that often accompany such a blunt, over arching statement.</p>




<h2>Configuration Management Primer</h2>




<p>But let&rsquo;s think about it for a minute: how does configuration management work? The idea is to codify machine state into a static code base that can abstract a more complex system into simple resource statements. Then those resource statements are parsed and compiled into a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic graph</a>.</p>




<p>This graph is created every time an &lsquo;agent&rsquo; of some sort checks in or is manually kicked off by some other means. Each node in the graph represents the abstract state of some resource on the system, files, services, packages, and compares the state of the resource node in the graph to that of the resource which exists on the system. If it&rsquo;s different, it converges the state to match that of the graph.</p>




<h2>Service Primer</h2>




<p>In terms of services, we might have an abstract service definition that looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;haproxy&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>or</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">service</span> <span class="s1">&#39;nginx&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:start</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Each statement tells Puppet or Chef, respectively, to make sure the service for Nginx is running. How this would go down in real life is that Chef or Puppet would run, and if they find the service Nginx not running, it would be started. If it is found running, nothing occurs in order to maintain performance via idempotent actions.</p>




<p>The problem is services are running all the time, and are highly dynamic. They might crash for any number of reasons, and until configuration management kicks in, your service is unavailable.</p>




<p>That is, unless, it&rsquo;s monitored by a parent process that can track service state.</p>




<p>And in a lot of respects, framworks such as Docker aim to fill in this hole. The Docker daemon acts as that parent process that can monitor the child containers, ensuring they&rsquo;re always running or force restarts when they die. The Docker daemon is always running, unlike configuration management which only runs on regular intervals, and hopefully not to often for performance reasons.</p>




<p>Well what happens when the Docker daemon dies, you might ask? Who cares, it&rsquo;s still better than configuration management acting as the sole service schedular.</p>




<p>Many people have already realized this added benefit of Docker monitoring their service state. In that same vain, containerizing your services via Docker removes a lot of configuration management code. Where previously you had to maintain a package, a file, a service and all the other dependencies around your specific service via configuration management you can now simply tell configuration management to install docker and run this container.</p>




<h2>Static vs. Dynamic</h2>




<p>The hills rejoiced to the sound of sweet harmony of constantly running services!</p>




<p>But this isn&rsquo;t the end of the story. Whether you&rsquo;re running your service via some executable you provision with configuration management or via a docker container executed via configuration management, those services are still statically provisioned.</p>




<p>By static provisioning, I mean that you have some how hard coded a $role for a node classified as &lsquo;x&rsquo; and told your configuration management system to run service &lsquo;y&rsquo; for all machines with that classification. This is hard coded and static. The machine that runs this service does not change unless you hard code something else to tell it to do so.</p>




<p>That might be acceptable for simple applications, but when scaled you run into another issue: resource utilization.</p>




<p>At SRC:CLR we have a meager 70 node deployment. The resources of each node are unknown to other nodes, and we fall into the pitfall of underutilized infrastructure. We&rsquo;re not an enterprise, but recent studies show total DC utilization at <a href="https://gigaom.com/2013/11/30/the-sorry-state-of-server-utilization-and-the-impending-post-hypervisor-era/">around 6%</a>. We average around 1-2% total resource utilization. This tells me we&rsquo;re wasting at best 68% of our monthly DC costs (I would prefer 70% resource utilization, allowing for a comfortable 30% in over engineering for capacity).</p>




<p>It&rsquo;s easy to fall into this pitfall if your entire stack is managed by a static code base - it&rsquo;s programmatically difficult to classify a node in configuration management with a lot of different roles. You would need to instrument each node heavily to ensure proper resource utilization, and go to great lengths to ensure you&rsquo;re not creating hot spots - machines that are running hot, consuming too many resources while others sit idle with low intensity applications.
In the end, this is still a static configuration and is extraordinarily complex.</p>




<p>Dynamic configuration, at its core, assumes some master process provisions a service on demand, anywhere. It&rsquo;s not bound by classification, its only requirement is that memory and CPU resources are available to execute a scheduled task. It monitors these processes all the time, ensuring they&rsquo;re running and restarts them when they die.</p>




<p>This system sounds a lot like a Kernel in an operating system: it accepts IO to execute tasks and leverages a scheduler to execute those tasks across available memory and CPU resources.</p>




<h2>Mesos</h2>




<p>The <a href="http://mesos.apache.org/">Apache Mesos project</a> satisfies that requirement: it gathers resource information from all nodes in a cluster, then schedules and executes tasks against the available resources. An entire company, Mesosphere, has built the <a href="https://mesosphere.com/product/">Data Center Operating System</a> around Mesos, allowing seamless deployment of services across a cluster of machines, without configuration management to statically deploy them. Developers can write their own schedulers and executors or simply leverage the Docker executor to deploy services across an entire DC. No classification required.</p>




<p>At SRC:CLR we see the value in such a system as it simplifies our already complex configuration management around our back end micro services. This isn&rsquo;t to say configuration management isn&rsquo;t needed: it&rsquo;s needed. However, we&rsquo;ve found that configuration management isn&rsquo;t a service scheduler - it&rsquo;s great at static provisioning. But in the end we still need a way to manage all the basics like log rotation, the installation of Mesos, docker and other necessary packages, and all the other stuff that sits outside the realm of our immediate stack but is required by it.</p>




<p>Our goal for the future of our stack is to have Puppet manage the intermediate state of our infrastructure, bringing up a healthy cluster of nodes running Mesos which we can deploy our containerized stack on. Of course this brings about a whole new set of challenges around managing logs and security, topics I&rsquo;ll be covering more in later posts. In the end the move to leveraging a service that handles dynamic scheduling of our services allows us to scale faster while simultaneously using more available resources, which means a decrease in Ec2 instances and incurred costs. That&rsquo;s a huge win for a small company making ends meet on borrowed dollars.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-07-14T13:05:01-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:05 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/06/17/vertically-scaled-infrastructure/">Vertically Scaled Infrastructure</a></h2>
  
  <p>
    <h2>&ldquo;&hellip;but does is scale?&rdquo;</h2>




<p>When it comes to micro-service architectures that&rsquo;s always the big question. You can maintain a solid agile development process, design a micro service architecture, and implement seamless CI to ensure developers can launch code from their local test environment into Prod but if you can&rsquo;t respond to the increase in demand for your product then who cares? Unusable products, no matter how cool, won&rsquo;t get traffic and your company will suffer.</p>




<h2>Vertical Scaling</h2>




<p>Scaling starts vertically - or locally - before moving to multiple machines.</p>




<p>It&rsquo;s important to understand how scaling a micro-service works in order to buy into this logic. First, a micro-service architecture is comprised of lots of atomic, REST endpoints, which should be able to generate some meaningful data on their own, with out the help of other services in the ecosystem. As long as service &lsquo;x&rsquo; can talk to your queue and perhaps a datastore of some kind, it should be considered healthy.</p>




<h3>The Essence of a &ldquo;Service&rdquo;</h3>




<p>Starting and stopping service &lsquo;x&rsquo; can be viewed as a <a href="https://en.wikipedia.org/wiki/Unary_operation">unary</a> operation which is <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a> across restarts and environment. If I tell service &lsquo;x&rsquo; to start on port :4321 with <code>datasource.host=my.postgres.com</code> then no matter where I start the service, as long as those two external services are available, service &lsquo;x&rsquo; should be healthy.</p>




<p>Simple right?</p>




<h3>&hellip;do it again&hellip;</h3>




<p>Now we want to start multiple processes of service &lsquo;x&rsquo; on the same machine. We want to do this in order to fully realize the computing potential of our EC2 instance, Digital Ocean droplet, Heroku dyno (insert name of virtual computing resource here) in order to increase availability, performance and return on investment of our infrastructure.</p>




<p>Several key factors need to change in order to realize multiples of the same service on a single machine:</p>




<ol>
<li>Environment or External Configuration of the Application</li>
<li>Port assignments at the application layer</li>
<li>Port assignments at the load balancer to proxy requests</li>
</ol>




<p>We use HaProxy as an internal load balancer to proxy requests to our backend micro services. However, you could accomplish the same task with any kind of proxy. Whether it&rsquo;s <a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/pkg/proxy/loadbalancer.go">written in Go</a> or built on iptables, proxying requests from a single endpoint to multiple instances of service &lsquo;x&rsquo; enables the most basic type of HA via redundancy and increases performance generally.</p>




<p>In the previous example we told service &lsquo;x&rsquo; to start on :4321 but we can&rsquo;t do that twice on the same box, we&rsquo;d have a port collision. So we need to run service &lsquo;x&rsquo;(2) on another port, let&rsquo;s say :4322.</p>




<p>Luckily for us, service &lsquo;x&rsquo; can be externally configured via environment variables or using a plain text file called <code>app.service_x_1-properties</code> and <code>app.service_x_2-properties</code>. In fact, we were already using the app.properties type of external config to set passwords and API tokens service &lsquo;x&rsquo; requires since we didn&rsquo;t want to place those sensitive items, hard coded, in our github repository. So we simply modify the app.properties file for each service with <code>service.port</code> definitions to ensure they startup on :4321 and :4322 respectively.</p>




<h3>Automate it</h3>




<p>Now we have to automate this process, ensuring that service &lsquo;x&rsquo; gets provisioned to a node two times with the correct external config. That&rsquo;s easy enough since our tool (puppet, chef, whatever) can take a simple hash of external config for each instance of service &lsquo;x&rsquo; and write that app.properties file on the box. We can use the same hash, or at least the <code>service.port</code> part, to configure haproxy.cfg on another node, ensuring our service proxy is properly configured.</p>




<p>Success! We have vertically scaled our service!</p>




<h3>Orchestrate it</h3>




<p>We could call this success, but does it scale? Let&rsquo;s recap.</p>




<p>Every time we deploy service &lsquo;x&rsquo; or service &lsquo;a&rsquo;, service &lsquo;y&rsquo; or service &lsquo;b&rsquo;, we have to manually assign ports in configuration management to be written to a text file on a node running that service. We now have not 1 but 4 services (&lsquo;x&rsquo;,&lsquo;y&rsquo;,&lsquo;a&rsquo;, and &lsquo;b&rsquo;) each requiring a known range of port assignments so we can simultaneously configure the application port in external config and the port assignment for the server in haproxy.cfg.</p>




<p>Those assignments might be a table such as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>service <span class="s1">&#39;a&#39;</span>: 1000-1010
</span><span class='line'>service <span class="s1">&#39;b&#39;</span>: 1011-1020
</span><span class='line'>service <span class="s1">&#39;x&#39;</span>: 1021-1030
</span><span class='line'>service <span class="s1">&#39;z&#39;</span>: 1031-1040
</span></code></pre></td></tr></table></div></figure>




<p>This is usable, and it &ldquo;scales&rdquo; to a maximum of 10 nodes since our known port assignment hash goes 10 deep for each service.</p>




<p>Now we have 100 million users, and we need to scale our application&rsquo;s backend services &lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;x&rsquo; and &lsquo;y&rsquo; to <strong><em>FAR</em></strong> more than 10 instances a piece. In fact, we not only need to scale those to more instances, upper management asked us to add features. These features came by adding services &lsquo;c&rsquo;, &rsquo;d&#8217;, &lsquo;e&rsquo;, &lsquo;f&rsquo; and &lsquo;z&rsquo;. We have to build a port assignment hash for those as well, and it would be great if this distributed micro-service was also highly available beyond just a single node running multiple instances, so we&rsquo;re going to ensure that services &lsquo;a&rsquo; - &lsquo;f&rsquo; and &lsquo;x&rsquo; - &lsquo;z&rsquo; are running a minimum of 50 processes a piece across a minimum of 3 virtual machines.</p>




<p>Now we&rsquo;ve got:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>service <span class="s1">&#39;a&#39;</span>: 1000-1050
</span><span class='line'>service <span class="s1">&#39;b&#39;</span>: 1051-1100
</span><span class='line'>service <span class="s1">&#39;c&#39;</span>: 1101-1150
</span><span class='line'>service <span class="s1">&#39;d&#39;</span>: 1151-1200
</span><span class='line'>service <span class="s1">&#39;e&#39;</span>: 1201-1250
</span><span class='line'>service <span class="s1">&#39;f&#39;</span>: 1251-1300
</span><span class='line'>service <span class="s1">&#39;x&#39;</span>: 1301-1350
</span><span class='line'>service <span class="s1">&#39;y&#39;</span>: 1351-1400
</span><span class='line'>service <span class="s1">&#39;z&#39;</span>: 1401-1450
</span></code></pre></td></tr></table></div></figure>




<p>Great, we can scale out to 50 instances of each service. Now all I need to do is write all the configuration management code to deploy each one&hellip; each one of <strong><em>450</em></strong> instances across all services.</p>




<p>I call this &ldquo;scaling&rdquo; not scaling.</p>




<h3>$PORT</h3>




<p>This process would be so much easier if we could just run these services on $PORT and have our load balancer &ldquo;just know&rdquo; what that $PORT assignment was, reconfigure itself dynamically, and automagically proxy requests to all our services, no matter how many instances are running. That&rsquo;s the dream I call scaling and is made possible by containers.</p>




<h3>Containers</h3>




<p>The cool thing about containers is they&rsquo;re not only self-contained instances of your application, they&rsquo;re self-contained networks. And the most commonly used LXC wrapper, Docker, ships with its own <a href="https://docs.docker.com/articles/networking/">network proxy</a> to handle port forwarding and routing into and out of a container to the host machine. Docker also allows us to pass in environment variables to the container, environment variables that are as segregated in a similar way to being in separate sub shells. We can leverage both these facets of containers along with new frameworks to orchestrate them (such as Kubernete and Mesosphere).</p>




<p>Those frameworks can assign ephemeral $PORT mappings for our services, as long as each service <a href="https://docs.docker.com/reference/builder/#expose">EXPOSE</a>&rsquo;s and is configured within the container to run on their given port (each service now only needs a single port mapping since it&rsquo;s executed in it&rsquo;s own network, proxied via $PORT to the host), then those frameworks have their own independent way of load balancing requests to the service.</p>




<p>For example, if you run <code>docker ps</code> and service &lsquo;x&rsquo; is running you might see:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>CONTAINER ID        IMAGE             COMMAND  CREATED             STATUS              PORTS                   NAMES
</span><span class='line'>d7588285b831        service_x:0.5.1   <span class="s2">&quot;java&quot;</span>   <span class="m">57</span> minutes ago      Up <span class="m">57</span> minutes       0.0.0.0:1322-&gt;1301/tcp  stoic_elion
</span></code></pre></td></tr></table></div></figure>




<p>and in <code>netstat</code> you would see something akin to:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::1132      :::*      LISTEN      4743/docker-proxy
</span></code></pre></td></tr></table></div></figure>




<p>We don&rsquo;t need a range of port mappings; we need a single mapping. <code>docker-proxy</code> is proxy&#8217;ing the requests from the host on port 1322 to the container where the service is listening on a base port of 1301.</p>




<p>Instead of writing hundreds of lines of configuration management code, we need to build an atomic container and execute it with <code>-p 1322:1301</code>. Orchestration frameworks reduce the configuration further by taking care of the port mapping: basically running <code>-p $PORT:1301</code>.</p>




<p>Those same orchestration frameworks then update a named load balancer to proxy the request to the correct ephemeral $PORT mapping for your service. Magic.</p>




<p>You don&rsquo;t need to manage CM code for each individual service, you need to have a CI job that builds new containers with each release of your service and track only the version tag you want running in your environment.</p>




<p>Might I add that scaling is as easy as POST&#8217;ing to the Mesos master the number of containers you want running for a given service or POST&#8217;ing an updated Replication Controller (RC) in Kubernetes. Although scaling an application is simplified once these frameworks are in place, putting them to use in production is anything but.</p>




<h2>CAP Theorem for Scaling</h2>




<p>This should be simple is a common platitude outside the hallways of backend engineering. Because vendors and white papers spoon feed the message &ldquo;we make it simple&rdquo;, everyone wants to think their highly available, distributed, micro-service architectures should be &ldquo;simple&rdquo; and cheap and performant all at the same time. Optimistic and forward thinking executives envision simplicity and effort lying along the same continuum.</p>




<p>In reality, simplicity and engineering effort are inversely related. Simplifying an inherently complex system is essential to scale services within it, but actually requires more effort the simpler the system <em>seems</em> to become. This is because system <em>simplification</em> is most commonly implemented with abstraction layers. Tools that abstract these systems by codifying or containerizing small pieces of the system are advertised by venders as &ldquo;easy to implement&rdquo; when in practice integrating features, availability, and performance is rarely the easy task the literature or marketing materials would have you believe.</p>




<p>Don&rsquo;t get me wrong, I&rsquo;m all for simple, and cost savings. In fact, I work hard every day to make the most of all system resources by leveraging platforms like docker and container orchestration frameworks. We have some amazing frameworks such as Mesosphere and Kubernete and new frameworks are being created every day, further enabling us to simplify incredibly complex systems. They allow us to minimize codified configuration by atomizing each service; taking the complex orchestration piece and turning it into a scalable solution.</p>




<p>But, like distributed data stores, a back end system generally also obey CAP theorem in terms of cost and complexity; there is always a trade off. Any increase in consistency, availability or partition tolerance increases the cost and complexity of the system, and simplifying it again is tough - somewhere entropy will intrude and suddenly your &ldquo;simple&rdquo; dream is suddenly far more complex. However, these dreams can still be a reality as long as you&rsquo;re using tools to orchestrate the chaos. As we move forward in a containerized world, that&rsquo;s going to be my rule of thumb.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-06-17T12:48:27-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:48 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/05/01/automating-spring-boot-micro-service-deployments/">Automating Spring Boot Micro Service Deployments</a></h2>
  
  <p>
    <p>Spring is a java framework that has been around for the better part of a decade. Though some argue it&rsquo;s growing long in the tooth, it&rsquo;s still a standard among large enterprise to smaller startup style web applications. Spring boot is Springs answer to next generation, easy-to-implement, spring setup. Spring boot has a host of advantages over it&rsquo;s legacy counterpart, chef among them packaging up your application in jar file format vs. war file format, embedded tomcat, and the primary topic of this post: resource configuration based on config files found in the classpath.</p>

<p>This seeminly simple way to configure an application provides a much needed interface for operations to successfully automate a spring application across heterogenious environments. y Since spring is Java-based we have the typical players we can roll in our init script to tune things JVM-related: XMX/XMS are key. We can also pass in active profiles, or groupings of configuration that override any application property files which in turn set &ldquo;defaults&rdquo; for a given deployment.</p>

<p>Typical Sping-based deployments suffer from configuration being hard coded into the application properties files of the code repository. This is great for modularizing your code base so it can be transported to multiple environmnets. However it ensures your code also has clear text passwords, api keys and other data that shouldn&rsquo;t be in a VCS repo or distributed in any way.</p>

<p>In order to lock down the security of the code base itself we decided to externalize all the passwords, api keys and other confidential data from our code base. Spring makes it remarkably easy to do this, providing the options to specify configuration as environment variables at boot or specify external application property files to an init script or CLI call.</p>

<h2>Method 1: External App Properties</h2>

<p>First, lets talk about how we provision a node that runs our backend Spring services. Everything is managed with Puppet, which allows us to take advantage of encrypted YAML as a datasource via <a href="https://docs.puppetlabs.com/hiera/1/">Hiera</a>. We wrote a module around the deployment of our Spring services which takes care of the absolute neccessities for the proper configuration of our service. Via this module we&rsquo;re able to implement:</p>

<ul>
<li>Securely pulling the jar file from S3 with an ephemeral IAM user using the <a href="https://github.com/malnick/puppet-s3">S3 module</a> given a specific $version</li>
<li>Deploying the service to /opt/sourceclear/$service/$service.jar and symlinking the versioned jar to the executed inode</li>
<li>Logstash &amp; logrotate configuration for the service</li>
<li>Exported balancermember resources for Haproxy for each process of each service that is running on a $node</li>
<li>Externalized application-$app.properties file specifying the passwords, api keys and other encrypted data from eYaml</li>
<li>An init script for init.d which runs &lsquo;n&rsquo; number of processes specified by the $proc_opts hash sc_services::services defined type.</li>
<li>Configure application metric monitoring for New Relic</li>
<li>Define JVM Heap size for each process</li>
</ul>


<p>A typical service might have the following deployment in Puppetland:</p>

<pre><code class="ruby">class profiles::sc_services::some_service ( $version ){

  $properties_file = {
    'rabbitmq.password' =&gt; hiera('qa::rabbitmq_password'),
    'mandrill.api.key'  =&gt; hiera('qa::mandrill_api_key'),
  }

  # The main service definition
  sc_services::service { $some_service:
    deploy_stage        =&gt; 'qa',
    version             =&gt; $version,
    enable_newrelic_apm =&gt; true,
    loadbalancer_role   =&gt; 'qa_internal',
    xmx_setting         =&gt; '512',
    xms_setting         =&gt; '512',
    proc_opts           =&gt; {
      '1'  =&gt; {
        'env_profile' =&gt; 'qa',
        'port'        =&gt; '55000',
        'mgmt_port'   =&gt; '55010',
        'override'    =&gt; $properties_file,
      },
      '2'  =&gt; {
        'env_profile' =&gt; 'qa',
        'port'        =&gt; '55001',
        'mgmt_port'   =&gt; '55011',
        'override'    =&gt; $properties_file,
      }
    }
  }
}
</code></pre>

<p>This configuration will boot a node with an init script managing 2 Java processes for $service. Each prcess gets it&rsquo;s own exported balancermember resource for our internal haproxy in the environment &lsquo;qa&rsquo; as well as New Relic APM monitoring, and most importantly an externalized configuration built from data in git that is encrypted.</p>

<h2>Method 2: Environment Variables</h2>

<p>Since Sping allows you to also override any configuration as ENV variables it makes it incredibly easy to roll this service into a docker container:</p>

<pre><code class="ruby">  $rabbitmq_password  = hiera('rabbitmq_password')
  $mandrill_api_key   = hiera('mandrill_api_key')

  $env_variables = [
    "rabbitmq.password=${rabbitmq_password}",
    "mandrill.api.key=${mandrill_api_key}",
  ]

  docker::run { 'some_service':
    image           =&gt; "our_priv_registry:5000/some_service-${version}",
    ports           =&gt; ['55010'],
    expose          =&gt; ['55010'],
    env             =&gt; $env_variables,
    restart_service =&gt; true,
    privileged      =&gt; false,
    pull_on_start   =&gt; true,
  }
</code></pre>

<p>Now we can toss out an on-system properties file and keep the secure passwords purely in the context of the shell which they are executed. This furthers security as the passwords are never actually written to the system, they can not be copied or read from disk as it were.</p>

<p>Of course, this simple docker example doesn&rsquo;t run multiples of the service but we could easily write a small module around docker which does. However, our Docker deployment is more about moving towards mesosphere as our service execution framework. This way, configuration management will not be used at all for booting and running our Docker containers. Instead, we&rsquo;ll be POSTing the container, the number of instances, and ENV variables to a a Mesos master which will manage the service discovery, runtime persistance and aggregation of the services in our AWS deployment.</p>

  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-05-01T10:05:30-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:05 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/04/15/factory-patterns-rule-number-1/">Factory Patterns: Rule #1</a></h2>
  
  <p>
    <h1>Factory Patterns</h1>




<p>I learned early on in my career that the trick to successfully maintaining large, complicated deployments was to make things so that they are like a factory, then solve your problems using factory patterns. The metaphor is extended from the continuous integration pipelines I develop for seamless code deploys to the ways in which I go about maintaining the infrastructure on which that code runs.</p>




<h3>Rule #1</h3>




<p>Rule #1, the litmus test for your infrastructure: can you deploy your nodes into any cloud platform with out a SSH key and have your entire application up and running, zero intervention required?</p>




<p>Rule #1 requires skillfully built configuration management code. It doesnt matter what configuration management system you use as long as it satisfies the prerequisite that you can deploy your entire stack and never have to SSH into the box.</p>




<p>Now Id also add that the code you write which abstracts the configuration of any machine should be clear enough that any person who comes into your organization, either with you or after you leave, be able to understand the complete configuration of a machine by simply looking at your CM code, most notably the $role manifest or recipe.</p>




<p>This syntax-ual sugar isnt required for Rule #1 to be successful but plays a key role in ensuring the agile process of CM doesnt become the burden of every other systems engineer in your organization. Good configuration management code should be abstract enough that any developer in your organization can understand the deployment of their code based on a given $role and every systems &amp; operations engineer can find clues as to where to look when things go astray by looking at that same CM code block.</p>




<h3>The Pattern</h3>




<p>A good factory is like a state machine, for a given input it produces a given output. Infrastructure is the same way, the inputs are straightforward: bare metal provisioning + configuration management + service discovery. These three inputs are generated in different ways but no matter what are always conceptually similar.</p>




<h4>Bare Metal</h4>




<p>Regardless of if youre deploying in vCenter, AWS, Heroku or DigitalOcean you have a concept of a VM / Instance / Dyno / Droplet. Each platform has its own way of managing the deployment of those pieces, but the end result is similar: abstracted bare metal provisioning.</p>




<h4>Configuration Management</h4>




<p>Once the bare metal piece is in place the next stop in the factory is configuration management. Chef, Puppet, Ansible, and others all share a common thread: abstract away the notion of resources on a machine ($package, $file, $service) regardless of operating system or deployment environment and be able to declare those resources in an easy to understand way.</p>




<p>Puppet uses its own DSL for CM based on Ruby, Chef uses its own Ruby libraries, Salt uses the YAML interchange format as well as Ansible. The idea at this point in the factory is to implement a system that abstracts away how to provision a resource on a machine and instead simply require that resource exist in a specific way.</p>




<p>So a user can be defined as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Puppet</span>
</span><span class='line'><span class="n">user</span> <span class="p">{</span> <span class="err"></span><span class="n">jeff</span><span class="err"></span><span class="p">:</span> <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Chef</span>
</span><span class='line'><span class="n">user</span> <span class="err"></span><span class="n">jeff</span><span class="err"></span> <span class="k">do</span> <span class="n">action</span> <span class="ss">:create</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ansible</span>
</span><span class='line'><span class="o">-</span> <span class="ss">user</span><span class="p">:</span> <span class="nb">name</span><span class="o">=</span><span class="n">jeff</span>
</span></code></pre></td></tr></table></div></figure>




<p>This abstraction enables the operations person to automate the deployment of resources to a given machine, in this example the user jeff, without having to worry about <strong>how to provision</strong> - the idea being, you dont need to tell the computer how to make the user jeff, you simply declare it in your manifest/recipe/playbook and youre done.</p>




<p>Now this is an incredibly simple task, a single user. When youre talking about tens of thousands of resources that may be compiled into a given catalogue to be processed on the node there are a lot of other considerations you have to take into account such as ensuring each step in the process is idempotent (you dont execute a resource if the state of the machine already matches); ensuring the catalogue is a-cyclic (no resource dependencies create loops).</p>




<p>At the end of the day this entire, highly complicated process, should be easily readable and understood at its highest layer of abstraction, i.e., some sort of role manifest/recipie that takes all those resources and wraps them into a value that conveys the business logic of what that code does.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Puppet</span>
</span><span class='line'><span class="c1"># $confdir/modules/role</span>
</span><span class='line'><span class="k">class</span> <span class="ss">role</span><span class="p">:</span><span class="ss">:qa_haproxy_frontned</span> <span class="p">{</span> <span class="err"></span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Chef</span>
</span><span class='line'><span class="c1"># ~/chef-repo/roles/qa_haproxy_frontend/role.rb</span>
</span><span class='line'><span class="nb">name</span> <span class="err"></span><span class="n">qa_haproxy_frontend</span><span class="err"></span>
</span><span class='line'><span class="n">description</span> <span class="err"></span><span class="no">The</span> <span class="n">outer</span> <span class="n">most</span> <span class="n">layer</span> <span class="n">of</span> <span class="n">the</span> <span class="no">QA</span> <span class="no">Haproxy</span> <span class="n">frontend</span> <span class="no">CM</span> <span class="n">code</span><span class="err"></span>
</span><span class='line'><span class="n">run_list</span> <span class="p">(</span><span class="s2">&quot;recipe[qa_haproxy_frontend])</span>
</span></code></pre></td></tr></table></div></figure>




<p>All things being equal the end goal is abstraction. The CM factory should make simple the increasingly complicated step of provisioning a node in a specific way. The code should be elegant, readable and maintainable. The output should be a working machine with a repeatably deployable state.</p>




<h4>Service Discovery</h4>




<p>The last piece to the puzzle is service discovery. This piece, previously thought of as optional for most deployments is becoming more of  a main stay due to the design principles of service oriented architecture. SOA ensures we have many services to maintain, sometimes many instances of that service on a given node, each satisfying a specific feature of the application. In some ways SOA makes more simple the maintenance of the product, such as enabling developers to easily deploy code changes to a specific service which may not completely break the overall usability of the application if something goes wrong during a code change.</p>




<p>From a systems engineering perspective it enables easier scaling in that you can scale a specific service rather than the entire monolithic code base to meet the demands of an increasing user base. However, how the scaling occurs is the complicated part of this final stop in the factory. Everything from assigning a port for the service process to listen on to ensuring the service actually exists and is healthy is complicated to say the least.</p>




<p>ZooKeeper, ETCd and other service discovery tools allow a single point of contact for each service to reach out to in order to feed those metrics back to a master process and in some cases do some basic configuration management based on information from those systems. However, these tools also ensure a single point of failure which is why ZooKeeper takes high availability seriously. The uptime of those service discovery tools also relies on other tools such as DNS or other hostname resolution mechanisms, thereby increasing not only the complexity of your deployment by one tool but rather by a number of tools.</p>




<p>Implementing successful service discovery for your SOA is not for the faint of heart. More tools are coming out that bundle up ZooKeeper in a larger framework that abstracts these finer details. For example Mesosphere bundles the Mesos and Zookeeper projects with a distributed init and process management framework called Chronos and Marathon. Marathon can receive a POST with a specific docker image in a cloud or locally hosted registry along with information such as how many containers it needs to boot across your infrastructure. Mesosphere aims to abstract away the complicated task of port assignment and is this service running to ensure you alway have n number of services up, and if you need n more it makes it as easy as a POST or input via the web UI.</p>




<p>Synapse and Nerve also serve a similar end goal: deploy service x n number of times; ensure service x is healthy, and if not, remove service x from rotation and deploy another to replace it. Simple right?</p>




<h3>In the end</h3>




<p>In the end, Rule #1 still stands: can you deploy your entire application stack from bare metal to fully operational in one command and with out having to use SSH to get into a node?</p>




<p>The final output of the factory should be your working web application. You should never have to SSH into any node: metrics and log data should be shipped off each node routinely using tools like Logstash and StatsD - SSHing because you needed to run free -h or tail f /var/log/whatever.log isnt scalable. Imagine running 10 services, each one dumping docker logs to a /var/log/service_instance, across 100 nodes. Are you going to SSH into each one and tail? Fuck no. Youre going to need a consolidated place where each log gets turned into usable metrics for inspection via graphs or search.</p>




<p>Same goes for metrics.</p>




<p>Your configuration management should provision these log and metric aggregation services at boot so theyre just there the next time you log into whatever system you use to aggregate this data. Sound logrotate policies should be in place to ensure you dont blow up /var/log. Alerting mechanisms based on derived metrics should be in place to ensure when things do break and you <strong>absolutely</strong> have to SSH into that box with your dusty SSH key that you know exactly where to look and the alarm didnt sound because the APM metric for the app was based on a hard limit. Limits are never hard, theyre derived from rolling averages, but thats fodder for a future post.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-04-15T10:32:31-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:32 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/03/17/jenkins-puppet-ci/">jenkins-puppet-CI</a></h2>
  
  <p>
    <h1>SRC:CLR Deploy - Merge-to-Master -> Jenkins -> Puppet</h1>




<p>At SRC:CLR we used to use Opsworks to deploy our code pipeline. Opsworks is great but is overloaded with a lot of extra things that we don&rsquo;t need or want. It also doesn&rsquo;t allow us to fully open our code pipeline to outside applications in the way we wanted.</p>




<p>In order to give our devs the easist way to deployment, we setup a pipeline from merge-to-master to deploy that encompasses the peer review process, java unit tests, and of course Puppet.</p>




<p>If you don&rsquo;t want to read the post, we&rsquo;ve open sourced the code for <a href="https://github.com/malnick/jenkins-puppet-webhook.git">this webhook</a>.</p>




<h2>The 10,000 Mile View</h2>




<ol>
<li>A developer submits a PR to merge to master from a dev branch</li>
<li>Her peers review this PR and accept the merge to master</li>
<li>Jenkins watches this repo, and starts a build on that branch</li>
<li>If all tests pass, the jar file is sent to s3: <code>service-$version.jar</code></li>
<li>A post build shell script runs that sends a POST with data about the buid to our puppet master</li>
<li>The webhook on the master accepts this POST and uses the data to:</li>
<li>Update hte version of the service in Hiera</li>
<li>Update the git repo where the data file that tracks versions exists (in this case the puppet control repo with hiera data)</li>
<li>Run mCollective to update all nodes matching the role which the service runs on</li>
<li>The node(s) check in with the master, and diff the versino in the title of the S3 resource for the service jar file</li>
<li>See the version has changed (since we updated it in hiera) the agent pulls down hte new jar file with version $version</li>
<li>The agent restarts the services</li>
</ol>




<h2>The More Intimate View</h2>




<p>This sinatra hook sits on a Puppet Master and listens for POSTs on :1015, when hit with a payload it updates the version number of a service in Hiera data and executes a mCollective call to run puppet on the node with a matching $::role value.</p>




<p>This is great when used in conjunction with <a href="https://github.com/malnick/puppet-s3">puppet-s3</a> provider or something similar where you can classify the resrouce like</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3</span> <span class="p">{</span> <span class="s2">&quot;/path/to/service-${version}&quot;</span><span class="p">:</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<p>Then, using our webhook or a modified version of it, you can have a one click deploy in Jenkins since this hook will update the version in Hiera data that the <code>s3</code> resource is diff&#8217;ing from and execute mCollective to run puppet on the node matching a specific role - i.e., the role that classifies the node running the service being built by jenkins and pulled down by the <code>s3</code> resrouce.</p>




<h3>How it&rsquo;s done&hellip;</h3>




<p>Lets say you wanted to use the <a href="https://github.com/malnick/jenkins-puppet-webhook.git">open sourced</a> webhook and integrate it with your environment, here&rsquo;s what you need to know:</p>




<h4>A few assumptions:</h4>




<ol>
<li>The payload from Jenkins, or whatever tool you&rsquo;re using to hit this hook, will pass the following parameters:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;service&quot;</span><span class="p">:</span>      <span class="s2">&quot;your_name_in_hiera_data&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;environment&quot;</span><span class="p">:</span>  <span class="s2">&quot;your_environment&quot;</span><span class="p">,</span>               <span class="err">#</span> <span class="err">qa</span> <span class="err">or</span> <span class="err">production?</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span>      <span class="s2">&quot;service_version_being_deployed&quot;</span><span class="p">,</span> <span class="err">#</span> <span class="err">you&#39;ll</span> <span class="err">want</span> <span class="err">to</span> <span class="err">dynamicaly</span> <span class="err">generate</span> <span class="err">this</span> <span class="err">in</span> <span class="err">jenkis</span>
</span><span class='line'>  <span class="nt">&quot;role&quot;</span><span class="p">:</span>         <span class="s2">&quot;role_of_node_in_puppet&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li>The Hiera data key matches the following pattern:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Overlay with vars from JSON</span>
</span><span class='line'><span class="l-Scalar-Plain">${service_name}_version_${environment}</span><span class="p-Indicator">:</span> <span class="s">&#39;1.2.1&#39;</span>
</span><span class='line'><span class="c1"># A real-world example</span>
</span><span class='line'><span class="l-Scalar-Plain">myservice_version_qa</span><span class="p-Indicator">:</span> <span class="s">&#39;1.2.1&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">myotherservice_version_qa</span><span class="p-Indicator">:</span> <span class="s">&#39;1.4.1&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">someservice_version_production</span><span class="p-Indicator">:</span> <span class="s">&#39;0.5.1&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">myservice_version_production</span><span class="p-Indicator">:</span> <span class="s">&#39;1.1.0&#39;</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can override this in the options you pass via the JSON POST with the key <code>key</code>.</p>




<ol>
<li>You&rsquo;ll fork this repo, and update the <code>data_file</code> and maybe the <code>key</code> values in <code>lib/options.rb</code>:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Update</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Options</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:config</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;##### Parsing Options #####&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@config</span>         <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Required data from POST</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:environment</span><span class="o">]</span>    <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;environment&#39;</span><span class="o">]</span>   <span class="c1"># qa or production etc</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:version</span><span class="o">]</span>        <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span>       <span class="c1"># The version to write to the data file</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:service</span><span class="o">]</span>        <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;service&#39;</span><span class="o">]</span>       <span class="c1"># The service name</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:role</span><span class="o">]</span>           <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;role&#39;</span><span class="o">]</span>          <span class="c1"># The role for the nodes to update via mCollective</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Optional data from POST</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span>            <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;key&#39;</span><span class="o">]</span>             <span class="o">||</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@config</span><span class="o">[</span><span class="ss">:service</span><span class="o">]</span><span class="si">}</span><span class="s2">_version_</span><span class="si">#{</span><span class="vi">@config</span><span class="o">[</span><span class="ss">:environment</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:git_repo</span><span class="o">]</span>       <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;git_repo&#39;</span><span class="o">]</span>        <span class="o">||</span> <span class="s1">&#39;git@github.com:malnick/puppet-control&#39;</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:git_repo_dir</span><span class="o">]</span>   <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;git_repo_dir&#39;</span><span class="o">]</span>    <span class="o">||</span> <span class="s1">&#39;/tmp/control&#39;</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">[</span><span class="ss">:data_file</span><span class="o">]</span>      <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="s1">&#39;data_file_path&#39;</span><span class="o">]</span>  <span class="o">||</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@config</span><span class="o">[</span><span class="ss">:git_repo_dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/global.yaml&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;##### Setting configuration #####&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@config</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>        <span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li>You&rsquo;re using a <code>$::role</code> fact. I roll in AWS, so everything is classified based on <code>$::role</code>. This webhook won&rsquo;t be able to run puppet on the node running your service you just updated the version for until you modify this code or get yourself a role face.</li>
</ol>




<h3>Deployment Pattern</h3>




<ol>
<li>Clone the repo to your pupetmaster and make the above suggested changes to make it work with your deployment</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git@github.com:malnick/jenkins-puppet-webhook.git
</span></code></pre></td></tr></table></div></figure>




<ol>
<li>Turn it on:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/webhook start
</span><span class='line'><span class="c"># Should come up on :1015</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li>Have a post-run stage in your jenkins build for a given service that executes something akin to the following:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Assuming you&#39;re running this from $WORKSPACE in jenkins, your paths will vary as well as your method of obtaining the version off the build.</span>
</span><span class='line'><span class="nv">VERSION</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo </span>service/target/service-*.jar | cut -d- -f2 | cut -d. -f1,2,3<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Curl this webhook, which should be on the Puppet Master</span>
</span><span class='line'>curl <span class="se">\</span>
</span><span class='line'>  -X POST <span class="se">\</span>
</span><span class='line'>  -d@- <span class="se">\</span>
</span><span class='line'>  puppet.myorg.com:1015/deploy <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">{</span>
</span><span class='line'><span class="s">  &quot;service&quot;:     &quot;myservice&quot;,</span>
</span><span class='line'><span class="s">  &quot;version&quot;:     &quot;$VERSION&quot;,</span>
</span><span class='line'><span class="s">  &quot;environment&quot;: &quot;qa&quot;,</span>
</span><span class='line'><span class="s">  &quot;role&quot;:        &quot;qa_services_migration&quot;</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Kick off a build&hellip;.</h3>




<p>This should implement the following chain:</p>




<ol>
<li>Build is executed on jenkins</li>
<li>If successful the build drops the new versioned jar or zip file or whatever in S3: <code>myservice-0.2.5.jar</code></li>
<li>If successful the shell post-run is executed, running the above script that gets the new $version and POSTs to our webhook on the puppet master</li>
<li>The webhook updates hiera data with the correct value for the updated version</li>
<li>The webhook updates git to ensure that jenkins owns our versioning</li>
<li>The Webhook executes an MCO call to run puppet on the node running this service based on the <code>$::role</code> fact</li>
<li>The nodes matching the <code>$::role</code> get the updated version in hiera data and match that against the <code>s3</code> resource in that:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">s3</span> <span class="p">{</span> <span class="s2">&quot;${basedir}/${service}-${version}.jar&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">ensure</span>            <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>    <span class="n">source</span>            <span class="o">=&gt;</span> <span class="s2">&quot;/my_bucket/${service}-${deploy_stage}/${service}-${version}.jar&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">access_key_id</span>     <span class="o">=&gt;</span> <span class="vg">$access_key_id</span><span class="p">,</span>
</span><span class='line'>    <span class="n">secret_access_key</span> <span class="o">=&gt;</span> <span class="vg">$secret_access_key</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">require</span>           <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="vg">$basedir</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<p>Where <code>$version</code> is derived from</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$service</span> <span class="o">=</span> <span class="s1">&#39;my_service&#39;</span>
</span><span class='line'><span class="vg">$version</span> <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="n">my_service_version_qa</span><span class="p">)</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Some Closing Remarks&hellip; or why this is rad</h2>




<p>Your devs should never have to worry about depoying code, they have enough to worry about in writing it. The pipeline that is built around deployment should be mind numbingly simple for them to implement. Merge-to-master is scary for a lot of reasons. Automating the updating of values in Hiera is scary for a lot of reasons. At the end of the day however, those are my problems and not the developers. My job is to make efficient pipelines for our product, and the release pipeline is the purest incarnation of that. We think this is pretty rad, and if you want to play along and fork our public repo and submit some PR&rsquo;s we&rsquo;d love to hear from you.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-03-17T17:05:41-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:05 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/03/11/logging-analytics/">Logging Analytics</a></h2>
  
  <p>
    <p>Whats the first line of action when dealing with a service that is down? Logs.</p>




<p>You can <code>ps ef</code>, <code>netstat aux</code> all day long but the big piece of information cake always lies in the log data. Log data carries the weight of information about your services, whether its a Spring Boot micro service powering a small piece of your backend platform or the NGINX and auth logs that convey what is happening on the opposite end of your application stack.</p>




<p>Whatever the situation may be, logs are always the files we end up tailing to figure out what is happening and why.</p>




<h2>Why tailing sucks</h2>




<p>True story: <code>grep -ir 404 * | wc -l</code> or <code>grep -irl 404 *</code> or <code>grep -r 404 * | sort | uniq -c</code></p>




<p>Sure, you might have some good feedback from this. Sure, you can plug this into a tool like nagios to alert you when things hit the fan.</p>




<p>But, its missing a critical piece: visualization.</p>




<p>You cant <strong>see</strong> the log data on a time-based graph; you cant correlate it to large logging events based on message type, log path or node. Youre only aggregating a single log at a time, and the information</p>




<h2>How SRC:CLR Tracks Logging Data</h2>




<p>At SRC:CLR we use Logstash, Redis, Elasticsearch and Kibana to capture log data from various services that we use including our Sping Boot micro service framework. The overall design looks like this:</p>




<p><img src="http://michael.bouvy.net/blog/wp-content/uploads/2013/11/logstach-archi1.png" alt="aggregation" /></p>




<p>Of course, this entire deployment is brought to you by Puppet Enterprise, and no blog post from me would be complete with out a <a href="https://github.com/sourceclear/puppet-kibana">shameless plug for some new module we wrote to automate this it</a>.</p>




<p>As you can tell, were using Kibana 4.0.0 (as of this post, 4.0.1 is out and IS amazing but were not using it quite yet). Kibana 4x ships with its own server, so theres no need to frontend it with NGINX or Apache anymore. However, I highly recommend at minimum a local NGINX reverse proxy so you can DNS the node and connect on 80 or 443 if its public-facing.</p>




<h3>Logstash Agent Configuration</h3>




<p>In our role for a given node, lets say a backend node that would be running our micro services, I can simply add some logstash configuration:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">roles</span><span class="p">:</span><span class="ss">:backend_services</span> <span class="p">{</span>
</span><span class='line'><span class="err"></span>
</span><span class='line'>  <span class="c1"># Logstash for services</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="o">::</span><span class="ss">profiles</span><span class="p">:</span><span class="ss">:logstash</span><span class="o">::</span><span class="n">backend_services</span><span class="p">:</span>
</span><span class='line'>        <span class="n">redis_logstash_host</span> <span class="o">=&gt;</span> <span class="err"></span><span class="n">our</span><span class="o">-</span><span class="n">redis</span><span class="o">-</span><span class="n">aggregator</span><span class="o">.</span><span class="n">ourdomain</span><span class="o">.</span><span class="n">com</span><span class="err"></span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="err"></span>
</span><span class='line'><span class="c1"># More configuration</span>
</span></code></pre></td></tr></table></div></figure>




<p>And then our backend services profile for logstash, we do something like:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:logstash</span><span class="o">::</span><span class="n">backend_services</span> <span class="p">(</span><span class="vg">$redis_logstash_host</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;logstash&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">package_url</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://download.elasticsearch.org/logstash/logstash/packages/debian/logstash_1.4.2-1-2c0f5a1_all.deb&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="ss">logstash</span><span class="p">:</span><span class="ss">:configfile</span> <span class="p">{</span> <span class="s1">&#39;output_redis&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;profiles/logstash/output_redis.erb&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">order</span>   <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="ss">logstash</span><span class="p">:</span><span class="ss">:configfile</span> <span class="p">{</span> <span class="err"></span><span class="n">micro_service_one_input</span><span class="err"></span><span class="p">:</span>
</span><span class='line'>        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="err"></span><span class="n">profiles</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">input_micro_service_one</span><span class="o">.</span><span class="n">erb</span><span class="err"></span><span class="p">),</span>
</span><span class='line'>        <span class="n">order</span>   <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="ss">logstash</span><span class="p">:</span><span class="ss">:configfile</span> <span class="p">{</span> <span class="err"></span><span class="n">micro_service_two_input</span><span class="err"></span><span class="p">:</span>
</span><span class='line'>        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="err"></span><span class="n">profiles</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">input_micro_service_two</span><span class="o">.</span><span class="n">erb</span><span class="err"></span><span class="p">),</span>
</span><span class='line'>        <span class="n">order</span>   <span class="o">=&gt;</span> <span class="mi">11</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="err"></span>
</span></code></pre></td></tr></table></div></figure>




<p><code>$redis_logstash_host</code> simply needs to be available in the variable namespace for the redis output template.</p>




<p>When it comes to logstash, all the magic happens in those templates. For SRC:CLR, we roll with a few basic inputs and outputs in our logstash templates:</p>




<h4>Log Path Input</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># input_micro_service_one.erb</span>
</span><span class='line'><span class="n">input</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">file</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">path</span> <span class="o">=&gt;</span> <span class="err"></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">service_name</span><span class="o">/</span><span class="n">service_name</span><span class="o">*.</span><span class="n">log</span><span class="err"></span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h4>Redis Output</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">output</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">redis</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;%= @redis_logstash_host %&gt;&quot;</span>
</span><span class='line'>        <span class="n">data_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;list&quot;</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=&gt;</span> <span class="s2">&quot;logstash&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h4>ElasticSearch Output</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">output</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">elasticsearch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cluster</span> <span class="o">=&gt;</span> <span class="s1">&#39;logstash&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h4>The Final <code>logstash/conf.d/logstash.conf</code> File</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">input</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">file</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="err"></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">service_name</span><span class="o">/</span><span class="n">service_name</span><span class="o">*.</span><span class="n">log</span><span class="err"></span><span class="o">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">input</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">file</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">path</span> <span class="o">=&gt;</span> <span class="err"></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">service_name</span><span class="o">/</span><span class="n">service_name</span><span class="o">*.</span><span class="n">log</span><span class="err"></span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">output</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">redis</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">host</span> <span class="o">=&gt;</span> <span class="err"></span><span class="n">our</span><span class="o">-</span><span class="n">redis</span><span class="o">-</span><span class="n">aggregator</span><span class="o">.</span><span class="n">ourdomain</span><span class="o">.</span><span class="n">com</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">        data_type =&gt; &quot;</span><span class="n">list</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">        key =&gt; &quot;</span><span class="n">logstash</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">    }</span>
</span><span class='line'><span class="s2">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>So far, weve covered our log pipeline from <code>micro_services_node -&gt; redis_output</code>. What does the configuration for our redis aggregator look like?</p>




<p>It starts, as usual, with the role:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">roles</span><span class="p">:</span><span class="ss">:logging_aggregator</span>  <span class="p">{</span>
</span><span class='line'>    <span class="c1"># First, provision our ELK Stack</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="o">::</span><span class="ss">profiles</span><span class="p">:</span><span class="ss">:elasticsearch</span><span class="o">::</span><span class="n">log_aggregator</span><span class="p">:}</span>
</span><span class='line'>    <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="o">::</span><span class="ss">profiles</span><span class="p">:</span><span class="ss">:kibana</span><span class="o">::</span><span class="ss">basic</span><span class="p">:}</span>
</span><span class='line'>    <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1"># The logstash node needs to be an indexer reading from redis, dumping into elasticsearch</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="o">::</span><span class="ss">profiles</span><span class="p">:</span><span class="ss">:logstash</span><span class="o">::</span><span class="n">redis_indexer</span><span class="p">:}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Also, a basic redis instance</span>
</span><span class='line'>    <span class="kp">include</span> <span class="o">::</span><span class="ss">profiles</span><span class="p">:</span><span class="ss">:redis</span><span class="o">::</span><span class="n">basic</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>As you can probably tell, were rolling the entire ELK stack and redis queue on a single node. We can do this because its on a c3.3xlarge AWS instance type with its own EBS attached volume of 100GB and the logging data is coming from a small-ish stack.</p>




<p>Our logging volume at the time of this post is about 4GB per day, per environment (QA, Prod, etc..). Flushing your elasticsearch indices and backing them up is highly recommended. There are <a href="https://github.com/imperialwicket/elasticsearch-logstash-index-mgmt">various</a> ways to do this sort of thing, but really the end goal is simple: get to 65% of EBS volume, then flush and back up to a persistent source.</p>




<p>I recommend a datastore in your cluster such as MongoDB or tar.gzs to S3. Either way, its amazing how much log data you can generate, and ours is a small infrastructure so your milage will vary.</p>




<p>Eventually youll have to tackle the question: do I scale this vertically or horizontally. With elasticsearch in the mix the answer is simple: horizontally. ES has <a href="http://www.elastic.co/guide/en/elasticsearch/guide/current/optimistic-concurrency-control.html">optimistic concurrency control</a> and is particularly well suited for clustering.</p>




<p>For Redis, youll have to <a href="http://redis.io/topics/cluster-spec">make a personal decision</a>, but I typically prefer a vertical scale, which is why our aggregation node is a c3.2xlarge and will probably grow.</p>




<h3>Logstash Aggregator Configuration</h3>




<p>Finally, we have the logstash aggregator. Im not going to dive into its elasticsearch or redis configuration since <a href="https://github.com/elastic/puppet-elasticsearch">both those</a> tools are well <a href="https://forge.puppetlabs.com/fsalum/redis">documented</a>. Here, we&rsquo;ll focus on the logstash/redis aggregator configuration.</p>




<p>I will however note the importance, again, of using an EBS volume for your ES data!</p>




<p>From the role profile given above, lets take a look at <code>::profiles::logstash::redis_indexer</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:logstash</span><span class="o">::</span><span class="n">redis_indexer</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;logstash&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">package_url</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://download.elasticsearch.org/logstash/logstash/packages/debian/logstash_1.4.2-1-2c0f5a1_all.deb&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># This template contains everything we need to run the indexer on a single host</span>
</span><span class='line'>    <span class="ss">logstash</span><span class="p">:</span><span class="ss">:configfile</span> <span class="p">{</span> <span class="s1">&#39;redis_indexer&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">content</span> <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;profiles/logstash/redis_indexer.erb&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">order</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Where the redis_indexer.erb looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">input</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">redis</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>        <span class="n">data_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;list&quot;</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=&gt;</span> <span class="s2">&quot;logstash&quot;</span>
</span><span class='line'>        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">json</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">output</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">elasticsearch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">stdout</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>You might notice the stdout output in that. The stdout is great for debugging stuff. When you run <code>logstash service start</code> itll startup as a daemon and you can <code>tail -f /var/log/logstash.log</code> but I prefer to run it in the foreground when Im hooking everything up to see all the pretty colors and to drop it into debug mode.</p>




<p>To do this I execute on both the nodes Im pulling logs from and the log aggregator:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">/opt/</span><span class="n">logstash</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">logstash</span> <span class="o">-</span><span class="n">f</span> <span class="sr">/etc/</span><span class="n">logstash</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">logstash</span><span class="o">.</span><span class="n">conf</span> <span class="err"></span><span class="n">debug</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Redis Data Persistance</h3>




<p>An important note on Resis is that it will, <a href="http://redis.io/topics/persistence#redis-persistence">by defualt</a>, persist data every few minutes depending on load. There is some solid <a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">information</a> out there around best ways to protect your data and ensure durability. However, the end goal with this setup is to use Redis as a broker for our log data, not to persist that data as those goals are achieved with Elasticsearch. For this log aggregator I turn off all data persistance in Redis so data only persists in memory. You cna choose what is best for you, but I&rsquo;m not as concerned with durability here as some other situations.</p>




<p>My redis configuration for this now looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:redis</span><span class="o">::</span><span class="n">log_aggregator</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="o">::</span><span class="ss">redis</span><span class="p">:</span>
</span><span class='line'>      <span class="n">redis_saves</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Note: using this <a href="https://github.com/thomasvandoren/puppet-redis">Redis</a> module.</p>




<h2>Final Notes</h2>




<p>Once this pipeline is executed you can go ahead and open <code>our-redis-aggregator.ourdomain.com:5601</code> in your browser and start making some fancy graphs:</p>




<p><img src="https://s3.amazonaws.com/srcclr-public/Screen+Shot+2015-03-11+at+10.15.51+AM.png" alt="one" />
<img src="https://s3.amazonaws.com/srcclr-public/Screen+Shot+2015-03-11+at+10.16.26+AM.png" alt="two" /></p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-03-11T21:06:53-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:06 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/02/20/why-devops-isnt-a-job-its-a-culture/">Why DevOps Isn&#8217;t a Job, It&#8217;s a Culture</a></h2>
  
  <p>
    <p>DevOps is not a job, it&rsquo;s a culture. DevOps is a shift in how you decide to manage, deploy, develop, monitor, and interact with your application code and your infrastructure as a whole. DevOps is a holistic approach to enacting the now bankrupt term &ldquo;agile&rdquo; as a method of development and operations engineering in an organization.</p>




<p>At SRC:CLR we have a culture of DevOps that puts me face-to-face with developers everyday. At many companies the &lsquo;DevOps&rsquo; team never sees another dev. In fact, they may not see another operations person either. Usually, when you hear the term &lsquo;DevOps team&rsquo;, that means it&rsquo;s just another siloed group of people in a company, usually focused on automating infrastructure.</p>




<p>At SRC:CLR we roll DevOps in the way it was meant to be rolled: me, &lsquo;Mr. DevOps&rsquo;, sits shoulder to shoulder with our devs. No partitions, no separate team. When we get a Dir. of Engineering I&rsquo;ll be reporting to him, the same as our devs. Our operations are tightly coupled with the development of our code. That coupling ensures everyone is on a flat playing field, pushing towards the same goal.</p>




<p>How does this affect operations and development at SRC:CLR? It&rsquo;s the feedback loop stupid - it&rsquo;s continuous integration of ideas and knowledge of our application and our infrastructure. It creates synergy between how we architect our applications and how we automate and deploy our infrastructure.</p>




<p>True story: last week we had a hard time diagnosing why one of our main services was crashing. At first we thought it was Tomcat not having enough heap space. That helped but didn&rsquo;t fix it from continuing to silently crash. We enabled more robust logging but ended up with massive amounts of java spring output that we started grepping through.</p>




<p>Not useful.</p>




<p>I started looking at the process and realized our current monitoring system wasn&rsquo;t robust. We were using a mixture of New Relic for application and systems monitoring with CloudWatch from AWS. New Relic didn&rsquo;t have any logging data and what we wanted to find was correlation between the generated logs at failure and the process crashing. We didn&rsquo;t have a robust tool to look at the log data.</p>




<p>I started looking at hosted solutions: SumoLogic, Librato + Logstash, loggly. In the end our developers and I agreed that even though Librato has AMAZING graphing capabilities that offloading our logs to a hosted solution was insecure at best. We needed to stand up a solution in our private VPC.</p>




<p>After that lunch meeting I went back to the drawing board and started piecing together some Puppet code around Elasticsearch, Logstash and Kibana that I had started the previous week. In an hour I had an ELK + Redis stack up and running that was pulling down unfiltered log data from the node running the service which was crashing.</p>




<p>If you&rsquo;ve never graphed logging data you&rsquo;re not doing it right.</p>




<p>One of the lead devs on our platform started looking at the graphing output. A lot of it was health checks from HaProxy. Not a problem, I can filter that out on the node using &lsquo;drop{}&rsquo; in logstash. Next up was creating a lot of data on the node. We ran some queries against the service and started looking at the data that was coming in.</p>




<p>Having an interactive face to our logging data in the Kibana dashboard is invaluable. We can find correlations between crashes (on timestamps) and generated logging output. We can use that data to create alerts that go off before the process crashes.</p>




<p>At the end of the day I&rsquo;m an automation guru. The infrastructure that I automate is tightly coupled with our code. Since I have the skills to bring to life the data that the developers generate (in this case logging data) I can help alleviate stress on our infrastructure, create a more performate and stable platform and enable deep insights to how code responds in a fully integrated environment.</p>




<p>This transparency between the code development process and how deployed code behaves is core to DevOps culture. My job is about creating feedback loops for our development team so when things break in a deployed environment we can intelligently respond and iterate faster and smarter.</p>




<p>I can do this in a fully secure VPC or I can develop other methodologies in less secure hosted solutions. Either way, at the end of my day it&rsquo;s my job to ensure we have <code>uptime</code>. By far the best way to achieve that is to embed me in the middle of the development process, enabling fast iteration and seamless feedback between the development and operations ends of the deployment process.</p>




<p>That&rsquo;s why DevOps isn&rsquo;t a job, it&rsquo;s a process in which everyone in engineering participates. DevOps might be in my title as an employee but what it truly represents is SRC:CLR&rsquo;s commitment to blurring the lines between development and operations, enhancing feedback loops in both directions. This ensures more security, higher performance and better &#8220;uptime&#8220;`.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-02-20T07:22:08-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:22 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/02/08/puppet-s3/">Puppet-s3 & Continuous Integration With Puppet, Jenkins and AWS</a></h2>
  
  <p>
    <p>The (puppet-s3)[<a href="https://www.github.com/malnick/puppet-s3">https://www.github.com/malnick/puppet-s3</a>] module.</p>




<p>Usage:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3</span> <span class="p">{</span> <span class="s1">&#39;/path/to/file/on/my/local/filesystem&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="c1"># Required paramters:</span>
</span><span class='line'>    <span class="k">ensure</span>              <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>    <span class="n">source</span>              <span class="o">=&gt;</span> <span class="s1">&#39;/bucket/path/to/object&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">access_key_id</span>       <span class="o">=&gt;</span> <span class="s1">&#39;mysecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">secret_access_key</span>   <span class="o">=&gt;</span> <span class="s1">&#39;anothersecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="c1"># Optional parameters:</span>
</span><span class='line'>    <span class="n">region</span>              <span class="o">=&gt;</span> <span class="s1">&#39;us-west-1&#39;</span><span class="p">,</span> <span class="c1"># Defaults to us-east-1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Overview</h2>




<p>Puppet s3 is my response to the need for secure downloads from S3 via Puppet. At SRC:CLR we use IAM authentication for S3 downloads. This piece of Puppet allows us to build out
our Jenkins continuous integration hook between the build and deployment process.</p>




<p>Currently the S3 type is only <em>psudo-idempotent</em>. What does that mean? It means <code>exists()?</code> actually pulls down the specified object to compare to the one on disk via a
tempfile. Then, if it returns false, <code>create()</code> pulls it down again.</p>




<p>Yes, this is horribly inefficient.</p>




<p>Yes, performance falls.</p>




<p>Yes, I plan on changing it in the near future.</p>




<h2>The Longview</h2>




<p>The reason we needed this provider is to enable us to pull S3 objects using our IAM authentication. But that is one small step towards our larger goal of fully integrating our Jenkins build
pipeline with our Puppet deployed AWS infrastructure.</p>




<p>To fully realize this integration we needed a way to pull the S3 zip file that is our built application, from S3. Jenkins deposits this zip file for us.</p>




<p>Then, Puppet compares the version number on S3 with the version number on disk. If greater, it pulls the new version.</p>




<h2>The Pipeline</h2>




<p>The pipeline from <code>git push</code> to <code>puppet agent -t</code> looks like this:</p>




<ol>
<li>A PR is submitted in Github and human eyes do a final check on the code.</li>
<li>If the human check passes, a manual merge to master is invoked.</li>
<li>A human manually runs a Jenkins build for either QA or Production environments. Lets assume this is a production deployment for this example.</li>
<li>The Jenkins build:

<ol>
<li>Runs Java tests</li>
<li>If the tests pass, builds a Java Jar.</li>
<li>Places this jar on S3 as: <code>our_app_${version}.zip</code> Let&rsquo;s assume $version is 3.2.1</li>
<li>Sends a HTTP POST to our Puppet Master with the following JSON:</li>
</ol>
</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">&#39;environment&#39;:&#39;production&#39;,</span>
</span><span class='line'>    <span class="err">&#39;role&#39;:&#39;application_backend&#39;,</span>
</span><span class='line'>    <span class="err">&#39;version&#39;:&#39;3.2.1&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>A webhook running on our Puppet Master parses the POST and does the following:</p>




<ol>
<li>Edits the hieradata file at <code>/etc/puppetlabs/puppet/environments/${environment}/roles/${role}.yaml</code> to replace the value of key <code>profiles::sc_services::application_backend::version</code> with
the value sent in the POST: 3.2.1. $environment and $role are also inserted in the $path above to make a fully qualified path.</li>
<li>Commits this yaml data file locally and pushes it back up to our Puppet control repo.</li>
<li>It then invokes MCO as:</li>
</ol>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">su</span> <span class="o">-</span> <span class="n">peadmin</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">mco</span> <span class="n">puppet</span> <span class="n">runonce</span> <span class="o">-</span><span class="n">F</span> <span class="n">role</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">role</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Where $role is our role sent in the POST</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-02-08T15:29:47-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:29 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2015/02/06/puppet-webhook/">Puppet-webhook</a></h2>
  
  <p>
    <h1>puppet-webhook</h1>




<p>Have you ever needed to implement a simple REST API call to another service after a puppet run or during?</p>




<p>Well now you can!</p>




<p>This module contains a <code>http</code> type which can be ensureed to GET or POST. At the time of this writing the POST route has not been completed, however the GET route is implemnted as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;the_route&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">get</span><span class="p">,</span>
</span><span class='line'>    <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;your.domain.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>This construction will essentially execute:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">curl</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">your</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">6969</span><span class="o">/</span><span class="n">the_route</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Real world example</h3>




<p>Ok great, now we have an access point to the ruby HTTP lib from Puppet. Now what? Well, eventually you&rsquo;ll be able to do something like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;my_api&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">post</span><span class="p">,</span>
</span><span class='line'>    <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;your.domain.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">data</span>    <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;my_key&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;some_value&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;another_key&#39;</span>   <span class="o">=&gt;</span> <span class="vg">$:</span><span class="ss">:some_fact</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">header</span>  <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="c1"># or maybe javascript? or whatever your hook expects...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now that&rsquo;s a more complex example. What if all I want to do is execute a puppet run on my haproxy node after new nodes come up behind it?</p>




<p>Sure, there are a lot of ways we could accomplish this. I think the agreed upon way would be to use mCollective. mCollective is great since it rolls on Apache&rsquo;s ActiveMQ message bus. What that means is mCollective is <strong>asynchronous</strong> in messsaging. In other words, if we set up a webhook on our haproxy node to run <code>puppet agent -t</code> whenever a route recieves a GET request. However, we&rsquo;d end up having a race condition on the puppet process itself; if puppet is already running when a new node comes up it will fail to implement the call to run puppet on the haproxy node since that call is synchronous.</p>




<p>mCollective&rsquo;s AMQ bus allows us to stick a message on the bus to run puppet if it can&rsquo;t execute puppet right away, like when the puppet process is already running and the lock file exists.</p>




<p>So, the question remains: how do I execute a puppet run on our haproxy node, in order to get its fresh external resources (haproxy members) when new nodes come up?</p>




<p>Well, we could have a run stage at the end of our role (for the new node which will be a haproxy member)  manifest for the class containing our <code>http</code> resource:</p>




<p>Given a role of <code>haproxy_member_backend_service</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">roles</span><span class="p">:</span><span class="ss">:haproxy_member_backend_service</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">stage</span> <span class="p">{</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">requires</span> <span class="o">=&gt;</span> <span class="no">Stage</span><span class="o">[</span><span class="s1">&#39;main&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#... a bunch of code</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;profiles::update_loadbalancer&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">stage</span> <span class="o">=&gt;</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>&hellip;and a update_loadbalancer profiles like:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:update_loadbalancer</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;update_loadbalancer&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">get</span><span class="p">,</span>
</span><span class='line'>        <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;my.puppetmaster.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>We can implement a webhook profile that is included in our puppetmaster module (or role, if your puppetmaster doesn&rsquo;t need a lot of configuration like mine) like this (which uses the handy <code>webhook::listener</code> defined type) to build out a dynamically generated sinatra server:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">puppetmaster</span><span class="p">:</span><span class="ss">:webhook</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="n">webhook</span>
</span><span class='line'>    <span class="ss">webhook</span><span class="p">:</span><span class="ss">:listener</span> <span class="p">{</span><span class="s1">&#39;puppet&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">port</span> <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">routes</span>            <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;kick_haproxy_app_internal&#39;</span>  <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;method&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;command&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;su - peadmin -c &#39;mco puppet runonce -F role=haproxy_app_internal&#39;&quot;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>That <code>webhook::listener</code> builds a sinatra server at <code>/usr/local/bin/webhook_puppet/</code>. It looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;webrick&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Global vars</span>
</span><span class='line'><span class="no">LOGDIR</span>              <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/../logs&#39;</span>
</span><span class='line'><span class="no">SERVER_LOGFILE</span>  <span class="o">=</span> <span class="no">LOGDIR</span> <span class="o">+</span> <span class="s1">&#39;/server.log&#39;</span>
</span><span class='line'><span class="no">SESSION_LOG</span>         <span class="o">=</span> <span class="no">LOGDIR</span> <span class="o">+</span> <span class="s1">&#39;/session.log&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Reset some envs</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;/root&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;/sbin:/usr/sbin:/bin:/usr/bin:/opt/puppet/bin&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Implement an access log for robust logging of user info and access and git output</span>
</span><span class='line'><span class="no">LOG</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SESSION_LOG</span><span class="p">)</span>
</span><span class='line'><span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting session log at </span><span class="si">#{</span><span class="no">SESSION_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting server log at </span><span class="si">#{</span><span class="no">SERVER_LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Server options</span>
</span><span class='line'><span class="n">opts</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:Port</span>               <span class="o">=&gt;</span> <span class="mi">6969</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:Logger</span>             <span class="o">=&gt;</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Log</span><span class="o">::</span><span class="kp">new</span><span class="p">(</span><span class="no">SERVER_LOGFILE</span><span class="p">,</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Log</span><span class="o">::</span><span class="no">DEBUG</span><span class="p">),</span>
</span><span class='line'>    <span class="ss">:ServerType</span>         <span class="o">=&gt;</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Daemon</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:SSLEnable</span>          <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/kick_haproxy_app_internal&#39;</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;su - peadmin -c &#39;mco puppet runonce -F role=haproxy_app_internal&#39;&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">output</span><span class="o">|</span>
</span><span class='line'>            <span class="n">output</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">chomp</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">not_found</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;You shall not pass! (page not found)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">WEBrick</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="no">Server</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
</span><span class='line'>    <span class="o">[</span><span class="ss">:INT</span><span class="p">,</span> <span class="ss">:TERM</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">sig</span><span class="o">|</span> <span class="nb">trap</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="p">{</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>You can add as many routes as you&rsquo;d like to the <code>routes</code> parameter in the <code>webhook::listener</code> define. It&rsquo;s great for quickly building and codifying your API infrastructure. For now, it only works with very simple things like &lsquo;I need to run this arbitrary command on a box on POST or GET&rsquo;, but I&rsquo;m going to build it out with more complex routes as defautls such as:</p>




<ul>
<li>Accept a POST from jenkins with the <code>environmnent</code>, <code>role</code> and <code>version</code> of a given build. Based on that post, update the hiera data as needed and re-run puppet on the box that is assigned the <code>role</code> in the given <code>environmnent</code>.</li>
</ul>




<p>With a route like that you can setup a CI hook from your build environment in Jenkins (using any of the HTTP plugins for Jenkins) with Puppet very easily.</p>




<h3>&hellip;back to the point &hellip;</h3>




<p>So now we have this webhook running on our Puppet Master. The webhook accepts a route at <code>http://mymaster.com:6969/kick_haproxy_app_internal</code> and upon receiving a GET request it will execute an mCollective command to <code>puppet runonce</code> on the node whose <code>$::role</code> fact matches <code>haproxy_app_internal</code>. If you guessed that <code>haproxy_app_internal</code> is the role for our internal loadbalancer then congrats, you&rsquo;ve won nothing but please come back and play again.</p>




<p>At the end of our role manifest for the node which will be a <code>balancermember</code> behind this loadbalancer we have set up a run stage that excutes last, which leverages the <code>http</code> resource, ensured to GET at the specified route to the webhook running on our master. Now, when nodes assined that role <code>haproxy_member_backend_service</code> come up, they kick our webhook on the master which generates an asynchronous call on mCollective to hick the loadbalancer which pulls down the exported <code>balancermember</code> resources.</p>




<p>THIS IS AMAZING IF YOU&rsquo;RE RUNNING AWS AUTOSCALING GROUPS</p>




<p>I&rsquo;m not sure why that needed to be in all caps. Maybe you&rsquo;ll understand if you have haproxy running in front of an autoscaling group, you&rsquo;ll realize why I&rsquo;M SO EXCITED.</p>




<h3>Where I&rsquo;m going to take this&hellip;</h3>




<p>I&rsquo;m going to add the above mentioned route for Jenkins as an optional default. That route is the glue that ties in how we execute puppet runs via MCO when new builds are pushed down the pipeline. The flow would look something like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">On</span> <span class="n">my</span><span class="o">.</span><span class="n">jenkins</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">final</span> <span class="n">build</span> <span class="n">process</span> <span class="ss">is</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">POST</span> <span class="n">my</span><span class="o">.</span><span class="n">puppetmaster</span><span class="o">.</span><span class="n">com</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;environment&#39;</span>   <span class="o">=</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;role           = &#39;</span><span class="n">some_micro_service_backend</span><span class="s1">&#39;,</span>
</span><span class='line'><span class="s1">        &#39;</span><span class="n">version</span>        <span class="o">=</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">On</span> <span class="n">my</span><span class="o">.</span><span class="n">puppetmaster</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">upon</span> <span class="n">receiving</span> <span class="no">POST</span> <span class="n">from</span> <span class="n">my</span><span class="o">.</span><span class="n">jenkins</span><span class="o">.</span><span class="n">com</span> <span class="n">with</span> <span class="n">the</span> <span class="n">above</span> <span class="ss">JSON</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="mi">1</span><span class="o">.</span> <span class="no">Update</span> <span class="n">hieradata</span> <span class="n">at</span> <span class="sr">/etc/</span><span class="n">puppetlabs</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">environments</span><span class="o">/</span><span class="c1">#{environment}/roles/#{role}.yaml </span>
</span><span class='line'>    <span class="n">with</span> <span class="n">the</span> <span class="n">correct</span> <span class="c1">#{version} from jenkins.</span>
</span><span class='line'>    <span class="mi">2</span><span class="o">.</span> <span class="no">Commit</span> <span class="n">the</span> <span class="kp">new</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">push</span> <span class="n">back</span> <span class="n">up</span> <span class="n">to</span> <span class="n">our</span> <span class="n">control</span> <span class="n">repo</span> <span class="n">where</span> <span class="n">hieradata</span> <span class="n">dir</span> <span class="n">actually</span> <span class="n">resides</span><span class="o">.</span>
</span><span class='line'>    <span class="mi">3</span><span class="o">.</span> <span class="ss">Execute</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mco</span> <span class="n">puppet</span> <span class="n">runonce</span> <span class="o">-</span><span class="n">F</span> <span class="s1">&#39;role=#{role}&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Boom, we just implemented and end-to-end CI chain from our Jenkins build process, which updated our Puppet Master with the new version of the micro service, which pushed the version to git, and ran puppet on the node whose role matches the micro service being updated.</p>




<p>In our infrastructure the profile for the micro service executes a <code>s3file</code> resource to pull down the build which matches:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3file</span> <span class="p">{</span> <span class="s1">&#39;micro_service_${version}:</span>
</span><span class='line'><span class="s1">    path    =&gt; &#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">bucket</span><span class="o">/</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">latest</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>When the node consuming the <code>mco puppet runonce</code> publication runs puppet, that profile ensures we get the latest revision of our code. d</p>




<p>&#8220;`puppet-webhook&#8220;&#8220; is available at:</p>




<p>github.com/malnick/puppet-webhook.git</p>




<p>^^ your milage may vary.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2015-02-06T06:52:36-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:52 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/12/23/using-dns-for-applying-roles-to-nodes-in-puppet/">DNS-based Role Classification</a></h2>
  
  <p>
    <p>The first place you&rsquo;d probably look for developing a role-based hiera layer is probably a fact-based role. Facts are great, they allow you to execute code on a node and generate dynamic information about your infrastructure. You could go ahead and do this very easily if you have solid domain naming mechanisms.</p>




<p>For example, your load balancer might always start with <code>lb-p-dc.domain.prd.int</code> and your app nodes might always start with <code>app-p-dc.domain.prd.int</code> or something like that.</p>




<p>But in reality, domain names are never really this elegant. So the reality is you need to have a better, more resolute way to figure out what role each node has.</p>




<p>You could, at this point, go the route of external facts. External facts are cool because they can be provisioned via a pxe-boot script as a simple txt file with key value pairs. However, now you have to manage and ensure this <strong>very important</strong> piece of infrastructure code is in place properly on each node. If someone deletes this fact, you have to have some configuration management magic to ensure it gets put back in place since external facts don&rsquo;t pluginsync.</p>




<h3>DNS-based role classification</h3>




<p>You can however implement some DNS magic. DNS has specific resources that include more than just a mapping of IP addresses to domains. Domains can have TXT resources associated with them. So let&rsquo;s assume your load balancer, <code>lb-p-dc.domain.prd.int</code>, has a TXT resource associated with it in DNS. Now we can write a fact that looks up that TXT resource.</p>




<p>That fact might look something like:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;resolv&#39;</span>
</span><span class='line'><span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">setcode</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Get hostname based on fqdn fact</span>
</span><span class='line'>      <span class="n">hostname</span> <span class="o">=</span> <span class="no">Facter</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="ss">:fqdn</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># Get a new DNS resolver object pointed at our nameserver i</span>
</span><span class='line'>      <span class="n">stupid</span> <span class="o">=</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">.</span><span class="n">new</span> <span class="c1"># Defaults to /etc/resolv.conf on linux envs</span>
</span><span class='line'>      <span class="c1"># Get a TXT DNS resource for the host</span>
</span><span class='line'>      <span class="n">this</span> <span class="o">=</span> <span class="n">stupid</span><span class="o">.</span><span class="n">getresource</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">::</span><span class="ss">Resource</span><span class="p">:</span><span class="ss">:IN</span><span class="o">::</span><span class="no">TXT</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># .strings is the value of the txt resource and it&#39;s an array since you can have many txt resources</span>
</span><span class='line'>      <span class="n">this</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>          <span class="c1"># Get the role txt resource</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">r</span> <span class="o">=~</span> <span class="sr">/^role/</span>
</span><span class='line'>              <span class="c1"># Split it on = for the last part which is the value of the role</span>
</span><span class='line'>              <span class="n">role</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># If role never got set it&#39;s because /^role never matched, so let&#39;s set this to unknown</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">role</span>
</span><span class='line'>          <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># Return the role</span>
</span><span class='line'>      <span class="n">role</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Hey, that&rsquo;s pretty neat. So this little fact executes on the node on agent runs. Does a lookup in DNS for the TXT resource. Finds that TXT resource and returns the role type. If no TXT resource that matches /^role/ is found, it returns an &lsquo;unknown&rsquo; role.</p>




<p>Now you can implement that <code>role/%{::role}</code> layer in hiera like you always wanted! Yay!</p>




<h3>Why this isn&rsquo;t secure</h3>




<p>Buzz kill ahead!</p>




<p>This fact is only somewhat secure. Since this isn&rsquo;t a secure fact, like clientcert, it can be overridden on the command line like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FACTER_role</span><span class="o">=</span><span class="n">application</span> <span class="n">puppet</span> <span class="n">agent</span> <span class="o">-</span><span class="n">t</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now, whoever got on your subnet with your puppet master can easily pull down your application node&rsquo;s configuration. SSH keys, private keys, whatever other private information you might have as part of the configuration for this node.</p>




<p>(Ok, maybe not quite as simple as that if you don&rsquo;t auto-authenticate your nodes. However, if one node in the infrastructure that is authenticated to the Puppet Master CA get&rsquo;s taken over a smart attacker could do a puppet run with the role type for every other node in the infrastructure and get a lot of data out of it.)</p>




<h3>The fix</h3>




<p>The best way to fix this issue is to get the DNS TXT resource using a secure fact like $::clientcert. Then pass this fact into a function that will execute on the master to do the DNS lookup for you.</p>




<p>For example, your function instanciation migth look like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyClass</span> <span class="p">(</span>
</span><span class='line'>  <span class="vg">$role</span> <span class="o">=</span> <span class="n">role_resolver</span><span class="p">(</span><span class="vg">$:</span><span class="ss">:clientcert</span><span class="p">),</span>
</span><span class='line'><span class="p">){</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<p>Then your function <code>role_resolver()</code> might look like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;resolv&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Puppet::Parser::Functions</span>
</span><span class='line'>  <span class="n">newfunction</span><span class="p">(</span><span class="ss">:role_resolver</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:rvalue</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">hostname</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>      <span class="n">stupid</span> <span class="o">=</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">this</span> <span class="o">=</span> <span class="n">stupid</span><span class="o">.</span><span class="n">getresource</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">::</span><span class="ss">Resource</span><span class="p">:</span><span class="ss">:IN</span><span class="o">::</span><span class="no">TXT</span><span class="p">)</span>
</span><span class='line'>      <span class="n">this</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">r</span> <span class="o">=~</span> <span class="sr">/^role/</span>
</span><span class='line'>              <span class="n">role</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">role</span>
</span><span class='line'>          <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">role</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now, since you&rsquo;re using a trusted, secure fact $::clientcert you are most certain that your lookup in DNS will be for the node that is checking in and nothing else. This is both secure as well as a fast, trusted way to get role classification from your current DNS system.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-12-23T16:49:37-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>4:49 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/11/03/hiera-template/">Hiera-template</a></h2>
  
  <p>
    <p>Every time we create a new profile, or update a profile, we have to update our hiera data. This process is error prone and time consuming. Hiera leverages almost any data interchange format (in fact I&rsquo;d bet if you can write the backend for it, it&rsquo;ll support it). The writing of that data can easily be automated, so a tool to write the data files for us was an obvious decision.</p>




<p><a href="https://github.com/malnick/hiera-template">hiera-template</a> is still in its infancy, and will eventually become a much larger part of our workflow. The main goal of this tool, however, remains the same: automate the generation of our hiera data files from our profile classes.</p>




<p>hiera-template is up in Rubygems, but be forewarned, it is VERY much still in BETA. Your mileage will vary and your bug reporting is appreciated.</p>




<h3>Install</h3>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install hiera-template</span></code></pre></td></tr></table></div></figure>




<h3>Usage</h3>




<p>hiera-template accepts a single path to a profile as an argument. It can be a local or fully qualified path.</p>




<p>By default, hiera-template will store all processed yaml&rsquo;s in <code>~/.hiera-template/templates/${profile_name}-${hierarchy_level}-template.yaml</code></p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/modules/profiles/manifests
</span><span class='line'>hiera-template company_frontend.pp
</span></code></pre></td></tr></table></div></figure>




<p>The above will create a baseline hiera data file from all the explicit hiera() lookups in the profile. Yes, you read that right, it will not work on non-explicit hiera() lookups. That will be a feature down the road. For now, the following like-lines will be parsed:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$myvar</span> <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::company_frontend::myvar&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>




<p>That line will be written to a yaml file as:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">profiles::company_frontend::myvar</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Hierarchy Keys</h3>




<p>hiera-template uses <code>#[keys]</code> in the profile to determine what part of the hierarchy the data resides.</p>




<p>Given the following:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:csx_frontend_base</span><span class="p">(</span>
</span><span class='line'>  <span class="c1">#[node]</span>
</span><span class='line'>  <span class="vg">$csx_db_name</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_name&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_user</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_user&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password_hash</span>                 <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password_hash&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="c1">#[datacenter]</span>
</span><span class='line'>  <span class="vg">$csx_db_host</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_host&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_driverclassname</span>               <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_driverclassname&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_url</span>                           <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_url&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password</span>                      <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>




<p>hiera-template will create two yaml files in <code>~/.hiera-template/templates</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">datacenter</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span></code></pre></td></tr></table></div></figure>




<p>Those templates contain all the keys for the given profile. You can <code>cat *-node-template.yaml &gt; my.new.node.yaml</code> or <code>cat *-datacenter-template.yaml &gt;&gt; out_dc.yaml</code> to create or append the keys to data files. Then, all you need to do is fill in your values.</p>




<h3>Upcoming</h3>




<p>Since writing in data can be so error prone, and hiera is by it&rsquo;s nature hard to debug, a tool ensures your data written to your data files is the same as what is declared in your profiles - on the flip side, it&rsquo;ll propogate your errors from the profile data declarations to the data file. Either way, you&rsquo;re automating it!</p>




<p>To help write the values to the data files I&rsquo;ll up adding a feature to populate, so you don&rsquo;t have to worry about all that new-fangled white space that YAML loves to hate you for. Populate will prompt your for each value and write it in automatically, so you don&rsquo;t have to open vim: you&rsquo;re prompted with the key, and you type in the value. Done deal.</p>




<h3>Debugging</h3>




<p>Currently, this tool is not hardened by any means. And like everyone else, I can&rsquo;t stay on top of everything. So if you&rsquo;re using it, hit me up with bug reports. There is a <code>-D</code> option to run at debugger level, and I tried to make it obvious what is going on. That&rsquo;s no substitution for reading <code>/lib/template.rb</code> if you get a stack trace though. It&rsquo;s a very simple tool, and right now everything lives in <code>template.rb</code> so it should be easy to figure out.</p>




<h3>Known issues:</h3>




<ol>
<li>It will break if you have other comments in the hiera look up declarations other than keys</li>
<li>It will not work on implicit lookups, you need hiera()</li>
<li>It&rsquo;ll probably be buggy, but have fun and support it if you find it useful</li>
</ol>




  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-11-03T05:02:03-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>5:02 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/10/31/the-benefits-of-being-sheep/">The Benefits of Being Sheep</a></h2>
  
  <p>
    <p>Sometimes we have to check our ego&rsquo;s. This post is a completely opinionated piece on why following community practice is a best practice. Sometimes people refer to this as being &ldquo;sheep&rdquo;.</p>




<p>Communities exist to support people. In our community, we support each other on IRC, by commenting on tickets we have interest in, and by BBC&rsquo;s and email lists. We also have friends who call on us to help them in their daily work, answer questions about why this error or that warning are flashing across their screens, or the best way to get around a known bug. We help each other becuase we&rsquo;re all on a mission to build and leverage technology to do the shit work for us. However, when that technology breaks, it&rsquo;s the community that we commonly go back to, asking questions, seeking answers.</p>




<p>The other day a colleague asked me why I use explicit hiera() lookups in my code. He made a lot of very sound points: it&rsquo;s messy, automatic data bindings already do this for us, it&rsquo;s clearer if you just assume the data is coming from hiera&hellip; I agreed with all of them, yet I still use the explicit lookup in my profiles. Why?</p>




<p>I do this because everyone else does this, it&rsquo;s a community best practice. His response was, well sure, we can all be sheep. Ah yes, sheep. Let&rsquo;s side track on that topic for a second. Why do sheep travel in packs and follow each other? They do it because when a preditor shows up, they can work as a group to confuse it, and possibly save each other. They work together for the common good.</p>




<p>In our line of work we need the community. Why use a tool like Puppet or Chef, an open source, community supported framework, if you&rsquo;re just going to tuck the best practices away in your pocket becuase you feel like it doesn&rsquo;t suit you? If that was your intent all along, you might as well roll your own CM tool. Oh wait, rolling your own tool sounds really hard? Ok then use the open source tool chain. And when you get that error about hiera not finding data in one of your 50 profiles, but you know the data is in hiera and you can&rsquo;t figure out what&rsquo;s going on, where do you turn? IRC, BBC, email lists, jira, etc&hellip; and when you put your code down in those forums and everyone see&rsquo;s you&rsquo;re not explicitly looking up the values, it&rsquo;s then someone asks &ldquo;Is this a fresh node?&rdquo; &ldquo;sure is!&rdquo; you say &ldquo;Maybe the operations person who provisioned puppet turned off automatic data bindings&hellip;&rdquo; - that turns out to be the case&hellip; or any number of other possible scenarios that might prevent hiera from getting a value.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-10-31T06:44:08-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>6:44 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/10/29/the-proxy-module/">The Proxy Module</a></h2>
  
  <p>
    <p>In puppet land there are a lot of different phrases and keywords that float around: &ldquo;atomic modules&rdquo;, &ldquo;Roles and Profiles&rdquo;, &ldquo;wrapper modules&rdquo;.</p>




<p>This post disects these terms and others, and proposes a new type of site-specific, not-quite-a-wrapper module and not-quite-an-atomic module called the &ldquo;Proxy Module&rdquo;.</p>




<h2>It&rsquo;s about solutions</h2>




<p>We have a number of custom apt stores in our infrastrcture. In order to provision both our apt repos and our apt clients to our custom PPA&rsquo;s and Sources, we wrote a profile called apt_client_config and apt_repo.pp. These profiles lived in the profiles module, naturally. However, since they were called from profiles, we had several instances where another module being called from that profile also depended on apt. In which case, we would run into duplicate dependencies, looped graphs, and all the other expected outcomes of using a module whose bits and pieces are needed by many other modules, at such a high level of abstraction.</p>




<p>The solution was to create a proxy module. This module would wrap up just the pieces of apt that needed to be instanciated at the profile level. So, instead of running apt-based profiles in run stages at the profile level, we would run our proxy module to apt that ran just the defines we needed. These defines would be fed data from hiera via create_resources(). In this way, the proxy module differs from an atommic one - it&rsquo;s still wrapping up another module, but since it&rsquo;s so site-specific, we omit the params.pp. We don&rsquo;t want this module to &ldquo;work out of the box&rdquo;, we want it to fail if it doesn&rsquo;t get our site-specific from hiera.</p>




<h2>The implementation</h2>




<p>The init.pp for our apt proxy module, named cs_apt (since we&rsquo;re Connect Solutions):</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Class: cs_apt</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Parameters:</span>
</span><span class='line'><span class="c1"># [*always_update*]</span>
</span><span class='line'><span class="c1"># boolean value to determine if apt-get update should be run every time the</span>
</span><span class='line'><span class="c1"># class is instantiated</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*ppas*]</span>
</span><span class='line'><span class="c1"># Hash of type apt::ppa to add to host</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*purge_sources_list*]</span>
</span><span class='line'><span class="c1"># Boolean value to determine if sources should be purged from host. True for</span>
</span><span class='line'><span class="c1"># FedRAMP</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*purge_sources_list_d*]</span>
</span><span class='line'><span class="c1"># Boolean value to determin if source.d/* should be purged from host.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*sources*]</span>
</span><span class='line'><span class="c1"># Hash of type apt::source to add new ppa sources to host</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Requires:</span>
</span><span class='line'><span class="c1"># n/a</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Sample Usage:</span>
</span><span class='line'><span class="c1"># See README.md</span>
</span><span class='line'><span class="k">class</span> <span class="n">cs_apt</span> <span class="p">(</span>
</span><span class='line'>  <span class="vg">$always_update</span>      <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::always_update&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$ppas</span>           <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::ppas&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$purge_sources_list</span>     <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::purge_sources_list&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$purge_sources_list_d</span>   <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::purge_sources_list_d&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$sources</span>        <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::sources&#39;</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="k">case</span> <span class="vg">$:</span><span class="ss">:osfamily</span> <span class="p">{</span>
</span><span class='line'><span class="s1">&#39;debian&#39;</span> <span class="p">:</span> <span class="p">{}</span>
</span><span class='line'><span class="ss">default</span><span class="p">:</span> <span class="p">{</span> <span class="nb">fail</span><span class="p">(</span><span class="s2">&quot;${::osfamily} is not supported with module&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$always_update</span><span class="p">)</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$purge_sources_list</span><span class="p">)</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$purge_sources_list_d</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$ppas</span> <span class="p">{</span>
</span><span class='line'><span class="n">validate_hash</span><span class="p">(</span><span class="vg">$ppas</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$sources</span> <span class="p">{</span>
</span><span class='line'><span class="n">validate_hash</span><span class="p">(</span><span class="vg">$sources</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Update repo cache and purge sources is necessary</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;::apt&#39;</span><span class="p">:</span>
</span><span class='line'><span class="n">always_apt_update</span> <span class="o">=&gt;</span> <span class="vg">$always_update</span><span class="p">,</span>
</span><span class='line'><span class="n">purge_sources_list</span> <span class="o">=&gt;</span> <span class="vg">$purge_sources_list</span><span class="p">,</span>
</span><span class='line'><span class="n">purge_sources_list_d</span> <span class="o">=&gt;</span> <span class="vg">$purge_sources_list_d</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$ppas</span> <span class="p">{</span>
</span><span class='line'><span class="n">create_resources</span><span class="p">(</span><span class="s1">&#39;::apt::ppa&#39;</span><span class="p">,</span> <span class="vg">$ppas</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$sources</span> <span class="p">{</span>
</span><span class='line'><span class="n">create_resources</span><span class="p">(</span><span class="s1">&#39;::cs_apt::source&#39;</span><span class="p">,</span> <span class="vg">$sources</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># vim: ts=2 sw=2</span>
</span></code></pre></td></tr></table></div></figure>




<p>Then in our profiles, to configure an apt source, we simply</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-10-29T20:50:15-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:50 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/">Streamlining Puppet Dev Part Duce: Branch the Enviro</a></h2>
  
  <p>
    <p>Most companies don&rsquo;t have a single monolithic application, today most applications evolve out of lots of atomic services: thus, service oriented architecture.</p>




<p>What this means for your development environment is that you end up having many different applications, which is many cases are atomic services and in other cases are a conglomeration of services. Either way, you end up with a need for many dev environments.</p>




<p>At Connect Solutions we have several environments that require infrastructure development. The main ones are our custom load balancer (we call it MTLB), our Connect Cluster, CQ, and our Connect Experience applications.</p>




<p>In order to streamline our dev process with Puppet we created a repo called &lsquo;puppet-dev-enviro&rsquo; that deploys VM&rsquo;s with Vagrant and manages what modules you want to test via Rake &amp; r10k.</p>




<p>For any given envio we like to mirror what it looks like in prod as best we can. Therefore, any enviro always uses the version of puppet we run in prod on a separate Puppet Master, then the nodes that make of the rest of the enviro.</p>




<p>A simple example, theMTLB enviro deploys a Puppet Master and an MTLB load balancer node.</p>




<h2>Enviro Management</h2>




<p>Since we have so many enviros we branch the &lsquo;puppet-dev-enviro&rsquo; repo for each one. So if you&rsquo;re testing MTLB code the workflow looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">enviro</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="n">mtlb</span>
</span><span class='line'><span class="no">MONO</span><span class="o">=</span><span class="kp">true</span> <span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>




<p>Those first two commands are pretty straight forward. However, the deploy command probably needs some explanation. I wrote this task to streamline our development pipeline. It&rsquo;s main functionality is to read from a subdirectory called puppet and a file called the Puppetfile.</p>




<p>You might be familiar with the Puppetfile concept if you&rsquo;ve used Puppet Librarian or r10k. In this task, I actually invoke r10k locally on the Puppetfile to pull down all the modules listed in it to puppet/modules. In the case of Connect Solutions, we&rsquo;re currently in the process of moving our legacy puppet module structure from a monolithic one to their own atomic repos. This isn&rsquo;t complete yet, so the MONO=true env variable envokes a subcommand in deploy to rip out all the sub-modules of this monolithic repo and place them in puppet/modules.</p>




<p>&lsquo;Deploy&rsquo; also supports hiera data management by checking for our <code>puppet-configuration</code> repo in the puppet/modules directory. If it&rsquo;s listed in the Puppetfile this repo will be present here. If so, it moves all the data from puppet-configuration into puppet/data.</p>




<p>Both <code>puppet/modueles</code> and <code>puppet/data</code> are shared with the puppet master VM deploed with Vagrant. As a Vagrant post-provisioning step I blow away the <code>/etc/puppetlabs/puppet/modules</code>, <code>/etc/puppetlabs/puppet/data</code> directories and sym link the shared modules and data directories out of <code>/tmp</code>.</p>




<h4>The Deploy Task</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="c1"># Check directory structure:</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/modules...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/modules not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/data...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/data not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Detected puppet data repo, copying contents to </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up --provider virtualbox&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>This structure allows us to play around with the module code on the fly from the host VM, with our own dotfiles and local editing or preferred pipelines. For example, I am a heavy Vim user, however, a lot of my colleagues are Sublime text users. You can choose what method best suites you and not be beholden to who provisioned the VM .box file beforehand.</p>




<p>For large code-base changes, i.e., developing an entireley new topic branch, this pipeline allows seamless integration with git and enables better version control management. An example workflow would be:</p>




<ol>
<li>Open two screen or tmux sessions</li>
<li>In one session cd into <code>/path/to/monolithic/puppet-modules/test-mod/manifests</code></li>
<li>In the other session cd into <code>/path/to/puppet-dev-enviro</code></li>
<li>In <code>puppet-dev-enviro</code>:

<ol>
<li>git checkout my-enviro</li>
<li>update <code>puppet/Puppetfile</code> and <code>`puppet/manifests/site.pp</code></li>
</ol>
</li>
</ol>




<p>puppet/Puppetfile:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s1">&#39;puppet-modules&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="ss">:connectsolutions</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">modules</span><span class="s1">&#39;, :ref =&gt; &#39;</span><span class="n">my</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">branch</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&#39;</span><span class="n">puppet</span><span class="o">-</span><span class="n">configuration</span><span class="s1">&#39;, :git =&gt; git@github.com:connectsolutions/puppet-configuration&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<p>puppet/manifests/site.pp:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span> <span class="err">&#39;</span><span class="n">my</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">dev</span><span class="sb">` {</span>
</span><span class='line'><span class="sb"> include my::class</span>
</span><span class='line'><span class="sb">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>DEPLOY: In <code>puppet-dev-enviro</code> run <code>MONO=true rake deploy</code></p>




<p>This will now pull down and configure the environment for the VM&rsquo;s. When finished, all the puppet data and modules will be live on the master VM.</p>




<h3>Enviro-Specific Vagrantfile</h3>




<p>One step I&rsquo;ve skipped here however is making a git-branch for my-enviro. That&rsquo;s a completely different step but mainly involves updateing the Vagrantfile with the neccessary VM information. I won&rsquo;t cover that here since that is specific to every enviro the same way Puppet code is speciic to each module. I will however share what stays the same between most Vagrantfiles in each enviro and that is the Master VM configuration block:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntuamd64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloud-images.ubuntu.com/vagrant/precise/current/precise-server-cloudimg-amd64-vagrant-disk1.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.3.0&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span>  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.28.126.141&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.dev&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/data&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/data&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/filestore&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/filestore&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/puppet&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/data &amp;&amp; ln -s /tmp/data/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/filestore/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm /etc/puppetlabs/puppet/hiera.yaml &amp;&amp; ln -s /tmp/puppet/hiera.yaml /etc/puppetlabs/puppet/hiera.yaml&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/puppet/fileserver.conf /etc/puppetlabs/puppet/fileserver.conf&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Code Test -> Develop Pipeline</h3>




<p>Once the VM&rsquo;s are up and running you can ssh into the VM under test and run <code>puppet agent -t</code>. If everything went as planned the agent will get a catlog from the master and start configuring itself. If you&rsquo;re like me, it didn&rsquo;t work on the first try. Now we need to update our code-base.</p>




<p>In the screen or tmux session that is CD&#8217;ed to your <code>puppet-modules</code> directory go into the manifests dir of the code in question. Edit that code or make whatever changes are needed for further testing.</p>




<p>Keep in mind we are working on our <code>my-topic-branch</code> branch of the <code>puppet-modules</code> repo. So when we&rsquo;re done making the local changes:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add my-class.pp
</span><span class='line'>git commit -m <span class="s2">&quot;I made changes&quot;</span>
</span><span class='line'>git push origin my-topic-branch
</span></code></pre></td></tr></table></div></figure>




<p>Then in the other screen window that&rsquo;s in the <code>puppet-dev-enviro</code> directory run:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MONO</span><span class="o">=</span><span class="nb">true </span>rake pull
</span></code></pre></td></tr></table></div></figure>




<p>This runs only r10k and the workflow neccessary to pull down the new Puppet code. It is a heavy operation if you have a LOT of code in that Puppetfile. We haven&rsquo;t ran into an issue with that yet however for our individual test enviros. The :pull task looks like this:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;This will blow away everything in puppet/modules. Are you sure you want to continue? [y/n]&quot;</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>      <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>      <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">puts</span> <span class="s2">&quot;Exiting...&quot;</span>
</span><span class='line'>      <span class="nb">exit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now you have new code in your master VM, run <code>puppet agent -t</code> again on your agent.</p>




<h3>Wait a minute!</h3>




<p>Some will say, &ldquo;This is more work than before. Now I have this extra git step!&rdquo;. Yup, that&rsquo;s right, you&rsquo;re forced to commit your changes to your own topic branch before you test on your local machine. Yes, this isn&rsquo;t good for doing work on the airplane. Granted, this test enviro as it currently stands isn&rsquo;t designed for the latter, it&rsquo;s designed towards <strong><em>seamless collaboration</em></strong>.</p>




<p>What do I mean by that? I mean, I don&rsquo;t want to have the conversation with a colleage at 4PM on a Thursday night that goes like this: &ldquo;Hey, I need to collaborate on your code. Can you push it to a topic branch in git for me?&rdquo; &ldquo;Sure, I&rsquo;ll do that as soon as I get home tonight after picking up the kids and making dinner.&rdquo; &ldquo;Great!&rdquo; &hellip; The following day: &ldquo;So hey, I REALLY wanted to test out that code we need in prod by this afternoon last night, but I never saw a push for your branch.&rdquo; &ldquo;Yeah, sorry, I got caught up in stuff. You know, life!&rdquo;.</p>




<p>That &lsquo;extra&rsquo; git step ensures all the development steps are being tracked, and anyone at anytime can spin up this environmnet with the exact same Puppetfile and site.pp configuration and get similar testing results.</p>




<p>Some day, I&rsquo;ll put together a local-only development environment but for now this is not the purpose of what we&rsquo;ve created here.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-10-07T14:31:39-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:31 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/08/31/arbitrary-commandline-functions-for-mco/">Arbitrary Commandline Functions for MCO</a></h2>
  
  <p>
    <p>mCollective is a funny tool. The idea behind it is obvious and great: a message bus for node orchestration. But the API and underpinnings are often a black box for many Puppet noobs and even other automation professionals. They mostly stick to the Puppet Enterprise Live Management console to interact with the mCollective back-end, never <code>su peadmin</code> and running a few <code>mco $some_application -F $some_fact</code>.</p>




<p>The truth is, MCO is a powerful backend for orchestration. It gets a bad name because the performance isn&rsquo;t there sometimes, especially at scale. Not to dive into a rabbit hole, but that&rsquo;s often due to user error: 1 broker running over 1000&rsquo;s of nodes; the ActiveMQ JVM being improperly tuned; bad layer 1  (yup, it can be that simple).</p>




<p>One thing about MCO that is true is the API is hard to get through. It makes sense once you get under the hood, and especially after reading through other agents and DDl&rsquo;s but what if all you want is a simple way to run an arbitrary commandline argument on some remote node with MCO? If you don&rsquo;t know what you&rsquo;re doing that could take a while; if you know what you&rsquo;re doing, you still have the write the code.</p>




<p>Well, since MCO runs through an API we can actually architect templates for this exact task, for both the data description language file and the agent ruby script.</p>




<p>Let&rsquo;s start with a basic DDL that will inform an agent running this arbitary command:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">metadata</span> <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @action_name %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:author</span>      <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= (@author_name+&#39;</span> <span class="s1">&#39;+ @author_email).strip %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:license</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @license %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:version</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @version %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:url</span>         <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @project_url %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:timeout</span>     <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="sx">%= @timeout %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">action &quot;run&quot;, :description =</span><span class="o">&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">display</span> <span class="ss">:always</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:status</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The exit code of the script&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Return Value&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:out</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stdout&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Output Channel&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:err</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stderr&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Error Channel&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Just a quick shout out to Jeremy Adams who wrote <a href="https://forge.puppetlabs.com/jpadams/runyer">this</a> very ERB template for his Runyer module which does what this rake task does but in Puppet code.</p>




<p>So we&rsquo;ve templated out the basic DDL for the agent. We&rsquo;ve included some metadata and output - arbitary commands usually just need to be ran without input, for instance <code>df -h</code> and returns the mounted volumes and data about them. That could be handy in orchestration. If we wanted to we could add some inputs here, for example, if we wanted to pass in an arbitrary input to a command. I&rsquo;m not interested in that here, just basic output from a command.</p>




<p>Let&rsquo;s build out the ruby script to run this command:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MCollective</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Agent</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;</span><span class="sx">%= @action_name.capitalize %&gt;&lt;RPC::Agent</span>
</span><span class='line'><span class="sx">      activate_when do</span>
</span><span class='line'><span class="sx">        &lt;%=</span> <span class="vi">@activate_condition</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">      end</span>
</span><span class='line'>
</span><span class='line'><span class="sx">      action &quot;run&quot; do</span>
</span><span class='line'><span class="sx">        command = &#39;&lt;%= (@cmd_prefix+&#39; &#39;+@command).strip %&gt;</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Our arbitary command only has 1 action. It&rsquo;s that simple. We run the command and push our output to the ouputs in the command.</p>




<p>Now let&rsquo;s look at the Rakefile that actually runs this. For me, I store most of my Rakefiles as <code>*.task</code> in <code>~/.rake</code> so I can run them anywhere with <code>rake -g</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Rakefile to create MCO agents and associated DDL</span>
</span><span class='line'><span class="c1"># Author: Jeff Malnick</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_agent_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;rb.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_ddl_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;ddl.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">McoAgent</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:command</span><span class="p">,</span> <span class="ss">:template</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@command</span>        <span class="o">=</span> <span class="n">command</span>
</span><span class='line'>      <span class="vi">@template</span>       <span class="o">=</span> <span class="n">template</span>
</span><span class='line'>      <span class="vi">@action_name</span>        <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="vi">@cmd_prefix</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>      <span class="vi">@activate_condition</span>     <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@author_name</span>        <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</span><span class='line'>      <span class="vi">@author_email</span>       <span class="o">=</span> <span class="s1">&#39;anonym@us&#39;</span>
</span><span class='line'>          <span class="vi">@license</span>            <span class="o">=</span> <span class="s1">&#39;Apache v2&#39;</span>
</span><span class='line'>      <span class="vi">@version</span>            <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
</span><span class='line'>          <span class="vi">@project_url</span>        <span class="o">=</span> <span class="s1">&#39;http://www.puppetlabs.com&#39;</span>
</span><span class='line'>      <span class="vi">@timeout</span>            <span class="o">=</span> <span class="mi">15</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render</span><span class="p">()</span>
</span><span class='line'>      <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>          <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:mco_cmd</span> <span class="k">do</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;command&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Creating mco agent and data description file for </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Create Agent .rb File</span>
</span><span class='line'>  <span class="n">agent</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_agent_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="n">ddl</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_ddl_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ddl</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to agent: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to ddl: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>As you can see, I wrote my Class into the Rakefile itself. It wasn&rsquo;t long and let me have some clarity, so there wasn&rsquo;t a need to break it out.</p>




<p>The McoAgent Class accepts two attributes, command and template. Pass it a command and a template, for me I have a couple of def&rsquo;s that do this for the agent and ddl respectavely, and it builds out the ERB for us. My init def just declares the variables that we want available to our templates and we&rsquo;re good to go - the rest is accomplished via the ERB library.</p>




<p>The entire project repo is available <a href="https://github.com/malnick/rake_tasks/tree/master/mco_create_agent">here</a></p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-08-31T08:16:59-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>8:16 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/">Deploying .box Files From VirtualBox for Vagrant</a></h2>
  
  <p>
    <p>There are several tools available that streamline the production of the .box format for Vagrant from any open virtualization format (OVF).</p>




<ol>
<li><a href="www.packer.io">Packer</a>
Enables you to boot a given image from an easy to build template. You can provision the machine using many types of configuration management tools such as Puppet and Chef, and run post-installer scritps for anything else.</li>
</ol>




<p>The Templates are easy to use and you can push out a .box file from Packer directly.</p>




<ol>
<li><a href="https://github.com/jedi4ever/veewee">Veewee</a>
Easily converts an ISO to VM formats. Kinda like Packer but not, so Packer made <a href="http://www.packer.io/docs/templates/veewee-to-packer.html">this</a> tool to solve that problem.</li>
</ol>




<h2>My own tool</h2>




<p>Jeff, why would you ever build your own tool when so many others exist? Because I hate troubleshooting other peoples tools. If you&rsquo;ve ever used Packer for anything serious, you could empathize/understand why I want to build my own tool.</p>




<p>What do I want to do?</p>




<ol>
<li>Easily turn any VirtualBox registered VM on my host machine into a .box file and add it to Vagrant.</li>
<li>Deploy it in 1 command.</li>
</ol>




<h2>Architecture</h2>




<p>A Rakefile that calls to sub .task files in a subdir to create then build out the machine.</p>




<p>The top level Rakefile will allocate class variables such as directory strucutre, arrays and hashes used by the lower .task files. It will allocate ENV variables, in particular <code>VM_USER</code> and <code>VM_PASSWORD</code> to be used by the lower .tasks. It will also ensure all environment dependencies such as gems and programs are installed properly.</p>




<h2>Rakefile</h2>




<p>We&rsquo;ll start with the top level Rakefile and work our way down:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during load, running bundler&quot;</span>
</span><span class='line'>  <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundler&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Load the subtasks</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;tasks/*.rake&#39;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set top level dir for sub level rake tasks</span>
</span><span class='line'><span class="vi">@cwd</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure we have some deps</span>
</span><span class='line'><span class="n">gems</span> <span class="o">=</span> <span class="sx">%w(net-ssh)</span>
</span><span class='line'><span class="n">gems</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> gem not found, installing...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to install gem: </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="o">=</span> <span class="sx">%w(vboxmanage)</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which </span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to find the executable &#39;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&#39;, please make sure it&#39;s installed.&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:vm</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;create&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>The comments are self explanitory. We do some basic enviro checks, declare some class variables and load up the subtask files.</p>




<p>Since this is <em>my</em> tool I can do whatever I want. This is going to be a super streamlined process, I only need it to work with VirtualBox so I don&rsquo;t need to get too crazy. I can basically rely on the <code>vboxmanage</code> command line tool to interact with the VM.</p>




<p><strong><em>DISCLAIMER:</em></strong> I originally was going to leverage the <a href="http://net-ssh.github.io">Net::SSH</a> ruby library to run all my post-processing on the VM. I needed some way to SCP scripts to the VM and execute them. Originally I used <code>vboxmanage</code> to get the IP address of the VM, then <code>Net::SSH</code> to SCP and execute commands. I had some methods all worked out for this, but then I ralized this needed to work on the VirtualBox NAT&#8217;ed network.</p>




<p>Ouch.</p>




<p>It would not reliably get a proper IP address and I also needed to do some fancy reverse SSH tunneling to SCP and execute with <code>Net::SSH</code>. I struggled with this for an hour or two and realized my desire to use all Ruby libs to do this interaction was going to be more trouble than it was worth. I instead decided to use the <code>vboxmanage</code> subset of tools that will actually copy data to the VM and execute the data. I re-wrote my copy and execute methods but still kept the <a href="https://github.com/malnick/create-vagrant-box/blob/master/extras/netssh_test.rb">Net::SSH code for later reference</a> since it&rsquo;s super handy.</p>




<h2>Create</h2>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/ruby</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build a Vagrant box from a vBox VM&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Vars </span>
</span><span class='line'>  <span class="vi">@vmhash</span>     <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="vi">@vmname</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_NAME&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmuser</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_USER&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmpwd</span>      <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_PWD&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">guestiso</span> <span class="o">=</span> <span class="s1">&#39;4.3.8&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Get the guest edition ISO</span>
</span><span class='line'>  <span class="n">vboxexists</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span> <span class="n">vboxexists</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Would you like to install the defualt version of guest editions? [</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">] [y/n]&quot;</span>
</span><span class='line'>      <span class="n">installdefault</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">installdefault</span> <span class="o">=~</span> <span class="sr">/^y/</span>      
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest editions version </span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading the guest editions iso.&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the building of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span><span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s1">&#39;Aborting.&#39;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which version would you like to use? [x.x.x]&quot;</span>
</span><span class='line'>          <span class="n">installversion</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest edition version </span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the buidling of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span> <span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s2">&quot;Aborting.&quot;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Create a hash of vBox VMs</span>
</span><span class='line'>      <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">vms</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list vms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vms</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="nb">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
</span><span class='line'>          <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># how many vm&#39;s do we have available?</span>
</span><span class='line'>      <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="vi">@vmhash</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>              <span class="vi">@vmmax</span> <span class="o">=</span> <span class="n">i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Method to find if VM_NAME matches our hash listing</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">findvm</span><span class="p">()</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span>
</span><span class='line'>              <span class="nb">test</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">v</span> <span class="k">if</span> <span class="vi">@vmname</span> <span class="o">=~</span> <span class="sr">/test/</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>      
</span><span class='line'>
</span><span class='line'>      <span class="c1"># If a VM_NAME was given, don&#39;t list them but check to make sure it&#39;s a good name</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">!</span> <span class="vi">@vmname</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which vBox VM would you like to vagrantize? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>          <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Range check&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>          <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> found with actual name: </span><span class="si">#{</span><span class="n">vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> not found, available vm&#39;s for building are:&quot;</span>
</span><span class='line'>              <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Which VM would you like to use? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>              <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>                  <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<ol>
<li><p>Check for vBox guest editions locally: I needed to make sure I had guest editions locally, if I didn&rsquo;t I would prompt to download the most recent release or give myself the option to install a different version.</p></li>
<li><p>Get a list of all the registered VirtualBox VM&rsquo;s on the host: Get the list, create a hash that I can easily choose from with a numbered key.</p></li>
<li><p>Override the previous step if the <code>VM_NAME</code> ENV was given at runtime, ensure this matches with an actual VM registered in the list anyways.</p></li>
<li><p>Run <code>``Rake::Task['build'].excute</code></p></li>
</ol>




<h2>Build</h2>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build the vBox VM with Vagrant parameters&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:build</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>          <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>          <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>                  <span class="kp">true</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>                  <span class="kp">nil</span> 
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>          <span class="nb">exit</span> <span class="mi">1</span>          
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>      <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrantizing </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1"># Start the VM</span>
</span><span class='line'>  <span class="n">start</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;vboxmanage startvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@proc_id</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">pid</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Process ID for VM: </span><span class="si">#{</span><span class="vi">@proc_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Waiting to bring up machine...&quot;</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># The main loop</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">vmrunning?</span>
</span><span class='line'>      <span class="c1"># Get VM IP Address</span>
</span><span class='line'>      <span class="n">vminfo</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/IP/</span>
</span><span class='line'>              <span class="n">arry</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="vi">@vmip</span> <span class="o">=</span> <span class="n">arry</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to become ready...&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy scripts dir to a locally accessible place</span>
</span><span class='line'>      <span class="n">scripts</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/scripts/*.sh&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Script dir: </span><span class="si">#{</span><span class="n">scripts</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">scripts</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="n">vmcp</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">geiso</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/*.iso&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy guest editions over</span>
</span><span class='line'>      <span class="n">geiso</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">iso</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vagrant.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vboxguest.sh&quot;</span><span class="p">)</span>   
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/compact.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vagrant.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vboxguest.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/compact.sh&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># </span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage controlvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> poweroff&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to shutdown vm&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to shutdown.&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Packing vm...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant package --base </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="nb">abort</span> <span class="s2">&quot;Failed to package the vm.&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;All done.&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;VM package available at:&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/package.box&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>      <span class="c1">#Process.kill(@proc_id) and exit 0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Package the box up</span>
</span><span class='line'>  <span class="c1"># vagrant package --output centos-6.5-x86_64.box --base centos-6.5-x86_64 &lt;-- example.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>So, that first method is what I&rsquo;m going to wrap this entire program in - as long as the VM is running, lets copy some scripts to it, ensure they can be executed, then execute them.</p>




<h3>vmrunning?()</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>      <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>              <span class="kp">true</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Pop open a vboxmanage process to list out the running VM&rsquo;s, ensure our VM exists there.</p>




<h3>vminfo()</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>  <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Super simple, use vbox manage to get a listing of VM data using <code>guestproperty enumerate</code>. I used the <code>.readlines</code> method so I could iterate it into an array easily.</p>




<h3>vmcp(locpath)</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Use the guestcontrol command for vboxmanage to copy stuff from my host to the guest. Copies it to <code>/root</code> by default.</p>




<h3>vmexec(cmd)</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Execute commands without arguments on the guest VM. Handy for running my scripts after I copy them over or changing file permissions.</p>




<h3>vmexec_with_args(cmd, args)</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Do the exec with arguments if needed.</p>




<h2>Execute some scripts on the VM, exit, package the .box</h2>




<p>The rest of the script is pretty straight forward. I drop into my <code>unless vmrunning?()</code> loop, copy over my scripts, run some <code>chmod</code> commands and execute them.</p>




<p>The scripts setup the Vagrant user and environmnent then install vBox Guest Editions and shutdown the VM once the scripts complete.</p>




<p>Then it&rsquo;s simply a matter of using the <code>vagrant package --base</code> command on the box <strong><em>with the correct box timecode attached to it</em></strong>. (that last bit is completely undocumented).</p>




<h2>Complete Project</h2>




<p><a href="https://github.com/malnick/create-vagrant-box/">Available Here</a></p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-08-03T17:22:54-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>5:22 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/07/21/agile-dev-environment-for-puppet-code/">Agile Dev Environment for Puppet Code</a></h2>
  
  <p>
    <p>When ever I am creating a new Puppet module or working on someone else&rsquo;s Puppet module I constantly look for ways to make more efficient the development process.</p>




<p>It may not seem like a lot of time but all those &lsquo;vagrant up&rsquo; &lsquo;vagrant destroy&rsquo; &lsquo;git pull&rsquo; &lsquo;git commit&rsquo; &lsquo;&hellip;push, branch&hellip;&rsquo; etc turn into a lot of time wasted.</p>




<p>What I need is an easy way to pull in git-based (or forge-based) modules to a VM and have them available locally to edit with my favorite editor.</p>




<p>This environment needs to satisfy these needs:</p>




<ol>
<li>I can edit my code on my host machine in my favorit editor (vim) which has all my favorite plugins</li>
<li>The code is live on the VM, sym linked from the VM to my host so I don&rsquo;t have to git push/pull to update the VM (or some other jank process)</li>
<li>I can easily deploy many modules/dependances for the code to the VM with a simple Rake command</li>
</ol>




<h2>Solution</h2>




<p>To solve this development issue I forked a loanly project from nval0. It was a basic Rakefile which was using Puppet-librarian to pull in modules from a Puppetfile.</p>




<p>The environment used:</p>




<ol>
<li>Puppet librarian for module management via Puppetfile</li>
<li>Vagrant VMs</li>
<li>Wrapped up some of the commands into a Rakefile (gem prereq&rsquo;s etc)</li>
</ol>




<p>After playing with this environment for a bit I realized some drawbacks:</p>




<ol>
<li>Puppet-librarian only worked on ruby 1.9</li>
<li>I wanted a rake task to &lsquo;deploy&rsquo; everything in the Puppetfile to sym-linked dir to the VM</li>
</ol>




<p>The first draw back was easily solved, instead of using Puppet-librarian I&rsquo;d use <a href="https://github.com/adrienthebo/r10k">r10k</a>. R10k builds off of Puppet-libarian and is most often used to map git branches for any Puppet module to local Puppet environments on a Puppet Master. However, you can use it in a similar fashion to Puppet-libarian where it only reads a Puppetfile then pulls in those modules directly. The great thing is it works on all major releases of Ruby so my dev environment will not need rbenv or another ruby environment manager.</p>




<h3>Let&rsquo;s put this together into some rake tasks:</h3>




<p>An example rake task to deploy the Puppetfile modules with r10k:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>This first rake task uses r10k to read the Puppetfile and pull down the modules listed in it to the module directory.</p>




<p>Let&rsquo;s link this directory into the VM via the Vagrantfile, this way we can edit the code locally on the host while having it available to run on the Master VM:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Why did I use the shell provisioner to sym link /tmp/modules and /tmp/manifests to <code>$confdir/modules</code> and <code>$confdir/manifests</code>?</p>




<p>The pe_build plugin for Vagrant will provision the master using the default Puppet Enterprise installer. However, the installer will fail if any PE-related directories already exist (/opt/puppet or /etc/puppetlabs for example).
To get around this, and still have live dir&rsquo;s provisioned on the VM I couldn&rsquo;t use the vagrant <code>synced_folder</code> method since that will run before the provisioners run (vagrant needs to build the machine before running any type of configuration managment on it) - the PE installer will blow up when the plugin runs since I have to sync into /etc/puppetlabs/puppet.</p>




<p>So instead of syncing into a PE-specific PATH I sync into /tmp, and then when the provisioner finishes (provisioners are ran in order) I can sym link the PE-specific module and manifests dir&rsquo;s from /tmp.</p>




<h3>Complete Vagrantfile:</h3>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="no">Rakefile</span> <span class="n">that</span> <span class="n">wraps</span> <span class="n">up</span> <span class="n">some</span> <span class="n">deploy</span> <span class="n">commands</span> <span class="ow">and</span> <span class="n">a</span>
</span><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.2.3&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Agent </span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now I have an easy to use Vagrantfile that can boot my master with sym linked module and manifests dirs and an agent to test on.</p>




<p>Now we need to finish out that Rakefile, adding in some dependancy checks and some tasks to setup, deploy, pull (modules on the fly) and destroy as needed:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;os&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;ptools&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during requires: </span><span class="se">\t</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this problem by running &#39;bundle&#39;.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">&#39;deps&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">necessary_programs</span> <span class="o">=</span> <span class="sx">%w(VirtualBox vagrant)</span>
</span><span class='line'><span class="n">necessary_plugins</span> <span class="o">=</span> <span class="sx">%w(vagrant-auto_network vagrant-pe_build vagrant-vmware-fusion)</span>
</span><span class='line'><span class="n">necessary_gems</span> <span class="o">=</span> <span class="sx">%w(bundle r10k)</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Check for the environment dependencies&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deps</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;Checking environment dependencies...&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Is this a POSIX OS?...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">OS</span><span class="o">.</span><span class="n">posix?</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Sorry, you need to be running Linux or OSX to use this Vagrant environment!&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_programs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prog</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for %s...&quot;</span><span class="p">,</span> <span class="n">prog</span>
</span><span class='line'>    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry but I didn&#39;t find require program </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">prog</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> in your PATH.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for vagrant plugin %s...&quot;</span><span class="p">,</span> <span class="n">plugin</span>
</span><span class='line'>    <span class="k">unless</span> <span class="sx">%x{vagrant plugin list}</span><span class="o">.</span><span class="n">include?</span> <span class="n">plugin</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the Vagrant plugin </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running &#39;rake setup</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for Ruby gem %s...&quot;</span><span class="p">,</span> <span class="n">gem</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> gem on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running </span><span class="se">\&#39;</span><span class="s2">gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Checking for additional gems via &#39;bundle check&#39;...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Congratulations! Everything looks a-ok.&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Install the necessary Vagrant plugins&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:setup</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant plugin install </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundle install&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up master agent1&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Access master at &#39;vagrant ssh master&#39; or &#39;ssh vagrant@10.10.100.100&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Password = vagrant&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Puppet modules brought in via puppet/Puppetfile are available on the Vagrant master VM at /etc/puppetlabs/puppet/modules&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Contact git owner for PR&#39;s &amp; bug fixes&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Done.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Destroy Vagrant Machines&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:destroy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Are you sure you want to destroy the environment? [y/n]&quot;</span>
</span><span class='line'>  <span class="no">STDOUT</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant destroy -f&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Aborting vagrant destroy, exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>      
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p><a href="https://github.com/malnick/puppet-module-devtest-skeleton/tree/malnick">Entire project</a> is available on git.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-07-21T12:15:51-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>12:15 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/07/14/managing-git-repos-over-jump-hosts-using-persistant-sockets/">Managing Git Repos Over Jump Hosts Using Persistant Sockets</a></h2>
  
  <p>
    <p>I was recently helping a customer who had a somewhat complicated git workflow to production. All their Puppet code was in a locally accessible Gitlab server which was used by all the Automation dev&rsquo;s to develop, test and push to.</p>




<p>However, their integration and production environments were located behind a jumphost which also required a custom VPN connection.</p>




<p>The problem was that this deployment relied on <a href="https://github.com/adrienthebo/r10k">r10k</a> and the Puppet master needed access to the Gitlab server to create the local environments in both integration and eventually production.</p>




<p>Enabling a streamlined process to move the Gitlab codebase from our dev area into the corralled VM behind the jumphost was needed.</p>




<p>This workflow involves several steps:</p>




<ol>
<li>Connect NA Client VPN to Jumphost</li>
<li>SSH to Jumphost and enter auth credentials</li>
<li>SSH into yum repo server behind jumphost</li>
<li>Enter in yum repo auth credentials</li>
<li>scp your data - many ways to skin that cat, all are somewhat complicated</li>
</ol>




<h2>Automate with persistant SSH sockets</h2>




<p>I decided to write a SSH script which will do this, and I wanted to ensure we didn&rsquo;t fall into &lsquo;password&rsquo; hell and have to enter in a new password every time. I had heard you could do this by using the &lsquo;ControlMaster&rsquo; SSH param in SSH_config, open a persistant socket, and reuse it as needed. If I could enable this over a jumphost was another question but I gave it a shot.</p>




<ol>
<li><p>Create a persistant socket to jumphost with tunnel on localhost through the jumphost, pushing traffic from port 22 -> 5000</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/jump.sock' -N -f -L 5000:[git_repo_ip]:22 root@[jumphost_ip]
</code></pre></li>
<li><p>Create a direct persistant socket to the integration or production Gitlab server on localhost tunnel</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/git.sock' -N -f root@localhost -p 5000
</code></pre></li>
<li><p>CP arbitrary documents easily</p>

<p> scp -o &lsquo;ControlPath ~/.ssh/yum.sock&rsquo; -P 5000 $filepath root@localhost:/tmp/</p></li>
<li><p>SSH (no password required once socket is created!)</p>

<pre><code> ssh -S ~/.ssh/yum.sock root@localhost -p 5000
</code></pre></li>
<li><p>To destroy the sockets you need to do the yum repo first and jump second</p>

<pre><code> ssh -S ~/.ssh/yum.sock -O exit root@localhost &amp;&amp; ssh -S ~/.ssh/jump.sock -O exit root@172.20.100.11
</code></pre></li>
</ol>




<h2>A quick script</h2>




<p>Now that I can create persistant sockets I wrote a script to SSH into the local git, run <code>rake::restore</code>, scp the backup to my host, scp the backup from my host into the integration git over the jumphost connection, and run rake::restore.</p>




<ol>
<li><p>Check to ensure I&rsquo;m connected to the correct VPN Gateway</p>

<p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> VPNENV=<code>echo $(naclient status | awk &amp;#39;NR==4&amp;#39; | cut -d: -f2)</code></span>
</span><span class='line'><span class="sr"> VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr"> LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr"> INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr"> JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr"> then</span>
</span><span class='line'><span class="sr">     echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'><span class="sr"> </span>
</span></code></pre></td></tr></table></div></figure></p></li>
<li><p>Build the sockets</p>

<p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">echo</span> <span class="s2">&quot;Connecting to local git:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to jumphost:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/jump.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">L</span> <span class="vg">$PORT</span><span class="p">:</span><span class="vg">$INTGIT</span><span class="p">:</span><span class="mi">22</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to git in integration:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;UserKnownHostsFile /dev/null&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span><br/>
</span><span class='line'><br/>
</span></code></pre></td></tr></table></div></figure></p></li>
<li><p>Use the sockets for SSH and SCP</p>

<p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">create</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="s2">&quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'><br/>
</span></code></pre></td></tr></table></div></figure></p></li>
</ol>




<p>A note before moving on about the &lsquo;stagelatest&rsquo; function. I had a complicated command that I didn&rsquo;t want to toss into the SSH line, so I wrote a fuction and ran the <code>$(typeset -f)</code> command to make that function available on the remote SSH shell executing the commands. The function looked like this:</p>




<pre><code>&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;figure class='code'&gt;&lt;div class="highlight"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre class="line-numbers"&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
</code></pre>




<p><span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n"><em>gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n"></em>gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><br/>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>




<p>Continuing with our SCP and SSH commands:</p>




<pre><code>&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;figure class='code'&gt;&lt;div class="highlight"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre class="line-numbers"&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
</code></pre>




<p><span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span><span class="ss">:/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">1111111111</span><span class="n"><em>gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="sr">/tmp/</span>
</span><span class='line'>  <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n"></em>gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'><br/>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>




<h2>The final script</h2>




<p>My final script includes a cleanup() function that is exectued via <code>trap</code> and at the end of the script on a good run. Cleaning up the sockets and ensuring nothing is left is always good practice.</p>




<p>I also modified my SSH commands to not use the known_hosts file. This way I could reuse the tunnle on localhost:5000 to other jumphost connections inside the corralled integration or production environments. Had I used the known_hosts file every time and not pipped it to <code>/dev/null</code>, everytime I reused localhost:5000 to tunnel to a new server behind the jumphost the public key would change and SSH would think someone is trying to do something funny.</p>




<p>I also include some more logic to really make sure that the rake::restore should run on the integration/production gitlab server. Nerver hurts to double check!</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'><span class="n">cleanup</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Cleaning up sockets and exiting&quot;</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$GITLAB</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="vi">@localhost</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="vg">$@</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">trap</span> <span class="n">cleanup</span> <span class="no">SIGHUP</span> <span class="no">SIGINT</span> <span class="no">SIGTERM</span>
</span><span class='line'>
</span><span class='line'><span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">getport</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">5000</span> <span class="p">))</span>
</span><span class='line'>  <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]${PORT}</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">[[</span> <span class="s2">&quot;$CHECK&quot;</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Port: $PORT is in use by another process, choosing another port.&quot;</span>
</span><span class='line'>      <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">port</span> <span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]$PORT</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="n">done</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Setting port to $PORT&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">getport</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr">VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr">VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr">LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr">INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr">JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr">then</span>
</span><span class='line'><span class="sr"> echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> echo &quot;Connecting to local git:&quot;</span>
</span><span class='line'><span class="sr"> ssh -o &#39;ControlMaster auto&#39; -o &#39;ControlPath ~/</span><span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f root@$LOCALGIT </span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to jumphost:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f -L $PORT:$INTGIT:22 root@$JUMPHOST</span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to git in integration:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -o &#39;</span><span class="no">UserKnownHostsFile</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="s1">&#39; -N -f root@localhost -p $PORT</span>
</span><span class='line'>
</span><span class='line'><span class="s1"> # SSH LOCALGIT and run rake backup, scp latest backup to host </span>
</span><span class='line'><span class="s1"> echo &quot;Running gitlab:backup:create&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT gitlab-rake gitlab:backup:create</span>
</span><span class='line'><span class="s1"> echo &quot;Staging backup in /tmp&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT &quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'><span class="s1"> echo &quot;Copying over from lab git to localhost&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; root@$LOCALGIT:/tmp/1111111111_gitlab_backup.tar /tmp/</span>
</span><span class='line'><span class="s1"> echo &quot;Copying lab git backup from localhost to integration git server&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Would you like to run restore on the integration server now?&quot;</span>
</span><span class='line'>  <span class="n">read</span> <span class="n">restore</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="vg">$restore</span> <span class="o">=~</span> <span class="o">^</span><span class="n">y</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Running restore on integration git server&quot;</span>
</span><span class='line'>      <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Not running restore&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Backup located at /var/opt/gitlab/backups/1111111111_gitlab_backup.tar&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;To backup manually run:&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;BACKUP=1111111111_gitlab_backup.tar gitlab-rake gitlab:backup:restore&quot;</span>
</span><span class='line'>  <span class="n">fi</span>
</span><span class='line'>  <span class="n">cleanup</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;VPN Enviro not correct, connected to: $VPNENV&quot;</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Check VPN connection to data_center, or start NA Client&quot;</span>
</span><span class='line'>  <span class="n">cleanup</span> <span class="mi">1</span>
</span><span class='line'><span class="n">fi</span>
</span></code></pre></td></tr></table></div></figure>




<p>The final script can be pulled down from <a href="https://github.com/malnick/scripts/blob/master/connect.sh">my github account</a>.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-07-14T07:09:09-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:09 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/06/24/a-simple-nagios-docker-plugin/">A Simple Nagios Docker Plugin</a></h2>
  
  <p>
    <p>Docker is an amazing tool with a lot great functional command line interfaces. A typical docker deployment might have a webapp running inside a container. In order to observe the beahvior of this container you might want to setup a Nagios plugin to monitor log output.</p>




<p>To do this I am going to do the following:</p>




<ol>
<li>Deploy an Ubuntu Precise VM on 10.10.33.2 via Vagrant</li>
<li>Provsion the VM with Puppet using the Vagrant Puppet provisioner:

<ol>
<li>Installs docker using garethr-docker</li>
<li>Installs the training/webapp image</li>
<li>Runs the container using an exec</li>
<li>Installs nagios and my ruby plugin to monitor the docker service and the training/webapp image for the following:

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>




<h2>The Vagrantfile</h2>




<p>I start with a basic Vagrantfile to deploy an Ubuntu Precise VM:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:nagios</span> <span class="k">do</span> <span class="o">|</span><span class="n">deploy</span><span class="o">|</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;precise64&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;nagios.server.dev&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://files.vagrantup.com/precise64.box&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/manifests&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.33.2&quot;</span> <span class="c1"># Define static IP once dev completes</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span><span class="p">,</span> <span class="ss">:module_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="ss">:manifests_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="ss">:manifest_file</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy_nagios.pp&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Puppet Provisioner</h2>




<p>In order to provision the VM on boot I used the Puppet provisioner which ships with Vagrant. For testing purposes I like to sync my manifests and modules directory to the VM. Usually I run a bash script before provisioning with Puppet to install from the Puppet Labs apt or yum repos, however for this project that wasn&rsquo;t neccessary as the goal is to have a quickly bootable dev environment for my Nagios server and Docker container.</p>




<p>The <code>deploy_nagios.pp</code> manifest looks like this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Deploy docker and an Ubuntu image to play with</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span><span class="s1">&#39;docker&#39;</span><span class="p">:}</span>
</span><span class='line'><span class="ss">docker</span><span class="p">:</span><span class="ss">:image</span> <span class="p">{</span> <span class="s1">&#39;training/webapp&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Super hero hack to run the docker image... see readme for why.</span>
</span><span class='line'><span class="c1"># Also, in no way is this idempotent, if it&#39;s running it&#39;ll fail.</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/docker run -d -p 5000:5000 training/webapp python app.py&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="ss">Docker</span><span class="p">:</span><span class="ss">:Image</span><span class="o">[</span><span class="s1">&#39;training/webapp&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#docker::run { &#39;webapp&#39;:</span>
</span><span class='line'><span class="c1">#  image   =&gt; &#39;ubuntu&#39;,</span>
</span><span class='line'><span class="c1">#  command =&gt; &#39;/bin/echo test&#39;,</span>
</span><span class='line'><span class="c1">#  require =&gt; Docker::Image[&#39;training/webapp&#39;],</span>
</span><span class='line'><span class="c1">#}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Update this thing</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="p">:}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Install nagios </span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="o">]</span><span class="p">,</span><span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Get my plugin on the system correctly</span>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:plugin</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;nagios/nagios-plugins/docker_status.rb&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># WARNING: TOTAL HACK PLEASE DON&#39;T JUDGE ME</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/bin/echo &quot;command[docker_status]=/usr/lib/nagios/plugins/docker_status&quot; &gt;&gt; /etc/nagios/nrpe.cfg&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nagios/nrpe.cfg&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span> <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure docker and nagios are in the same group</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s1">&#39;/usr/sbin/usermod -a -G docker nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:command</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">command_line</span> <span class="o">=&gt;</span> <span class="s1">&#39;$USER1$/check_nrpe -H $HOSTADDRESS$ -c docker_status&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set the nagiosadmin password </span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/htpasswd -cb /etc/nagios3/htpasswd.users nagiosadmin nagiosadmin&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># I wrote my plugin in Ruby so lets make sure the VM has it. </span>
</span><span class='line'><span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;ruby1.9.1&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Yup, I had a couple of hero hacks in there to get around some issues with the <code>docker::run</code> define. That define should work, but  kept failing with a very odd &lsquo;&lt;&lt; is not a {}:hash&rsquo; error. I grep&#8217;ed through the module to try and find where this was coming from and I think it&rsquo;s a heredoc within a function for the define. I still need to look into it. I ran an exec after the image is downloaded to get around this problem.</p>




<p>I also hero hacked the update to the <code>nrpe.cfg</code> file as the Nagios module I used didn&rsquo;t make it clearly evident how or if it did this.</p>




<p>&hellip; In no way do any of these hacks make me an &ldquo;inpatient&rdquo; person.</p>




<h2>The Nagios Plugin</h2>




<p>Recall my plugin should monitor:</p>




<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>




<h3>Let&rsquo;s break it down</h3>




<h4>Nagios Basics:</h4>




<p>First, let&rsquo;s define some basic outputs for the Nagios API. Since Nagios is only looking for specific exit codes from any given script we define those as methods here first.</p>




<pre><code>0 = OK
1 = Shit is potentially hitting the fan
2 = Shit is hitting the fan
3 = Unknown shit is happening
</code></pre>




<h4>The first part of my Plugin defines these:</h4>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<h4>Check to ensure docker is installed</h4>




<p>Now let&rsquo;s check to ensure Docker is installed, we can use a simple <code>system()</code> method which returns exit codes only:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Yup, it&rsquo;s that easy, <code>which docker</code> will return &lsquo;0&rsquo; or &lsquo;false&rsquo; if it does not find the command and &lsquo;1&rsquo; or &lsquo;true&rsquo; if a path to the command is found. This isn&rsquo;t the most robust check ever, but for now it&rsquo;s enough to move on. Since all my other def&rsquo;s work on the <code>docker</code> face and it&rsquo;s sub commands I need to ensure this is present before doing anything else.</p>




<h4>Check the webapp status</h4>




<p>First, I want to make sure the webapp is running on the VM on a specific port. I&rsquo;m going to use a <code>netstat</code> command and <code>awk</code> to return the process running on port 5000:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span></code></pre></td></tr></table></div></figure>




<p>This should return this this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# netstat -anp | grep 5000 | awk <span class="s1">&#39;{print $7}&#39;</span> | cut -d/ -f2
</span><span class='line'>docker
</span></code></pre></td></tr></table></div></figure>




<p>Then we pass this into some basic &lsquo;if&rsquo; logic:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span></code></pre></td></tr></table></div></figure>




<p>Lot&rsquo;s of things are happening there.</p>




<p>1st, if &lsquo;docker&rsquo; is the output of the webapp status command we drop into another loop. This loop runs a <code>check_this</code> command that is derived from the <code>docker log</code> face. That particular face feeds the output from a sys-log-like to the terminals stdin.</p>




<p>But first, <code>docker logs</code> needs to have the process hash of the container you want to query, so I run a <code>docker ps -l</code> and <code>awk</code> for the hash of the process I want.</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# docker ps -l
</span><span class='line'>CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS              PORTS                    NAMES
</span><span class='line'>c968cced9f32        training/webapp:latest   python app.py       33 minutes ago      Up 33 minutes       0.0.0.0:5000-&gt;5000/tcp   berserk_pare
</span></code></pre></td></tr></table></div></figure>




<p>This would definitely break if you had many containers running.</p>




<p>So anyways, if we have that hash we can now pass it to <code>docker logs</code> like I did in the ruby script like this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span><span class="vi">@nagios</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="c1"># docker logs c968cced9f32</span>
</span><span class='line'> <span class="o">*</span> <span class="no">Running</span> <span class="n">on</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>




<p>Tight.</p>




<p>Now that I have access to the log from the webapp I can grep URL&rsquo;s which have 404 errors, add those to a hash as k,v&rsquo;s and then iterate over the hash for the key with the largest value.</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>  <span class="k">end</span>  
</span><span class='line'>  <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>  <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span></code></pre></td></tr></table></div></figure>




<p>Now I can use that key&rsquo;s value to hit my <code>warning</code> or <code>critical</code> methods.</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'><span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>Of course, the end to this giant loop of loops does&hellip;</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>&hellip; and finally start it</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<p>My entire script looks like this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Full </span>
</span><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Check to ensure docker is installed</span>
</span><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-06-24T12:19:43-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:19 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/06/03/continuous-integration-with-puppet-code/">Continuous Integration With Puppet Code</a></h2>
  
  <p>
    <iframe src="http://www.slideshare.net/slideshow/embed_code/35435020" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>




<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/malnick/continuous-integration-withpuppet" title="Continuous integration with_puppet" target="_blank">Continuous integration with_puppet</a> </strong> from <strong><a href="http://www.slideshare.net/malnick" target="_blank">malnick</a></strong> </div></p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-06-03T07:54:12-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>7:54 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/30/what-is-this-module-doing/">What Is This Module Doing?</a></h2>
  
  <p>
    

  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-30T15:58:12-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:58 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/29/packer-templates-and-vmware/">Packer Templates &amp; VMWare</a></h2>
  
  <p>
    <h2>tl;dr</h2>




<p>There&rsquo;s not a lot of docs on Packer and the logging can be tricky to find sometimes depending on the vm you&rsquo;re booting (which provider backs it). If you&rsquo;re using VMWare and you&rsquo;re booting centos the <code>guest_os_type</code> key needs to be set appropriatly.</p>




<p>Some people seem to think this can be $anything that sounds reasonable (I did!) and there is no documentation on what should actually go there (as of writing this, Google was sparce). So if you have a doubt on what the <code>guest_os_type</code> value should be the best bet is to <code>$ diff</code> it with an already existing <code>*.your_vm_type</code> (&lsquo;vmx&rsquo;, &lsquo;ovf&rsquo;, et cetera).</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>




<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>For CentOS at least, your <code>guest_os_type</code> value should be set to <code>redhat</code>.</p>




<h2>Back Story</h2>




<p>This week I was working with a customer to automate the deployment of some VM&rsquo;s to vSphere. This deployment is replaceing some current scripts and manually configured templates. Actually, a lot of scripts and manually configured templates.</p>




<p>The long and the short of it, me and my team decided to implement Vagrant and Packer to push out pre-written Packer templates to vSphere via Vagrant&rsquo;s vSphere plugin using the VMWare provider.</p>




<p>After scripting the json for this node I ran <code>packer build centos65.json</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying <span class="nv">ISO</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying ISO
</span><span class='line'>vmware-iso: Downloading or copying: http://mirrors.kernel.org/centos/6.5/isos/x86_64/CentOS-6.5
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Creating virtual machine <span class="nv">disk</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Building and writing VMX <span class="nv">file</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting HTTP server on port <span class="nv">8582</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting virtual machine...
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Deleting output directory...
</span><span class='line'>Build <span class="s1">&#39;vmware-iso&#39;</span> errored: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; Some builds didn<span class="err">&#39;</span>t <span class="nb">complete </span>successfully and had errors:
</span><span class='line'>--&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; Builds finished but no artifacts were created.
</span></code></pre></td></tr></table></div></figure>




<p>The vm booted into fusion and opened but failed in <code>vmrun</code>. How did I know that was the issue?</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grep -r vmrun /var/log/*
</span><span class='line'>system.log:May 29 05:30:32 bohr vmrun<span class="o">[</span>13249<span class="o">]</span>: com.vmware.fusion.78704: Invalid argument
</span><span class='line'>... <span class="c"># lots of other crap </span>
</span></code></pre></td></tr></table></div></figure>




<p>BUT WHAT ARGUMENT???</p>




<p>After digging around I found that logging for this issue was sketchy at best. Syslog, <code>/var/tmp/vmware</code>, the <code>guest_os_type</code> key needs to have an appropriate value (i.e., arugment from syslog):</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>




<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>After changing the k,v in the json template and running <code>packer build</code> the vmrun command ran successfully.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-29T12:19:53-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:19 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/16/r10k-control-repos.markdown/">R10k: Control Repos</a></h2>
  
  <p>
    <p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<h2>What is a control repo?</h2>

<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>

<h3>What does it contain?</h3>

<pre><code>hieradata/
Puppetfile
</code></pre>

<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis - it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>

<h2>How does it work?</h2>

<p>The control repo is placed in a monolithic git repository.</p>

<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>

<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>

<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>

<p>Populate your Puppetfile with what ever crap you need.</p>

<p>In <code>$confdir</code>:</p>

<pre><code class="bash">git init
git remote add origin git@whatever.com:your_name/control_repo.git
git branch -m master production
git add Puppetfile
git add hiera.yaml[root@master puppet] r10k really doesn't need this but we'll add it anyways. 
git add hieradata/
git push -u origin production:production[root@master puppet] or whatever branch, maybe production?
</code></pre>

<h3>Configure hiera.yaml for dynamic environments</h3>

<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used - therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>

<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>

<pre><code class="yaml">---
:backends:
  - yaml
:hierarchy:
  - "%{clientcert}"
  - "%{environment}"
  - global

:yaml:
  :datadir: '/etc/puppetlabs/puppet/environments/%{::environment}/hieradata'
</code></pre>

<h3>Branching your Puppetfile</h3>

<p>For example, assuming you already have a master or production branch:</p>

<pre><code class="bash">vi Puppetfile
</code></pre>

<p>&hellip;add some git modules etc&hellip;</p>

<pre><code class="bash">git checkout -b development
git push origin development:development
git commit -am Puppetfile
r10k deploy environment -pv
</code></pre>

<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>

<h3>Branching your hiera data</h3>

<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>

<pre><code class="bash">cd $confdir/hieradata
</code></pre>

<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>


<pre><code class="bash">git branch[root@master puppet] check your branch, make sure it's still development
git commit -am hieradata
git push 
r10k deploy environment -pv
</code></pre>

<p>Check <code>$confdir/environments/development/hieradata</code></p>

<h2>Testing</h2>

<h3>Configuration files for r10k, hiera, puppet:</h3>

<h4>/etc/r10k.yaml</h4>

<pre><code class="bash">root@master hieradata]# cat /etc/r10k.yaml
:cachedir: /var/cache/r10k
:sources:
  puppet:
    remote: "git@10.10.100.111:user/control_repo.git"
    basedir: /etc/puppetlabs/puppet/environments
    prefix: false
:purgedirs:
  - ""
</code></pre>

<h4>/etc/puppetlabs/puppet/puppet.conf</h4>

<pre><code class="bash">[root@master hieradata] cat /etc/puppetlabs/puppet/puppet.conf
[main]
certname = master.puppetlabs.vm
dns_alt_names = master.puppetlabs.vm,puppet
vardir = /var/opt/lib/pe-puppet
logdir = /var/log/pe-puppet
rundir = /var/run/pe-puppet
modulepath = /etc/puppetlabs/puppet/environments/$environment/modules:/opt/puppet/share/puppet/modules
server = master.puppetlabs.vm
user  = pe-puppet
group = pe-puppet
archive_files = true
archive_file_server = master.puppetlabs.vm
# cut [master] &amp; [agent] sections, $modulepath above is the important config key here.
</code></pre>

<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>

<pre><code class="bash">[root@master puppet] cat hiera.yaml
---
:backends:
  - yaml
:hierarchy:
  - "%{clientcert}"
  - "%{environment}"
  - global
:yaml:
  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'
</code></pre>

<h4>/etc/puppetlabs/puppet/Puppetfile</h4>

<pre><code class="bash">[root@master puppet]# cat Puppetfile
# mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;
forge "http://forge.puppetlabs.com"

# Modules from the Puppet Forge
mod "puppetlabs/stdlib"
mod "puppetlabs/apache", "0.11.0"
mod "puppetlabs/pe_gem"
mod "puppetlabs/mysql"
mod "puppetlabs/firewall"
mod "puppetlabs/vcsrepo"
mod "puppetlabs/git"
mod "puppetlabs/inifile"
mod "zack/r10k"
mod "gentoo/portage"
mod "thias/vsftpd"


# Modules from Github using various references
mod "wordpress",
  :git =&gt; "git://github.com/hunner/puppet-wordpress.git",
  :ref =&gt; '0.4.0'
</code></pre>

<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>

<h4>Our topic branches:</h4>

<pre><code class="bash">[root@master puppet] git branch
  development
* production
  staging
</code></pre>

<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</code></pre>

<h4>and for each of these files we have the same K,V:</h4>

<pre><code class="bash">[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
</code></pre>

<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>

<pre><code class="bash">[root@master puppet] git checkout development
Switched to branch 'development'
root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
</code></pre>

<p>Sync everything up with r10k so we can test:</p>

<pre><code class="bash">[root@master puppet] r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment master
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment development
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments
</code></pre>

<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>

<pre><code class="bash">[root@master puppet] git checkout production
Already on 'production'

[root@master puppet] puppet apply -e "notice(hiera(message))"
Notice: Scope(Class[main]): master.puppetlabs.vm is running in environment production
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.06 seconds
Notice: Finished catalog run in 0.24 seconds
[root@master puppet]
</code></pre>

<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn -  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
  development
* production
  staging
[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "I'm hard coding this value: environment production, master.puppetlabs.vm.yaml"
</code></pre>

<p>Now push your new data for production branch up to gitlab</p>

<pre><code>[root@master puppet]# git add hieradata/
[root@master puppet]# git commit -m "hieradata hard coded"
[production 3a58e49] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
 [root@master puppet]# git push
 Counting objects: 7, done.
 Delta compression using up to 4 threads.
 Compressing objects: 100% (4/4), done.
 Writing objects: 100% (4/4), 399 bytes, done.
 Total 4 (delta 2), reused 0 (delta 0)
 To git@10.10.100.111:user/control_repo.git
    1b240c6..3a58e49  production -&gt; production
</code></pre>

<p>and sync r10k</p>

<pre><code>[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitting other output ...
</code></pre>

<p>and test for the correct hard coded K,V</p>

<pre><code>[root@master puppet]# puppet apply -e "notice(hiera(message))"
Notice: Scope(Class[main]): I'm hard coding this value: environment production, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.05 seconds
Notice: Finished catalog run in 0.26 seconds
</code></pre>

<p>YAY!</p>

<h4>And again on the development branch</h4>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
* development
  production
  staging
[root@master puppet] cat hieradata/master.puppetlabs.vm.yaml
---
message: "I'm hard coding this value: environment development, master.puppetlabs.vm.yaml"
</code></pre>

<p>Push our new hieradata for <code>development</code> to gitlab:</p>

<pre><code class="bash">[root@master puppet] git add hieradata/
[root@master puppet] git commit -m "hieradata hard coded"
[development 2873db5] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
[root@master puppet] git push
Counting objects: 7, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 398 bytes, done.
Total 4 (delta 2), reused 0 (delta 0)
To git@10.10.100.111:user/control_repo.git
   08e249b..2873db5  development -&gt; development
</code></pre>

<p>andthen sync with r10k</p>

<pre><code>[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitted the other output...
</code></pre>

<p>and test with the <code>--environment development</code> switch</p>

<pre><code>[root@master puppet]# puppet apply -e "notice(hiera(message))" --environment development
Notice: Scope(Class[main]): I'm hard coding this value: environment development, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment development in 0.05 seconds
Notice: Finished catalog run in 0.25 seconds
</code></pre>

<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>

  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-16T12:34:33-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:34 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/16/r10k-control-repos.markdown/">R10k: Control Repos</a></h2>
  
  <p>
    <p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<h2>What is a control repo?</h2>

<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>

<h3>What does it contain?</h3>

<pre><code>hieradata/
Puppetfile
</code></pre>

<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis - it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>

<h2>How does it work?</h2>

<p>The control repo is placed in a monolithic git repository.</p>

<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>

<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>

<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>

<p>Populate your Puppetfile with what ever crap you need.</p>

<p>In <code>$confdir</code>:</p>

<pre><code class="bash">git init
git remote add origin git@whatever.com:your_name/control_repo.git
git branch -m master production
git add Puppetfile
git add hiera.yaml # r10k really doesn't need this but we'll add it anyways. 
git add hieradata/
git push -u origin production:production # or whatever branch, maybe production?
</code></pre>

<h3>Configure hiera.yaml for dynamic environments</h3>

<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used - therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>

<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>

<pre><code class="yaml">---
:backends:
  - yaml
:hierarchy:
  - "%{clientcert}"
  - "%{environment}"
  - global

:yaml:
  :datadir: '/etc/puppetlabs/puppet/environments/%{::environment}/hieradata'
</code></pre>

<h3>Branching your Puppetfile</h3>

<p>For example, assuming you already have a master or production branch:</p>

<pre><code class="bash">vi Puppetfile
</code></pre>

<p>&hellip;add some git modules etc&hellip;</p>

<pre><code class="bash">git checkout -b development
git push origin development:development
git commit -am Puppetfile
r10k deploy environment -pv
</code></pre>

<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>

<h3>Branching your hiera data</h3>

<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>

<pre><code class="bash">cd $confdir/hieradata
</code></pre>

<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>


<pre><code class="bash">git branch # check your branch, make sure it's still development
git commit -am hieradata
git push 
r10k deploy environment -pv
</code></pre>

<p>Check <code>$confdir/environments/development/hieradata</code></p>

<h2>Testing</h2>

<h3>Configuration files for r10k, hiera, puppet:</h3>

<h4>/etc/r10k.yaml</h4>

<pre><code class="bash">root@master hieradata]# cat /etc/r10k.yaml
:cachedir: /var/cache/r10k
:sources:
  puppet:
    remote: "git@10.10.100.111:user/control_repo.git"
    basedir: /etc/puppetlabs/puppet/environments
    prefix: false
:purgedirs:
  - ""
</code></pre>

<h4>/etc/puppetlabs/puppet/puppet.conf</h4>

<pre><code class="bash">[root@master hieradata] cat /etc/puppetlabs/puppet/puppet.conf
[main]
certname = master.puppetlabs.vm
dns_alt_names = master.puppetlabs.vm,puppet
vardir = /var/opt/lib/pe-puppet
logdir = /var/log/pe-puppet
rundir = /var/run/pe-puppet
modulepath = /etc/puppetlabs/puppet/environments/$environment/modules:/opt/puppet/share/puppet/modules
server = master.puppetlabs.vm
user  = pe-puppet
group = pe-puppet
archive_files = true
archive_file_server = master.puppetlabs.vm
# cut [master] &amp; [agent] sections, $modulepath above is the important config key here.
</code></pre>

<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>

<pre><code class="bash">[root@master puppet] cat hiera.yaml
---
:backends:
  - yaml
:hierarchy:
  - "%{clientcert}"
  - "%{environment}"
  - global
:yaml:
  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'
</code></pre>

<h4>/etc/puppetlabs/puppet/Puppetfile</h4>

<pre><code class="bash">[root@master puppet]# cat Puppetfile
# mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;
forge "http://forge.puppetlabs.com"

# Modules from the Puppet Forge
mod "puppetlabs/stdlib"
mod "puppetlabs/apache", "0.11.0"
mod "puppetlabs/pe_gem"
mod "puppetlabs/mysql"
mod "puppetlabs/firewall"
mod "puppetlabs/vcsrepo"
mod "puppetlabs/git"
mod "puppetlabs/inifile"
mod "zack/r10k"
mod "gentoo/portage"
mod "thias/vsftpd"


# Modules from Github using various references
mod "wordpress",
  :git =&gt; "git://github.com/hunner/puppet-wordpress.git",
  :ref =&gt; '0.4.0'
</code></pre>

<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>

<h4>Our topic branches:</h4>

<pre><code class="bash">[root@master puppet] git branch
  development
* production
  staging
</code></pre>

<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</code></pre>

<h4>and for each of these files we have the same K,V:</h4>

<pre><code class="bash">[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
</code></pre>

<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>

<pre><code class="bash">[root@master puppet] git checkout development
Switched to branch 'development'
root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "%{fqdn} is running in environment %{environment}"
</code></pre>

<p>Sync everything up with r10k so we can test:</p>

<pre><code class="bash">[root@master puppet] r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment master
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment development
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments
</code></pre>

<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>

<pre><code class="bash">[root@master puppet] git checkout production
Already on 'production'

[root@master puppet] puppet apply -e "notice(hiera(message))"
Notice: Scope(Class[main]): master.puppetlabs.vm is running in environment production
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.06 seconds
Notice: Finished catalog run in 0.24 seconds
[root@master puppet]
</code></pre>

<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn -  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
  development
* production
  staging
[root@master hieradata] cat master.puppetlabs.vm.yaml
---
message: "I'm hard coding this value: environment production, master.puppetlabs.vm.yaml"
</code></pre>

<p>Now push your new data for production branch up to gitlab</p>

<pre><code>[root@master puppet]# git add hieradata/
[root@master puppet]# git commit -m "hieradata hard coded"
[production 3a58e49] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
 [root@master puppet]# git push
 Counting objects: 7, done.
 Delta compression using up to 4 threads.
 Compressing objects: 100% (4/4), done.
 Writing objects: 100% (4/4), 399 bytes, done.
 Total 4 (delta 2), reused 0 (delta 0)
 To git@10.10.100.111:user/control_repo.git
    1b240c6..3a58e49  production -&gt; production
</code></pre>

<p>and sync r10k</p>

<pre><code>[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitting other output ...
</code></pre>

<p>and test for the correct hard coded K,V</p>

<pre><code>[root@master puppet]# puppet apply -e "notice(hiera(message))"
Notice: Scope(Class[main]): I'm hard coding this value: environment production, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.05 seconds
Notice: Finished catalog run in 0.26 seconds
</code></pre>

<p>YAY!</p>

<h4>And again on the development branch</h4>

<pre><code class="bash">[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
* development
  production
  staging
[root@master puppet] cat hieradata/master.puppetlabs.vm.yaml
---
message: "I'm hard coding this value: environment development, master.puppetlabs.vm.yaml"
</code></pre>

<p>Push our new hieradata for <code>development</code> to gitlab:</p>

<pre><code class="bash">[root@master puppet] git add hieradata/
[root@master puppet] git commit -m "hieradata hard coded"
[development 2873db5] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
[root@master puppet] git push
Counting objects: 7, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 398 bytes, done.
Total 4 (delta 2), reused 0 (delta 0)
To git@10.10.100.111:user/control_repo.git
   08e249b..2873db5  development -&gt; development
</code></pre>

<p>andthen sync with r10k</p>

<pre><code>[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitted the other output...
</code></pre>

<p>and test with the <code>--environment development</code> switch</p>

<pre><code>[root@master puppet]# puppet apply -e "notice(hiera(message))" --environment development
Notice: Scope(Class[main]): I'm hard coding this value: environment development, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment development in 0.05 seconds
Notice: Finished catalog run in 0.25 seconds
</code></pre>

<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>

  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-16T12:34:33-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:34 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/16/r10k-control-repos/">R10k: Control Repos</a></h2>
  
  <p>
    <p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>




<h2>What is a control repo?</h2>




<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>




<h3>What does it contain?</h3>




<pre><code>hieradata/
Puppetfile
</code></pre>




<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis - it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>




<h2>How does it work?</h2>




<p>The control repo is placed in a monolithic git repository.</p>




<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>




<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>




<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>




<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>




<p>Populate your Puppetfile with what ever crap you need.</p>




<p>In <code>$confdir</code>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git init
</span><span class='line'>git remote add origin git@whatever.com:your_name/control_repo.git
</span><span class='line'>git branch -m master production
</span><span class='line'>git add Puppetfile
</span><span class='line'>git add hiera.yaml <span class="c"># r10k really doesn&#39;t need this but we&#39;ll add it anyways. </span>
</span><span class='line'>git add hieradata/
</span><span class='line'>git push -u origin production:production <span class="c"># or whatever branch, maybe production?</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Configure hiera.yaml for dynamic environments</h3>




<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used - therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>




<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{environment}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">global</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">:yaml</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="s">&#39;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Branching your Puppetfile</h3>




<p>For example, assuming you already have a master or production branch:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi Puppetfile
</span></code></pre></td></tr></table></div></figure>




<p>&hellip;add some git modules etc&hellip;</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git checkout -b development
</span><span class='line'>git push origin development:development
</span><span class='line'>git commit -am Puppetfile
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>




<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>




<h3>Branching your hiera data</h3>




<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/hieradata
</span></code></pre></td></tr></table></div></figure>




<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git branch <span class="c"># check your branch, make sure it&#39;s still development</span>
</span><span class='line'>git commit -am hieradata
</span><span class='line'>git push
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>




<p>Check <code>$confdir/environments/development/hieradata</code></p>




<h2>Testing</h2>




<h3>Configuration files for r10k, hiera, puppet:</h3>




<h4>/etc/r10k.yaml</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@master hieradata<span class="o">]</span><span class="c"># cat /etc/r10k.yaml</span>
</span><span class='line'>:cachedir: /var/cache/r10k
</span><span class='line'>:sources:
</span><span class='line'>  puppet:
</span><span class='line'>    remote: <span class="s2">&quot;git@10.10.100.111:user/control_repo.git&quot;</span>
</span><span class='line'>    basedir: /etc/puppetlabs/puppet/environments
</span><span class='line'>    prefix: <span class="nb">false</span>
</span><span class='line'>:purgedirs:
</span><span class='line'>  - <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<h4>/etc/puppetlabs/puppet/puppet.conf</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat /etc/puppetlabs/puppet/puppet.conf
</span><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">certname</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">dns_alt_names</span> <span class="o">=</span> master.puppetlabs.vm,puppet
</span><span class='line'><span class="nv">vardir</span> <span class="o">=</span> /var/opt/lib/pe-puppet
</span><span class='line'><span class="nv">logdir</span> <span class="o">=</span> /var/log/pe-puppet
</span><span class='line'><span class="nv">rundir</span> <span class="o">=</span> /var/run/pe-puppet
</span><span class='line'><span class="nv">modulepath</span> <span class="o">=</span> /etc/puppetlabs/puppet/environments/<span class="nv">$environment</span>/modules:/opt/puppet/share/puppet/modules
</span><span class='line'><span class="nv">server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">user</span>  <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">group</span> <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">archive_files</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">archive_file_server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="c"># cut [master] &amp; [agent] sections, $modulepath above is the important config key here.</span>
</span></code></pre></td></tr></table></div></figure>




<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hiera.yaml
</span><span class='line'>---
</span><span class='line'>:backends:
</span><span class='line'>  - yaml
</span><span class='line'>:hierarchy:
</span><span class='line'>  - <span class="s2">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  - <span class="s2">&quot;%{environment}&quot;</span>
</span><span class='line'>  - global
</span><span class='line'>:yaml:
</span><span class='line'>  :datadir: <span class="s1">&#39;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<h4>/etc/puppetlabs/puppet/Puppetfile</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># cat Puppetfile</span>
</span><span class='line'><span class="c"># mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;</span>
</span><span class='line'>forge <span class="s2">&quot;http://forge.puppetlabs.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from the Puppet Forge</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/stdlib&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/apache&quot;</span>, <span class="s2">&quot;0.11.0&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/pe_gem&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/mysql&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/firewall&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/vcsrepo&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/git&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/inifile&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;zack/r10k&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;gentoo/portage&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;thias/vsftpd&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from Github using various references</span>
</span><span class='line'>mod <span class="s2">&quot;wordpress&quot;</span>,
</span><span class='line'>  :git <span class="o">=</span>&gt; <span class="s2">&quot;git://github.com/hunner/puppet-wordpress.git&quot;</span>,
</span><span class='line'>  :ref <span class="o">=</span>&gt; <span class="s1">&#39;0.4.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>




<h4>Our topic branches:</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span></code></pre></td></tr></table></div></figure>




<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span></code></pre></td></tr></table></div></figure>




<h4>and for each of these files we have the same K,V:</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout development
</span><span class='line'>Switched to branch <span class="s1">&#39;development&#39;</span>
</span><span class='line'>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Sync everything up with r10k so we can test:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> r10k deploy environment -pv
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment master
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment development
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::PurgeEnvironments - INFO<span class="o">]</span> Purging stale environments from /etc/puppetlabs/puppet/environments
</span></code></pre></td></tr></table></div></figure>




<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout production
</span><span class='line'>Already on <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> puppet apply -e <span class="s2">&quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: master.puppetlabs.vm is running in environment production
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.06 seconds
</span><span class='line'>Notice: Finished catalog run in 0.24 seconds
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn -  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment production, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now push your new data for production branch up to gitlab</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git add hieradata/</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git commit -m &quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>production 3a58e49<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> <span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git push</span>
</span><span class='line'> Counting objects: 7, <span class="k">done</span>.
</span><span class='line'> Delta compression using up to 4 threads.
</span><span class='line'> Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'> Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 399 bytes, <span class="k">done</span>.
</span><span class='line'> Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'> To git@10.10.100.111:user/control_repo.git
</span><span class='line'>    1b240c6..3a58e49  production -&gt; production
</span></code></pre></td></tr></table></div></figure>




<p>and sync r10k</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitting other output ...</span>
</span></code></pre></td></tr></table></div></figure>




<p>and test for the correct hard coded K,V</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment production, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.26 seconds
</span></code></pre></td></tr></table></div></figure>




<p>YAY!</p>




<h4>And again on the development branch</h4>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>* development
</span><span class='line'>  production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hieradata/master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment development, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Push our new hieradata for <code>development</code> to gitlab:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git add hieradata/
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git commit -m <span class="s2">&quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>development 2873db5<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git push
</span><span class='line'>Counting objects: 7, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 398 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@10.10.100.111:user/control_repo.git
</span><span class='line'>   08e249b..2873db5  development -&gt; development
</span></code></pre></td></tr></table></div></figure>




<p>andthen sync with r10k</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitted the other output...</span>
</span></code></pre></td></tr></table></div></figure>




<p>and test with the <code>--environment development</code> switch</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot; --environment development</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment development, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment development in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.25 seconds
</span></code></pre></td></tr></table></div></figure>




<p>`</p>




<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-16T12:34:33-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:34 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/15/hiera-and-r10k/">Why I Don&#8217;t Place a hiera.yaml in My CR</a></h2>
  
  <p>
    <p>Here&rsquo;s a really good reason. First off, unless your hiera.yaml is super complicated, then it probably doesn&rsquo;t need to be in version control. However, for a lot of deployments you need it in VC, but not in your control repo (i.e., the one that r10k will access for Puppetfile, hieradata and build our corrosponding enviros for on your master).</p>




<p>No, place that hiera.yaml in it&rsquo;s own VC repo.</p>




<p>I had a control repo with:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Puppetfile
</span><span class='line'>hieradata/
</span><span class='line'>hiera.yaml</span></code></pre></td></tr></table></div></figure>




<p>and I kept running in to this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# puppet apply -e "notice(hiera(message))"
</span><span class='line'>Error: Could not find data item message in any Hiera data file and no default supplied at line 1 on node master.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>




<p>This was a very simple test to see if my <code>production</code> environment was grabbing the correct data via a message K,V in <code>$confdir/environments/production/hieradata/master.puppetlabs.vm.yaml</code> .</p>




<p>Check out the &ndash;debug</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Debug: hiera(): Hiera YAML backend starting
</span><span class='line'>Debug: hiera(): Looking up message in YAML backend
</span><span class='line'>Debug: hiera(): Looking for data source master.puppetlabs.vm
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/master.puppetlabs.vm.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source production
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/production.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source global
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/global.yaml, skipping</span></code></pre></td></tr></table></div></figure>




<p>So I copied the <code>datafile</code> path and redirected it to a diff along with a &#8220;`$(pwd) while in the /etc/puppetlabs/puppet/environments/production/hieradata directory:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# diff &lt;(echo "/etc/puppetlabs/puppet/environmets/production/hieradata/") &lt;(echo "$(pwd)")
</span><span class='line'>1c1
</span><span class='line'>&lt; /etc/puppetlabs/puppet/environmets/production/hieradata/
</span><span class='line'>---
</span><span class='line'>&gt; /etc/puppetlabs/puppet/environments/production/hieradata</span></code></pre></td></tr></table></div></figure>




<p>So the <code>$datadir</code> path in hiera.yaml</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master puppet]# cat hiera.yaml | grep datadir
</span><span class='line'>  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'</span></code></pre></td></tr></table></div></figure>




<p>is indeed missing that f-ing &lsquo;n&rsquo;. Why? Because this was the second time this happened to me today.</p>




<p>Really? The second time? Really. The second fucking time.</p>




<p>I previously committed hiera.yaml along with hieradata/ and my Puppetfile to branch production. I tested it and came across this problem. Did the same test to figure out the correct path and updated hiera.yaml.</p>




<p>However, hiera.yaml was also in my development and staging branches. I didn&rsquo;t update those. So here I was again doing tests on development data for Puppet and <strong>boom</strong> my shit&rsquo;s broken again.</p>




<p>Since hiera.yaml is only used singularly on a puppet run, i.e., it&rsquo;s not consulted on a per environment basis, you only need one copy of it, and that&rsquo;s the one in your puppet $confdir. Having it scattered to the winds with r10k in the control repo does not give you any extra functionality (yet, someday we might make it enviro aware, but currently is not the case).</p>




<p>So if you&rsquo;re going to run your hiera.yaml into a VCS then do it in it&rsquo;s own monolithic repo. You can symlink it into the $confdir for Puppet.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-15T16:12:36-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:12 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/05/04/continous-integration-hooks-with-r10k-and-puppet/">Continous Integration Hooks With R10k &amp; Puppet</a></h2>
  
  <p>
    <p>A week ago I was modifiying a webhook to run r10k on push to a git repository. The goal here was to sync up r10k everytime a push was made to the repo. However, in doing so I found that the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb">current</a> hook didn&rsquo;t take advantage of deploying a specific puppet environmnet, and instead runs a full r10k sync across all topic branchs and thus all puppet environments.</p>




<p>I figured the first place to start was modifying the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb#L35">&lsquo;post&rsquo;</a> method:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1">#protected!</span>
</span><span class='line'>      <span class="n">deploy</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p> to parse the json sent by git (in this case I was integrating with gitlab) for the <a href="http://demo.gitlab.com/help/web_hooks">ref branch</a>. So the &lsquo;post&rsquo; hook now looks like <a href="https://github.com/malnick/r10k/blob/master/templates/usr/local/bin/webhook.erb#L52">this</a>:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#protected!</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">rewind</span>  <span class="c1"># in case someone already read it</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>    <span class="n">branch</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;ref&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="s2">&quot;ref branch: </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="c1">#deploy(refs)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>So the #branch effectively is our puppet environment that we want to pass to the r10k mcollective agent so we can deploy a specific puppet enviro and not sync across all topic branches/enviros. This will make it lightweight.</p>




<p>However, I ran into a blocker in the mcollective r10k agent itself. I want to pass this argument to it so I can sync all r10k nodes at once from this hook based on the ref branch the current r10k <a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">agent</a> does not accept any arugments and only syncs across all topic branches using the &lsquo;syncronize&rsquo; method.</p>




<p>In order to pass this ref branch in and leverage &lsquo;r10k deploy environmnet #{topic_branch}&rsquo; as I&rsquo;m attempting here the agent will need to be modified to parse the argument.</p>




<p><a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">Zach&rsquo;s current r10k agent</a> is pretty good, so we&rsquo;ll stick to modifying that (at this point I handed over the agent writing to a colleague Andrew Brader since I was sent to a training site and he had a week/time to modifying the mco agent):</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">git</span>  <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">action</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">git</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;push&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;push&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;pull&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;pull&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;status&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="n">path</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;cache&#39;</span><span class="p">,</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="s1">&#39;synchronize&#39;</span><span class="p">,</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;cache&#39;</span>       <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;cache&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;synchronize&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;synchronize&#39;</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sync&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;environment&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;module&#39;</span>      <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;module&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>In order to parse the topic branch from the hook we need to add a method, which Andrew did <a href="https://github.com/abrader/r10k/blob/master/files/agent/r10k.rb#L59">here</a>:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>      <span class="k">def</span> <span class="nf">deploy_only_cmd</span><span class="p">(</span><span class="n">r10k_env</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">r10k_env</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">deploy_only_cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Testing the new hook &amp; agent</h3>




<p>&hellip; to be updated shortly&hellip;</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-05-04T07:47:05-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:47 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/04/19/puppet-types-understanding-parameters-and-properties/">Puppet Types: Understanding Parameters and Properties</a></h2>
  
  <p>
    <p>When starting out with Types and Providers for Puppet it&rsquo;s common to misunderstand when something is a <em>Parameter</em> and when something is a <em>Property</em>.</p>




<h3><strong>Properties</strong></h3>




<p>Properties are anything that will <strong>modify</strong> a resource. In other words, attributes of a type that will change how that resource type exists on your system. A property is a charactaristic of a resource. A property does not change what a resource is, which is where the confusion usually begins.</p>




<p>For example, let&rsquo;s take the file resource (anyone who has had the opportunity of taking Extending Puppet for Developers might find this redundant).</p>




<pre><code>file {'/tmp/test':
    ensure   =&gt; file,
    path     =&gt; '/tmp/test', # $namevar
    owner    =&gt; 'root',
    group    =&gt; 'root',
    checksum =&gt; 'md5',
    content  =&gt; 'foo',
    }
</code></pre>




<p>Any ideas which attributes are parameters and which are properties? Let&rsquo;s start with</p>




<pre><code>ensure =&gt; file,
</code></pre>




<p>The &lsquo;ensure&rsquo; attribute is actually created by the &lsquo;ensurable&rsquo; method from the Puppet::Type class. Any attribute calling &lsquo;ensurable&rsquo; gets the default &lsquo;present&#8217;and &#8216;absent&rsquo; values telling the type to call from the provider &lsquo;exists?()&rsquo; then based on output from &lsquo;exists?&rsquo; evaluates &lsquo;creates()&rsquo; or &lsquo;destroy()&rsquo;.</p>




<p>Ensure modifies the resource, but does not change the definition of what that resource is to the system, therefore ensure is a property.</p>




<p>Other properties of file are</p>




<pre><code>owner
group
content
</code></pre>




<p>Content? Yes, content. On a file system the content of the file does not define the file, the <em>$path</em> to the file is the definition of a file. Therefore content is just a charactaristic of that file, making that attribute a property as well.</p>




<h3><strong>Parameters</strong></h3>




<p>Parameters are used by Puppet to provision the resource onto the system. Parameters are resource attributes that can be retrieved and are used to create, or define the resource as it exists on the system.</p>




<pre><code>path =&gt; '/tmp/testing',
</code></pre>




<p>For example, the $namevar of the the file resource is the $path. That&rsquo;s because the $path of a file defines the resource on the system. You can query the path of a file, however if you change the path of a file you define an entierly new file. Therefore, $path is a parameter.</p>




<p>Another parameter of file would the checksum attribute. The checksum type is used when determining whether to replace a files contents. If your md5 checksum does not match the md5 checksum of the file on the system your file will be created; if it does match your file will not be updated if it exists; if it doesn&rsquo;t exist if will be provisioned. Checksum defines what the file should look like on the system; it&rsquo;s used by Puppet to provision the file but not stored as part of the file resource.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-04-19T08:30:28-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:30 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/03/20/brief-intro-to-puppetizing-stig-compliance/">Brief Intro to Puppetizing STIG Compliance</a></h2>
  
  <p>
    <p>STIG is a methodology for the implementation of security compliance across heterogeneous operating systems. Every OS has a specific STIG. The STIG for a given OS is maintained and distributed by the Defense Information Systems Agency (DISA). Current STIGs can be found on the <a href="http://iase.disa.mil/stigs/">DISA website</a>.</p>




<p>Puppet is an excellent tool for bringing machines into STIG compliance. At my previous job I was in <a href="https://github.com/malnick/do_debian_stig/blob/master/do_debian_stig.sh">shell script hell</a> until we spun up a POS master and started writing a STIG module that worked across all OS&rsquo;s we supported (14 linux distros, 30 territorial sys admins, ~250 nodes).</p>




<p>In doing a STIG module for puppet its best to just work from Cat 1 down. 1 &amp; 2 offenses are pretty big, 3 &amp; 4 are usually minor security patches and can be overlooked if youre time crunched. Staying on top of the false positives and keeping your module up to date with actual security implementation is the biggest hurdle.</p>




<p>This document is a general guideline from my experience in implementing STIG compliance measures.</p>




<h3>Basic STIG Process</h3>




<ol>
<li><p>Go to the DISA site and download the STIG for the appropriate OS</p></li>
<li><p>Do some sort of benchmark scan on a base OS:</p>

<ul>
<li>I used retina (which is awful) scans that were preloaded with the appropriate <a href="http://www.public.navy.mil/spawar/Atlantic/ProductsServices/Pages/SCAP.aspx">Security Content Automation Protocol (SCAP)</a> documents (.xml files, see below).</li>
<li> You can also get SCAP benchmarks on the DISA site for the appropriate OS listed with the STIG benchmarks (see below on SCAP)</li>
</ul>
</li>
<li><p>Take retina report with categorized vulnerabilities and start writing puppet modules - oh wait, just kidding! first youll need to:</p>

<ol type="a">
<li> Check for false positives - in most cases the OS provider is way ahead of the game, and simply running apt-get update or yum update will take care of 80% of the vulnerabilities on the box. STIG guidelines are notoriously behind the OS and will have LOTS of false positives. Most of your time will be spent accounting for what is actually a vulnerability and what is actually already patched by the OS provider.</li>
</ol>
</li>
<li><p>What vulnerabilities are left after cross correlating with security patches are what you have to develop specified puppet classes for, this is actually the easy part.</p></li>
</ol>




<p>A really good resource for this is the <a href="https://fedorahosted.org/aqueduct/wiki/RhelStigProcess">Aqueduct Project</a> at Fedora. Theyre really good about staying on top of the recent STIG process and also maintaining a set puppet module for STIGing RHEL boxes (or at least they used to, not sure what their status is now. A recent look shows they&rsquo;re only on RHEL 5 so&hellip;).</p>




<h3>SCAP</h3>




<p>The Security <a href="http://scap.nist.gov">Content Automation Protocol (SCAP)</a> is a protocol developed by the NSA puppet branch of government known as NIST for implementing IT security measures. Some parts of the protocol can be useful in scanning tools such as retina since the XML format for the vulnerability index are standardized.</p>




<p>For example, when you are on the DISA site looking at the current STIG for a specific OS there will be a download button for &lsquo;SCAP Benchmarks&rsquo;. This is a .zip of several .xml&rsquo;s that contain:</p>




<p><a href="http://scap.nist.gov/specifications/cpe/">Common Platform Enumeration (CPE)</a> files for describing and identifying classes of applications, operating systems, and hardware devices present among an enterprise&rsquo;s computing assets.</p>




<p><a href="http://oval.mitre.org">Open Vulnerability and Assessment Language (OVAL)</a> for assessing and reporting upon the rachine state.</p>




<p><a href="http://scap.nist.gov/specifications/xccdf/index.html">Extensible Configuration Checklist Description Format (XCCDF)</a> which is a structured collection of security configuration rules for some set of target systems.</p>




<p>&hellip; and maybe some other random ones as well.</p>




<p>This is a document in motion so I&rsquo;ll be adding more here, feel free to add as you find information as well.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-03-20T10:01:05-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:01 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/03/20/rspec-testing-puppet-enterprise-modules/">How to Install Rspec-Puppet on Puppet Enterprise</a></h2>
  
  <p>
    <p>If you&rsquo;re getting into rspec testing for your manifests you might already know this:  Puppet Enterprise has it&rsquo;s own gem environment. This is a quick post on how to install rspec-puppet to your PE gem environment.</p>




<p>If you&rsquo;re new to rspec-puppet check out <a href="www.rspec-puppet.com">this great site</a> for a brief on installing (except if you&rsquo;re on PE, then follow the install below). rspec-puppet.com also has a great tutorial to get your up and running.</p>




<h3>Installing rspec-puppet on Puppet Enterprise</h3>




<p>If you&rsquo;ve already installed rspec-puppet via system gem you will get this error on rspec-puppet-init:</p>




<pre><code>[root@master users]# rspec-puppet-init 
/usr/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:31:in `gem_original_require': no such file to load -- puppet (LoadError)
</code></pre>




<p>If you&rsquo;ve already installed rspec-puppet vis system gem:</p>




<pre><code>$ /usr/bin/gem uninstall rspec-puppet
</code></pre>




<p>Once system rspec-puppet is removed:</p>




<pre><code>$ /opt/puppet/bin/gem install rspec-puppet
</code></pre>




<p>Then to init a new puppet rspec enviro in your $moduledir:</p>




<pre><code>$ /opt/puppet/bin/rspec-puppet-init
</code></pre>




<p>This should build:</p>




<pre><code>+ spec/
+ spec/classes/
+ spec/defines/
+ spec/functions/
+ spec/hosts/
+ spec/fixtures/
+ spec/fixtures/manifests/
+ spec/fixtures/modules/
+ spec/fixtures/modules/users/
+ spec/fixtures/manifests/site.pp
+ spec/fixtures/modules/users/manifests
+ spec/fixtures/modules/users/lib
+ spec/spec_helper.rb
+ Rakefile
</code></pre>




<h3>Installing PE-Specific Gems using PE-Gem Provider</h3>




<p><a href="https://github.com/puppetlabs/puppetlabs-pe_gem">puppetlabs/pe_gem</a> has the provider for pe_gem so you can simply:</p>




<pre><code>package { 'json':
    ensure   =&gt; present,
    provider =&gt; pe_gem,
    }
</code></pre>




<p>That&rsquo;s it!</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-03-20T09:42:50-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:42 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/03/17/tls-slash-ssl-dh-cipher-padding-bug-in-activemq/">TLS/SSL DH Cipher Padding Bug in ActiveMQ</a></h2>
  
  <p>
    <h3>Update</h3>




<p>As of March 18 it appears that Oracle has implemented a fix in their release of <a href="http://www.oracle.com/technetwork/java/javase/8train-relnotes-latest-2153846.html">JDK and Java Standard Edition version 8</a> and it&rsquo;s assocaited <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/security/enhancements-8.html">security extensions</a>:</p>




<p>&ldquo;Support stronger ephemeral DH keys in the SunJSSE provider: Make ephemeral DH key match the length of the certificate key during SSL/TLS handshaking in the SunJSSE provider. A new system property, jdk.tls.ephemeralDHKeySize, is defined to customize the ephemeral DH key sizes. The minimum acceptable DH key size is 1024 bits, except for exportable cipher suites or legacy mode (jdk.tls.ephemeralDHKeySize=legacy). See Customizing Size of Ephemeral DH Keys and RFE 6956398.&rdquo;</p>




<hr />




<p>In helping a client with an ActiveMQ issue in Puppet Enterprise I recently stumbled across this line in their wrapper log:</p>




<pre><code>INFO | jvm 1 | 2014/02/26 12:47:20 | WARN | Transport Connection to: tcp://ip.removed:49867 failed: javax.net.ssl.SSLHandshake
Exception: Invalid Padding length: 239
</code></pre>




<p>The client thought this may have been exacberating a JVM memory problem, however I found it actually is a not related but in and of itself it&rsquo;s own  bug in the Java Security Extensions for Diffe-Helman cipher implementation over SSL.</p>




<p>We have seen similar issues in JDK 1.7x security extensions in other Java-powered backends for Puppet Enterprise such as <a href="http://projects.puppetlabs.com/issues/19884">PuppetDB</a>. It has also been documented on the <a href="https://issues.apache.org/jira/browse/APLO-287">Apache ActiveMQ ticket board</a> and the <a href="https://community.oracle.com/message/11001587">Oracle community</a> board.</p>




<p>The issue is dependant on:</p>




<pre><code>* OpenJDK Runtime Environment (PE Java 1.7.0.19) 
* Linux OS's (so far my testing is on CentOS 6x) 
* TLS_DHE_RSA_WITH_AES_128_CBC_SHA Cipher
* openssl-1.0.0-27.el6_4.2.x86_64
</code></pre>




<p>To sum up the problem, every few hundred messages that are encrypted over SSL or TLS using DH ciphers the client gets a handshake exception. The exception is caused by a faulty SSL packet.</p>




<h3>Oracle&rsquo;s Solution</h3>




<p><a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8013059">A ticket was submitted</a> to Java bugs and was set &ldquo;resolved&rdquo; on 2013-10-25. However, and this is a big however, their resolution is, &ldquo;In order to have reliable TLS handshakes, Diffie Hellman key exchanges must be disabled.&rdquo;</p>




<p>I personally don&rsquo;t like this resolution since DH keys are sometimes neccessary, and in terms of security is superior to standard RSA ciphers. DH ciphers provide perfect forward secrecy. That means even if the private key is compromised you can not decrypt past data. Ciper suites which use DHE-RSA-AES128-SHA all implement the slower, more secure ephemeral DH crypto - it&rsquo;s ephemeral since new random numbers that generate the key are used each time. This is also why it&rsquo;s slower. However, it&rsquo;s also harder to run a selected clear text attack on EDH since the private key is used for only authentication and use an independant method to agree on a shared secret - standard RSA ciphers employ the private key for both auth and encryption for better performance in exchange for not providing perfect forward secrecy.</p>




<p>You may now chime in with your own conspiracy theories as to why Oracle would settle for solving this cyrpto issue by simply using a less secure cipher - does the NSA not want Java applications, which function as the backbone to a great deal of web traffic, encrypting data with perfect forward secrecy?</p>




<h3>Workaround in AMQ</h3>




<p>Since there is no good way to get around this problem in JDK 1.7x security extensions you have two choices:</p>




<pre><code>1. Live with the error in approx. 5% of the SSL traffic
2. Run SSL with a non-DH or DHE cipher  
</code></pre>




<h4>Door #1</h4>




<p>Example, you&rsquo;ve got an AMQ broker administering messaging for 1000+ AMQ agents in a live management setup in Puppet Enterprise you&rsquo;ll see this error a lot, and it may (warning, assumption) degrade live management performance in such a large deployment.</p>




<p>If you can live with either seeing this error 5% of the time or you can live with the hit in performance sticking it out with DH can still work.</p>




<h4>Door #2</h4>




<p>You need the performance or are a stickler for perfect SSL key exchange.</p>




<p>A possible solution would be modifying the transportConnector in /etc/puppetlabs/activemq/activemq.xml:</p>




<pre><code>&lt;transportConnector name="openwire" uri="ssl://0.0.0.0:61616"/&gt;
&lt;!-- Puppet mcollective_enable_stomp_ssl=true
&lt;transportConnector name="stomp+ssl" uri="stomp+ssl://0.0.0.0:61613"/&gt;\
</code></pre>




<p>With the transport.enabledCipherSuites embedded:</p>




<pre><code>ssl://localhost:61616?transport.enabledCipherSuites=SSL_RSA_WITH_3DES_EDE_CBC_SHA
</code></pre>




<p>The SSL_RSA_WITH_3DES_EDE_CBC_SHA is non-DH cipher versus the  SSL_DH_anon_WITH_3DES_EDE_CBC_SHA which I think is what AMQ currently uses.</p>




<p>Note syntax:
    ssl://?socket.enabledCipherSuites=THE_CIPHER # for agents</p>




<p>and</p>




<pre><code>ssl://?transport.enabledCipherSuites=THE_CIPHER # for brokers 
</code></pre>




<p>More information about this can be found on the <a href="https://activemq.apache.org/ssl-transport-reference.html">AMQ reference page</a></p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-03-17T16:23:11-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:23 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/03/12/debugging-activemq-jvm-heap-memory-errors/">Debugging ActiveMQ JVM Heap Memory Errors</a></h2>
  
  <p>
    <h2>This just happened:</h2>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 1    | 2014/03/11 16:12:34 | Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-79" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-101" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-87" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-30" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-74" java.lang.OutOfMemoryError: unable to create new native thread</span></code></pre></td></tr></table></div></figure>




<p>Since this is on a production server you need to recreate it in a testing environment. Since I&rsquo;m partial to vagrant I stand up 4 agent nodes and a master via pe-build vagrant plugin. My Vagrantfile looks something like this:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-nocm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-fusion503-nocm.box&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span>       <span class="o">=</span> <span class="s1">&#39;3.1.0&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;4096&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 1</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 2</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent2</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.112&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent2.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 3</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent3</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.113&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent3.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 4</span>
</span><span class='line'>   <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent4</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;1024&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.114&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent4.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>This error occured on an ActiveMQ install that works as the message que for a 1000 node deployment of puppet agents. To get terminology straight here, we have puppet agents and AMQ agents running on these 1000 nodes. They&rsquo;re all qued from a singular AMQ broker.</p>




<p>My first impression was that this error may be caused by having 1000 agents pinging a single AMQ broker, which is limited to 800 via fds instances.</p>




<p>I check locally on my test master:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># pgrep -f pe-activemq</span>
</span><span class='line'>1271
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            1024                 4096                 files
</span></code></pre></td></tr></table></div></figure>




<p>My soft limit is 1024 open files, and after rando .jars and logs and stuff that really feels like more around 800. So this is on the money, as far as what the docs say for ActiveMQ servers per broker.</p>




<h3>How am I going to recreate what a 1000 node enviro looks like?</h3>




<p>I&rsquo;m limited to my laptop, 16GB of memory, and I&rsquo;m too lazy to stand up 1000 instances in AWS (and to poor). So an attempt has to be made to recreate this memory error on my 5 nodes running locally.</p>




<p>Given the above information, I start open a shell, and ssh into my master:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># echo -n &quot;Max open files=3:3&quot; &gt; /proc/1271/limits</span>
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            3                    3                    files
</span></code></pre></td></tr></table></div></figure>




<p>Why 3? Because:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># ls /proc/1271/fd | wc -l</span>
</span><span class='line'>6
</span></code></pre></td></tr></table></div></figure>




<p>So a quick &lsquo;service pe-activemq restart&rsquo; and bang&hellip;</p>




<p>Oh shit, new PID, new proc instance. Damnit. I have to figure out something else to fake the resource limits here.</p>




<p>Since ulimit commands are shell-bound I can ssh into the master from another shell and run:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># ulimit -n 10</span>
</span><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># service pe-activemq restart</span>
</span><span class='line'><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="ss">functions</span><span class="p">:</span> <span class="n">redirection</span> <span class="ss">error</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">duplicate</span> <span class="ss">fd</span><span class="p">:</span> <span class="no">Invalid</span> <span class="n">argument</span>
</span><span class='line'><span class="no">Stopping</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span><span class='line'><span class="no">Starting</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<p>The trick here is getting close enough to the lowest possible resource limits with out getting the</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>/bin/sh: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: Error 24</span></code></pre></td></tr></table></div></figure>




<p>error.</p>




<p>3 was actually too low, so I ran with 10 and was able to run a restart. You have to account for other files that may be bound to the PID instance, like logs and .jars since this is a bunch of java. And as everyone knows, Java is basically the pig of programming languages.</p>




<p>So 10 fds worked and activemq has restarted. Let&rsquo;s look at my logs to see what I&rsquo;ve got:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
</span><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 |     java.net.SocketException: Too many open files</span></code></pre></td></tr></table></div></figure>




<p>That isn&rsquo;t what I wanted to see. I am looking for heap memory errors. So this clearly demonstrates it&rsquo;s not an fds constraint at the filesystem level. Time to move on to other possibilities.</p>




<h3>Possible Culprits</h3>




<ol>
<li><p>The JVM</p>

<ul>
<li>Consider increasing the total heap memory available to the broker JVM</li>
<li>Consider reducing the default JVM stack size of each thread using -xss</li>
<li>If your broker is embedded ensure the hostiong JVM has appropriate heap and stack sizes.</li>
</ul>
</li>
<li><p>The broker</p>

<ul>
<li>Broker memory is not JVM memory, it&rsquo;s only a constraint - the broker manages it&rsquo;s own memory.</li>
<li>Setting appropriate systemUsage memory: <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage</a></li>
<li>Hard limits exist on the number of agents a single broker can handle due to file descriptors and other hard system resources</li>
</ul>
</li>
</ol>




<h3>Solutions</h3>




<p>Check your log for current JVM heap size:</p>




<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:04 |   Heap sizes: current=506816k  free=487246k  max=506816k
</code></pre>




<p>Try bumping this up to 1GB in</p>




<pre><code> /etc/puppetlabs/activemq/wrapper.conf
</code></pre>




<p>If you still get</p>




<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:38 | Exception in thread "ActiveMQBrokerService[ppm.prod.dc2.adpghs.com] Task-58" java.lang.OutOfMemoryError: unable to create new native thread 
</code></pre>




<p>in your</p>




<pre><code>/var/log/pe-activemq/wrapper.log
</code></pre>




<p>then throttle up your systemUsage in</p>




<pre><code>/etc/puppetlabs/activemq/activemq.xml
</code></pre>




<p>per <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">this guideline</a></p>




<h3>Hard Limits of AMQ</h3>




<p>If you still get OOM errors you may be at a hard limit for agents per broker. ActiveMQ uses the amqPersistenceAdapter by default for persistent messages. Unfortunately, this persistence adapter (as well as the kahaPersistenceAdapter) opens a file descriptor for each queue. When creating large numbers of queues, you&rsquo;ll quickly run into the limit for your OS.</p>




<p>However, your logs will not register a OOM error as above, they&rsquo;ll show</p>




<pre><code>ERROR  | wrapper  | 2014/03/13 03:32:39 | JVM exited while loading the application.
INFO   | jvm 4    | 2014/03/13 03:32:39 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
INFO   | jvm 4    | 2014/03/13 03:32:39 | java.net.SocketException: Too many open files
</code></pre>




<p>If that is your error your could try upping the limit on file descripters per process. You can do something similar to what I did above or <a href="http://tinyurl.com/o9qs2f">Google for your OS</a>.</p>




<p>At this point if none of the above resolved the issues you should try standing up a second broker, especially if you&rsquo;re running more than 1000 agents on a single broker instance.</p>




<p>You can read more about <a href="http://activemq.apache.org/networks-of-brokers.html">standing up networks of brokers</a> and also <a href="http://activemq.apache.org/performance.html">AMQ performance</a>.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-03-12T21:08:06-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:08 pm</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/01/17/extracting-json-from-puppet-yaml-report/">Extracting JSON From Puppet YAML Report</a></h2>
  
  <p>
    <h3>YAML -> JSON via Puppet Gen&#8217;ed YAML</h3>




<p>In a follow up to the post below, I started thinking about ways to generate a D3 readable JSON on the fly from the puppet generated YAML. I started by using a parser from the node library &lsquo;js-yaml&rsquo;. My YAML format looked like this:</p>




<figure class='code'><figcaption><span>last_puppet_run.yaml</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>  <span class="l-Scalar-Plain">metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">197</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">6</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed_to_restart</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restart&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">out_of_sync</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">sync&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>




<p>My original stab at parsing this YAML failed when using the js-yaml node library. This was due to the fact that this is Puppet YAML - it was generated by a ruby class denoted at the top of the file:</p>




<figure class='code'><figcaption><span>last_puppet_run.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="err">   </span><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span></code></pre></td></tr></table></div></figure>




<p>So the way to parse this file into a JSON would have to be done using a ruby script where I could import the &lsquo;puppet&rsquo; class directly so the YAML lib would know how to read this particular file. I thought this would be as simple as:</p>




<figure class='code'><figcaption><span>test.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;puppet&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">datajson</span> <span class="o">=</span> <span class="s1">&#39;report.json&#39;</span>
</span><span class='line'><span class="n">datafile</span>  <span class="o">=</span> <span class="s1">&#39;last_run_report.yaml&#39;</span>
</span><span class='line'><span class="n">yaml</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
</span><span class='line'><span class="n">json</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">datajson</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">json</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>What I didn&rsquo;t count on was serialization.</p>




<h3>Serialization</h3>




<p>What would you expect that output to be? I&rsquo;ll give you one clue, it did look like a JSON&hellip; sorta:</p>




<figure class='code'><figcaption><span>report.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;metrics&quot;</span><span class="p">:{</span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cda088&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cd80f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce1608&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;events&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce0eb0&gt;&quot;</span><span class="p">},</span><span class="nt">&quot;logs&quot;</span><span class="p">:[</span><span class="s2">&quot;Finished catalog run in 5.57 seconds&quot;</span><span class="p">],</span><span class="nt">&quot;resource_statuses&quot;</span><span class="p">:{</span><span class="nt">&quot;Schedule[daily]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ceaaf0&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[monthly]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ce84f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[hourly]&quot;</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>




<p>What&rsquo;s happening here? What happened to all our nice data, all of the sudden it&rsquo;s not human friendly anymore. This data is serialized, it&rsquo;s a by-product of using &lsquo;.to_json&rsquo; which is akin to saying &lsquo;JSON::dump(datafile)&rsquo;.</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-01-17T06:55:04-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:55 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/01/13/test/">Test</a></h2>
  
  <p>
    

  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-01-13T09:35:57-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:35 am</span></time>
    


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/01/03/the-need-to-a-replication-provider/">The Need for a Replication Provider</a></h2>
  
  <p>
    <h3>Why we need a replication provider for puppet</h3>




<p>I&rsquo;ve been using puppet for over a year now. I started using it at the request of a friend who wanted a simple, one-liner command to boot his e-commerce platform on Vagrant VM&rsquo;s for dev and eventually production. I was impressed by the simplicity, the software defined server-state was easy to create through the elegant package, resource, service workflow. It wasn&rsquo;t very long that we found other more advanced needs for Puppet.</p>




<p>One of these needs was booting multiple MySQL server slaves on a single host machine to replicate various MySQL masters. The masters were any one of the customers currently using this e-commerce platform. The distributed nature of the servers and the cost-benefit of running a single slave server (a beefy host nonetheless) for all of them presented a few challenges.</p>




<p>First off, nobody wants to be a sysadmin. This company was small in terms of manpower and everyone was already in a DevOps role, but who wants to sit around running &ldquo;CHANGE MASTER TO&rdquo;&hellip; all day? Not your python dev that&rsquo;s for sure. So we decided it was best to build out a Puppet module that can run on the slave and master hosts that would:</p>




<ol>
<li>Boot multiple MySQL slaves on one host</li>
<li>Dump the master MySQL DB and scp to the slave (once the slave was provisioned)</li>
<li>Import the scp&#8217;ed DB to the slave and start replication from the correct binlog position</li>
</ol>




<p>Simple right? Yeah&hellip; right.</p>




<p>Let&rsquo;s cut the chase: how many lines of puppet code did it take for me to write a unique mysql slave instance onto a host?</p>




<p>167</p>




<p>For each slave I needed to provision:</p>




<ul>
<li>/var/lib/mysql_instance#</li>
<li>/var/log/mysql_instance#</li>
<li>/etc/mysql_instance#</li>
<li>/etc/mysql_instance#/my.cnf</li>
<li>Customize that my.cnf for the instance</li>
</ul>




<p>Which looks like standard Puppet fun:</p>




<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># All SQL instances get their own directories:</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/var/lib/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/var/log/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># All SQL instances get their own /etc and cnf:</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/etc/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;my${slave_server_id}.cnf&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>         <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/etc/mysql${slave_server_id}/my${slave_server_id}.cnf&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">mode</span>        <span class="o">=&gt;</span> <span class="mo">0644</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>         <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>         <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">content</span>        <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;replicate/my.cnf.multi.erb&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s2">&quot;/etc/mysql${slave_server_id}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Then I needed to boot a DB with the datadir, and from that point on it was, well, you know, a bash script basically with a million exec statements:</p>




<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Prepare DB:</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s2">&quot;${name} Initialize Database&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s1">&#39;/usr/bin:/bin&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;mysql_install_db --user=mysql --datadir=/var/lib/mysql${slave_server_id}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="o">[</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;/var/lib/mysql${slave_server_id}&quot;</span><span class="o">]</span><span class="p">,</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;/var/log/mysql${slave_server_id}&quot;</span><span class="o">]]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Start SQL instance:</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} Spin up SQL Server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s1">&#39;/bin:/usr/bin:&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;mysqld_safe --defaults-file=/etc/mysql${slave_server_id}/my${slave_server_id}.cnf &amp;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;${name} Initialize Database&quot;</span><span class="o">]</span><span class="p">,</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;my${slave_server_id}.cnf&quot;</span><span class="o">]]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Execute CHANGE MASTER TO - TODO: add if conditional for with password mysql commands</span>
</span><span class='line'><span class="c1"># Grant slave user priviledges if without password:</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="vg">$mysql_root_password</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">{</span>
</span><span class='line'>      <span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} grant privledges&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;$mysql_replication_user&#39;@&#39;$slave_ip&#39; IDENTIFIED BY &#39;$mysql_replication_password&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="no">Require</span>                 <span class="o">=&gt;</span>  <span class="no">Exec</span> <span class="o">[</span> <span class="s2">&quot;$ {name} Spin up SQL server&quot;</span> <span class="o">]</span><span class="p">,</span><span class="n">ca</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;stop ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">STOP SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;grant ${name} privledges&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">CHANGE MASTER TO MASTER_HOST=&#39;$master_host&#39;,MASTER_USER=&#39;$mysql_replication_user&#39;,MASTER_PASSWORD=&#39;$mysql_replication_password&#39;,MASTER_LOG_FILE=&#39;$master_log_file&#39;,MASTER_LOG_POS=$master_log_pos;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;stop ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">START SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} restart server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>              <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock stop;</span>
</span><span class='line'><span class="s2">                                     /usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock start&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="n">notify</span>        <span class="o">=&gt;</span> <span class="ss">Replicate</span><span class="p">:</span><span class="ss">:Import</span><span class="o">[</span><span class="s2">&quot;Import ${import} onto ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>But WHAT IF THEY&rsquo;RE CRAZY AND HAVE NO PASSWORD????</p>




<p>I made other commands for that too&hellip;</p>




<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="vg">$mysql_root_password</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span><span class="p">{</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} grant privledges&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;$mysql_replication_user&#39;@&#39;$slave_ip&#39; IDENTIFIED BY &#39;$mysql_replication_password&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">Require</span>                 <span class="o">=&gt;</span>  <span class="no">Exec</span> <span class="o">[</span> <span class="s2">&quot;$ {name} Spin up SQL server&quot;</span> <span class="o">]</span><span class="p">,</span><span class="n">ca</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;stop ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">STOP SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;grant ${name} privledges&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">CHANGE MASTER TO MASTER_HOST=&#39;$master_host&#39;,MASTER_USER=&#39;$mysql_replication_user&#39;,MASTER_PASSWORD=&#39;$mysql_replication_password&#39;,MASTER_LOG_FILE=&#39;$master_log_file&#39;,MASTER_LOG_POS=$master_log_pos;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;stop ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">START SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} restart server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock stop;</span>
</span><span class='line'><span class="s2">                             /usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock start&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="n">notify</span>        <span class="o">=&gt;</span> <span class="ss">Replicate</span><span class="p">:</span><span class="ss">:Import</span><span class="o">[</span><span class="s2">&quot;Import ${import} onto ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>SO MANY COMMANDS!!!</p>




<p>Any post where you need to exclaim this much in caps says a lot about the code you&rsquo;re writing right? Right. That&rsquo;s a principle.</p>




<p>So this is where providers come in. In Puppet you could write this code to do this work. And I mean, that&rsquo;s what Puppet is for right? Provisioning. Yes,
that&rsquo;s true, but this isn&rsquo;t really* Puppet code, this is a bunch of exec statements, which is basically a bash script. This isn&rsquo;t very economical, it&rsquo;s
not very elegant, it&rsquo;s a lot of coding. Would it be nice if we could just:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">replicate_server</span> <span class="p">{</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">hostname</span>             <span class="o">=&gt;</span> <span class="vg">$:</span><span class="ss">:hostname</span><span class="p">,</span>
</span><span class='line'>  <span class="n">mysql_repl_password</span> <span class="o">=&gt;</span> <span class="s2">&quot;1234&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">mysql_repl_user</span>      <span class="o">=&gt;</span> <span class="s2">&quot;repl&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">server_id</span>            <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>&hellip; in our provisioning manifest and not have to write this crazy defined type for each SQL slave? Because right now as it stands my slave.pp for the replicate class is
167 lines. There are, umm, a lot of other subclasses there to enable this to work. Like the master.pp, my params, some crap about dumping DB&rsquo;s and blowing out
the old ib_log files and holy shit that&rsquo;s a lot of puppeteering.</p>




<p>I would much rather have a provider that&rsquo;s pure ruby which can provision this for me. (WARNING PSUDO PROVIDER COMING).</p>




<p>Something like this for the commands (of which, as you can see from above, are crazy nuts since it&rsquo;s puppet telling bash telling mysql telling mysql instance&hellip;):</p>




<figure class='code'><figcaption><span>/ modules / replicate / lib / puppet / provider / replicate / replication.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:replicate</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:replication</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">#confine :osfamily =&gt; [:debian, :redhat]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Commands </span>
</span><span class='line'>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:mysql</span>             <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysql&quot;</span>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:mysqladmin</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin&quot;</span>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:service</span>           <span class="o">=&gt;</span> <span class="s2">&quot;/etc/init.d/mysql&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Ahhhh, ok that&#8217; better than:</p>




<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$mysql_cmd_root_without_pwd</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_root_user --database=$mysql_database --host=$mysql_root_local_host&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_root_with_pwd</span>    <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_root_user --database=$mysql_database --host=$mysql_root_local_host --password=$mysql_root_password&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_repl_with_pwd</span>    <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_replication_user --database=$mysql_database --host=$mysql_root_local_host --password=$mysql_replication_password&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_repl_slave</span>       <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_replication_user --database=$mysql_database --host=$mysql_master_ip_address --password=$mysql_replication_password&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<p>Then we could write a out a single provider and corresponding type which defines the instance based on &ldquo;roles&rdquo; of &ldquo;master&rdquo; or &ldquo;slave&rdquo;. The provider would figure out if this host
already has a master or slave instance running on it, which my replication module &hellip; does not do .. which, you guessed it, could break a lot of stuff if you run it twice.</p>




<p>Which brings us to&hellip;</p>




<h4>A provider, when done correctly is idempotent!</h4>




<p>&hellip; and that&rsquo;s not all, if the replication provider is built-in we can use &lsquo;puppet resource replicate&rsquo; on the command line for all things replication related.</p>




<p>Let&rsquo;s say we wanted to query the master SQL instances
on this host, we could:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ puppet resource replicate role=master </span></code></pre></td></tr></table></div></figure>




<p>and get something like:</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>replicate {"master":
</span><span class='line'>  ensure =&gt; present,
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>




<p>if this host has a master instance running on it.</p>




<p>This is of course provided by the magic of self.instances in the provider. Here&rsquo;s some more psudo ruby of what that might look like:</p>




<figure class='code'><figcaption><span>Psudo-Provider </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>  <span class="n">get_master_instances</span><span class="p">()</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_master_instances</span><span class="p">()</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;get master info&quot;</span>
</span><span class='line'>  <span class="n">mstr_info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>          <span class="n">output</span> <span class="o">=</span> <span class="sb">`mysql -NBe &quot;show master status&quot;`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>              <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Oh no, execution of &#39;show master status&#39; for MySQL failed&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span> <span class="o">==</span> <span class="kp">nil</span> <span class="p">?</span> <span class="ss">:absent</span> <span class="p">:</span> <span class="ss">:present</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:log_position</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">output</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:binlog_do_db</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">output</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>  <span class="c1">#mstr_info[:provider] = :ruby</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:binlog_do_db</span>
</span><span class='line'>  <span class="n">mstr_info</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<p>And return the instances.</p>




<p>Now the provider would have to be written with the duel nature of master/slave replication in mind. Unless you want to have multiple providers, one for each of the roles of master or slave.
However I think it would be easier to write it into a single provider that discriminates based on the &lsquo;role&rsquo; parameter in the type.</p>




<p>But I digress, let&rsquo;s get back to the meat of this thing.</p>




<p>The awesome thing about having a provider do this work for us is that we don&rsquo;t have to worry about all the module-related debugging, platform dependancies and none-idempotent nature of a standalone replication
module (*cough .. my replication module, which I did not write with idempotentcy in mind). We have better integration with puppet through the use of &lsquo;puppet resource&rsquo; - it inherently is far more extendable than a standalone module  and integrates well with most puppet platform distributions.
The coding for it is far more economical, and we don&rsquo;t have a psudo-bash script written into our Puppet code via exec!</p>




<p>You get to write your puppet code to do puppet stuff and let the provider/type ruby magic do it&rsquo;s work for you. It&rsquo;s a win win, now all we need to do is actually write this thing&hellip;</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-01-03T09:05:51-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:05 am</span></time>
    

<span class="categories">
  
    <a class='category' href='//providers/'>providers</a>, <a class='category' href='//puppet/'>puppet</a>, <a class='category' href='//ruby/'>ruby</a>
  
</span>


  </span>

  
</article>

        </div>
      </div>
      
      
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <article>
  <h2><a href="/blog/2014/01/02/blog-post-number-1/">Blog Post #1</a></h2>
  
  <p>
    <p>Is this thing on?</p>


  </p>
  <span class="meta">
    written 




<time class='entry-date' datetime='2014-01-02T10:52:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>10:52 am</span></time>
    

<span class="categories">
  
    <a class='category' href='//misc/'>misc</a>
  
</span>


  </span>

  
</article>

        </div>
      </div>
      
    </div>
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jeff Malnick -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
